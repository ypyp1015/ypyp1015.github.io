<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>é ç«¯é™æ§ LED è·‘é¦¬ç‡ˆ v24.1.1 (é€²éšç‰ˆ)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<!-- å¼•å…¥æ‰€æœ‰éœ€è¦çš„å­—é«” -->
<link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Noto+Serif+TC:wght@400;700&family=ZCOOL+KuaiLe&family=Cutive+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
  html, body { height:100%; margin:0; padding:0; background:#0f172a; }
  body { font-family:'Inter','å¾®è»Ÿæ­£é»‘é«”',sans-serif; overscroll-behavior:none; }
  .led-font { font-family:'DotGothic16',sans-serif; }

  @keyframes marquee-left { from{ transform:translateX(100vw);} to{ transform:translateX(-100%);} }
  @keyframes marquee-right{ from{ transform:translateX(-100%);} to{ transform:translateX(100vw);} }
  @keyframes eye-blink-anim { 0%,40%,100%{ transform:scaleY(1);} 42%{ transform:scaleY(0.1);} }
  @keyframes eye-move-anim { 0%,20%{ transform:translateX(0);} 30%,50%{ transform:translateX(-10px);} 60%,80%{ transform:translateX(10px);} 90%,100%{ transform:translateX(0);} }
  @keyframes rainbow-border-anim { 0%{background-position:0% 50%;} 50%{background-position:100% 50%;} 100%{background-position:0% 50%;} }
  
  /* æ–‡å­—å‹•ç•« Keyframes */
  @keyframes rainbow-text-anim { 0%{background-position:0% 50%;} 50%{background-position:100% 50%;} 100%{background-position:0% 50%;} }
  @keyframes blink-effect { 50%{ opacity:0; } }
  @keyframes wave-anim { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
  @keyframes jump-anim { 0%, 100% { transform: translateY(0) rotate(0); } 25% { transform: translateY(-20px) rotate(-5deg); } 75% { transform: translateY(-20px) rotate(5deg); } }
  @keyframes heartbeat-anim { from { transform: scale(1); } 50% { transform: scale(1.15); } to { transform: scale(1); } }
  @keyframes shake-anim { 0% { transform: translate(0, 0) rotate(0deg); } 25% { transform: translate(2px, -2px) rotate(0.5deg); } 50% { transform: translate(-2px, 2px) rotate(-0.5deg); } 75% { transform: translate(2px, 2px) rotate(0.5deg); } 100% { transform: translate(0, 0) rotate(0deg); } }

  .marquee-text{
    font-size:var(--font-size,80px);
    color:var(--text-color,#FFFFFF);
    white-space:nowrap;
    display:inline-block;
    line-height:1.1;
    position:relative;
    z-index:1;
    transition: color .2s, background-color .2s, text-shadow .2s;
  }
  .gradient-text{
    background-clip:text; -webkit-background-clip:text;
    color:transparent !important; -webkit-text-fill-color:transparent;
  }
  .text-style-glow{ text-shadow:0 0 8px var(--text-color,#fff), 0 0 12px var(--text-color,#fff); }
  .text-style-outline{
    -webkit-text-stroke: 1.5px var(--outline-color);
    -webkit-text-fill-color: transparent;
    paint-order: stroke fill;
    text-shadow: none !important;
  }
  /* ç§»é™¤èˆŠçš„é»ç‹€ CSSï¼Œæ”¹ç”¨ Canvas */

  .text-anim-rainbow { background-image: linear-gradient(90deg, #ff004e, #ffe848, #00ffef, #0047ff, #ff004e); background-size: 200% 200%; animation: rainbow-text-anim 3s linear infinite; }
  .text-anim-blink { animation: blink-effect 1s step-end infinite; }
  
  .display-screen{
    width:100%; height:100%; position:relative;
    background:var(--bg-color,#000); box-sizing:border-box;
    isolation: isolate;
    overflow: hidden; /* ç¢ºä¿ canvas å…§å®¹ä¸è¶…å‡º */
  }
  /* æ–°å¢ Dot Matrix Canvas æ¨£å¼ */
  .dot-matrix-canvas {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 2;
  }

  .marquee-container-wrapper{ position:absolute; top:50%; left:0; width:100%; transform:translateY(-50%); overflow:hidden; z-index:2; }

  .grid-bg{
    position:absolute; inset:0; z-index:1; pointer-events:none;
    background: var(--grid-color);
    mask-image: var(--grid-mask-image); -webkit-mask-image: var(--grid-mask-image);
    mask-size: var(--grid-size) var(--grid-size); -webkit-mask-size: var(--grid-size) var(--grid-size);
    mask-position: left top; -webkit-mask-position: left top;
    mask-repeat: repeat; -webkit-mask-repeat: repeat;
    border-radius: var(--inner-border-radius, 0px);
  }

  .gap-overlay{
    position:absolute; inset:0; z-index:3; pointer-events:none;
    background: var(--gap-color,#000); opacity: var(--gap-alpha,1);
    mask-image: var(--gap-mask-image); -webkit-mask-image: var(--gap-mask-image);
    mask-size: var(--grid-size) var(--grid-size); -webkit-mask-size: var(--grid-size) var(--grid-size);
    mask-position: left top; -webkit-mask-position: left top;
    mask-repeat: repeat; -webkit-mask-repeat: repeat;
    display:none;
    border-radius: var(--inner-border-radius, 0px);
  }

  .border-style-solid {
    border-style: solid;
    border-color: white;
    border-width: var(--border-width, 8px);
    border-radius: var(--border-radius, 16px);
  }
  .border-style-rainbow {
    position: relative;
    border-radius: var(--border-radius, 16px);
    animation: rainbow-border-anim 3s linear infinite;
    background-size: 200% 200%;
  }
  .border-style-rainbow::after {
    content: '';
    position: absolute;
    inset: var(--border-width, 8px);
    background: var(--bg-color);
    border-radius: var(--inner-border-radius, 8px);
    z-index: 0;
  }


  #background-effects-container{ position:absolute; inset:0; display:flex; justify-content:center; align-items:center; gap:20px; pointer-events:none; z-index:1; }
  .eye{ width:80px; height:80px; background:#fff; border-radius:50%; position:relative; animation:eye-blink-anim 5s infinite; overflow:hidden; }
  .pupil{ width:40px; height:40px; background:#222; border-radius:50%; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); animation: eye-move-anim 10s infinite; }

  .sticky-preview{ position:sticky; top:0; z-index:10; background:#1e293b; padding:1.5rem; margin-left:-1.5rem; margin-right:-1.5rem; }
  .controller-preview{ 
    height:120px; 
    position:relative; 
    background:var(--bg-color,#000); 
    outline:1px solid #374151; 
    box-sizing:border-box; 
    isolation: isolate;
    overflow: hidden;
  }
  .controller-preview .marquee-text{ font-size:var(--font-size,40px) !important; }

  .no-scrollbar::-webkit-scrollbar{ display:none; }
  .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
  .control-btn-active{ box-shadow:0 0 0 3px #4f46e5; }
  .control-disabled{ opacity:.4; pointer-events:none; cursor:not-allowed; }
  
  .char-btn {
    transition: all 0.2s;
    border: 2px solid transparent;
  }
  .char-btn-active {
    border-color: #6366f1; /* Indigo */
    transform: scale(1.1);
    background-color: #4f46e5 !important;
    color: white !important;
  }
</style>
</head>
<body class="text-white">
<div id="app-container" class="h-full w-full">
  <!-- é¦–é  -->
  <div id="home-view" class="flex flex-col items-center justify-center h-full p-8 text-center bg-gray-900">
    <h1 class="text-5xl font-bold mb-4 led-font">LED Scroller</h1>
    <p class="text-gray-400 mb-12">æ•¸ä½è·‘é¦¬ç‡ˆãƒ»é ç«¯é™æ§</p>
    <div class="space-y-4 w-full max-w-xs">
      <button id="create-display-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">å»ºç«‹æ–°çš„é¡¯ç¤ºé¢æ¿</button>
      <p class="text-gray-500">æˆ–</p>
      <div class="relative">
        <input type="text" id="session-id-input" placeholder="è¼¸å…¥é¢æ¿ ID é€²å…¥æ§åˆ¶å°" class="w-full bg-gray-800 border border-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <button id="open-controller-btn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-3 rounded-md">é€²å…¥</button>
      </div>
    </div>
    <p class="text-gray-600 mt-12 text-sm">æç¤ºï¼šåœ¨è¨­å‚™ A å»ºç«‹é¡¯ç¤ºé¢æ¿ï¼Œ<br>ç„¶å¾Œåœ¨è¨­å‚™ B è¼¸å…¥é¢æ¿ ID é€²è¡Œé™æ§ã€‚</p>
  </div>

  <!-- é¡¯ç¤ºé¢æ¿ -->
  <div id="display-view" class="hidden h-full w-full">
    <div class="display-screen" id="display-screen">
      <div class="grid-bg"></div>
      <div id="background-effects-container"></div>
      <div class="marquee-container-wrapper" id="marquee-container-wrapper">
        <div class="marquee-text" id="marquee-text"><span>è«‹ç¨å€™...</span></div>
      </div>
      <canvas id="display-canvas" class="dot-matrix-canvas" style="display: none;"></canvas>
      <div class="gap-overlay" id="gap-overlay"></div>
    </div>
    <div id="info-overlay" class="absolute top-4 left-4 bg-black bg-opacity-70 p-4 rounded-lg text-white transition-opacity duration-500">
      <p class="text-sm">è¼•è§¸è¢å¹•å¯éš±è—/é¡¯ç¤ºæ­¤è³‡è¨Š</p>
      <p id="session-id-display" class="font-mono text-lg my-2 bg-gray-700 px-2 py-1 rounded"></p>
      <div id="qrcode-container" class="p-2 bg-white rounded-md mt-2"></div>
    </div>
    <button id="fullscreen-btn" class="absolute bottom-4 right-4 text-white bg-black bg-opacity-50 p-3 rounded-full hover:bg-opacity-75 transition" aria-label="fullscreen">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
    </button>
  </div>

  <!-- æ§åˆ¶å° -->
  <div id="controller-view" class="hidden h-full w-full bg-gray-800 overflow-y-auto no-scrollbar">
    <div class="p-6 max-w-md mx-auto">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold led-font">æ§åˆ¶å°</h2>
        <p class="text-sm text-gray-400 font-mono">ID: <span id="controller-session-id"></span></p>
      </div>

      <div class="sticky-preview">
        <label class="block mb-2 text-sm font-medium text-gray-300">æ•ˆæœé è¦½</label>
        <div class="controller-preview" id="controller-preview">
          <div class="grid-bg"></div>
          <div class="marquee-container-wrapper" id="preview-marquee-container-wrapper">
            <div class="marquee-text" id="preview-marquee-text"></div>
          </div>
          <canvas id="preview-canvas" class="dot-matrix-canvas" style="display: none;"></canvas>
          <div class="gap-overlay"></div>
        </div>
      </div>

      <div class="mb-6 mt-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">é¡¯ç¤ºæ–‡å­—</label>
        <textarea id="text-input" rows="3" class="w-full bg-gray-700 border border-gray-600 text-white text-lg p-2.5 rounded-lg" placeholder="åœ¨æ­¤è¼¸å…¥æ–‡å­—..."></textarea>
      </div>
      
      <div class="mb-6 p-4 bg-gray-900/50 rounded-lg">
        <div class="flex items-center justify-between mb-4">
            <label class="block text-sm font-medium text-gray-300">é€²éšæ–‡å­—æ•ˆæœ (å€‹åˆ¥ä¸Šè‰²/å‹•ç•«)</label>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="advanced-text-toggle" class="sr-only peer">
              <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
            </label>
        </div>
        <div id="advanced-text-wrapper" class="hidden space-y-4">
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-400">1. é»é¸ä¸‹æ–¹æ–‡å­—ä»¥é¸å–</label>
            <div id="char-selector" class="flex flex-wrap gap-2 p-2 bg-gray-700 rounded-md min-h-[44px] items-center"></div>
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-400">2. ç‚ºé¸å–çš„æ–‡å­—ä¸Šè‰²</label>
            <div class="flex flex-wrap gap-3" id="char-color-picker"></div>
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-400">3. ç‚ºé¸å–çš„æ–‡å­—åŠ å…¥å‹•ç•«</label>
            <div class="grid grid-cols-4 gap-2" id="char-animation-picker">
              <button data-char-animation="none" class="char-animation-btn p-2 bg-gray-600 rounded-lg text-xs">ç„¡</button>
              <button data-char-animation="wave" class="char-animation-btn p-2 bg-gray-600 rounded-lg text-xs">æ³¢æµª</button>
              <button data-char-animation="jump" class="char-animation-btn p-2 bg-gray-600 rounded-lg text-xs">è·³èº</button>
              <button data-char-animation="heartbeat" class="char-animation-btn p-2 bg-gray-600 rounded-lg text-xs">å¿ƒè·³</button>
              <button data-char-animation="shake" class="char-animation-btn p-2 bg-gray-600 rounded-lg text-xs">æ–æ™ƒ</button>
            </div>
          </div>
        </div>
      </div>

      <div class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">å­—é«”é¸æ“‡</label>
        <div class="grid grid-cols-3 gap-3">
            <button data-font="'Inter','å¾®è»Ÿæ­£é»‘é«”',sans-serif" class="font-btn p-3 bg-indigo-600 rounded-lg text-sm">æ¨™æº–é«”</button>
            <button data-font="'DotGothic16', sans-serif" class="font-btn p-3 bg-gray-700 rounded-lg text-sm">é»é™£é«”</button>
            <button data-font="'Noto Serif TC', serif" class="font-btn p-3 bg-gray-700 rounded-lg text-sm">å®‹é«”</button>
            <button data-font="'ZCOOL KuaiLe', cursive" class="font-btn p-3 bg-gray-700 rounded-lg text-sm">å¿«æ¨‚é«”</button>
            <button data-font="'Cutive Mono', monospace" class="font-btn p-3 bg-gray-700 rounded-lg text-sm">ç­‰å¯¬é«”</button>
        </div>
      </div>

      <div class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">å­—é«”æ¨¡å¼</label>
        <div class="grid grid-cols-2 gap-3">
          <button data-mode="fixed" class="font-mode-btn p-3 bg-gray-700 rounded-lg text-sm">å›ºå®šå¤§å°</button>
          <button data-mode="fitHeight" class="font-mode-btn p-3 bg-indigo-600 rounded-lg text-sm">å¡«æ»¿é«˜åº¦</button>
          <button data-mode="fitWidth" class="font-mode-btn p-3 bg-gray-700 rounded-lg text-sm">å¡«æ»¿å¯¬åº¦</button>
          <button data-mode="multiline" class="font-mode-btn p-3 bg-gray-700 rounded-lg text-sm">è‡ªå‹•æ›è¡Œ</button>
        </div>
      </div>

      <div id="font-size-controls" class="mb-6">
        <label id="font-size-label" for="font-size-slider" class="block mb-2 text-sm font-medium text-gray-300">é«˜åº¦ä½”æ¯”: <span id="font-size-value">95</span>%</label>
        <input id="font-size-slider" type="range" min="10" max="100" value="95" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
      </div>

      <div class="mb-6">
        <label for="speed-slider" class="block mb-2 text-sm font-medium text-gray-300">æ»¾å‹•é€Ÿåº¦: <span id="speed-value">10</span>s</label>
        <input id="speed-slider" type="range" min="1" max="60" value="10" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
      </div>
      <div class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">æ»¾å‹•æ–¹å‘</label>
        <div class="grid grid-cols-3 gap-3">
          <button data-direction="marquee-left" class="direction-btn p-3 bg-gray-700 rounded-lg">â† å‘å·¦</button>
          <button data-direction="none" class="direction-btn p-3 bg-indigo-600 rounded-lg">âšâš éœæ­¢</button>
          <button data-direction="marquee-right" class="direction-btn p-3 bg-gray-700 rounded-lg">å‘å³ â†’</button>
        </div>
      </div>

      <div id="global-color-wrapper" class="mb-6 p-4 bg-gray-900 rounded-lg">
        <div class="flex border-b border-gray-700 mb-4">
          <div id="color-tab" class="flex -mb-px">
            <button data-tab="solid" class="tab-btn text-white py-2 px-4 border-b-2 border-indigo-500 font-medium">ç´”è‰²</button>
            <button data-tab="gradient" class="tab-btn text-gray-400 py-2 px-4 border-b-2 border-transparent">æ¼¸å±¤</button>
          </div>
        </div>
        <div id="solid-color-panel">
          <label class="block mb-2 text-sm font-medium text-gray-300">æ–‡å­—é¡è‰²</label>
          <div class="flex flex-wrap gap-3 mb-4" id="text-color-picker"></div>
          <label class="block mb-2 text-sm font-medium text-gray-300">èƒŒæ™¯é¡è‰²</label>
          <div class="flex flex-wrap gap-3" id="bg-color-picker"></div>
        </div>
        <div id="gradient-color-panel" class="hidden">
          <label class="block mb-2 text-sm font-medium text-gray-300">æ–‡å­—æ¼¸å±¤</label>
          <div class="flex flex-wrap gap-2 mb-4" id="text-gradient-picker"></div>
          <label class="block mb-2 text-sm font-medium text-gray-300">èƒŒæ™¯æ¼¸å±¤</label>
          <div class="flex flex-wrap gap-2" id="bg-gradient-picker"></div>
        </div>
      </div>

      <div class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">èƒŒæ™¯ç¶²æ ¼</label>
        <div class="flex flex-wrap gap-3">
          <button data-grid="none" class="grid-style-btn p-3 bg-indigo-600 rounded-lg text-sm">ç„¡</button>
          <button data-grid="dot" class="grid-style-btn p-3 bg-gray-700 rounded-lg text-sm">âš«ï¸ é»ç‹€</button>
          <button data-grid="square" class="grid-style-btn p-3 bg-gray-700 rounded-lg text-sm">â¬›ï¸ æ–¹å½¢</button>
          <button data-grid="diamond" class="grid-style-btn p-3 bg-gray-700 rounded-lg text-sm">â™¦ï¸ è±å½¢</button>
        </div>
      </div>

      <div id="grid-advanced-section" class="mb-6 space-y-6 hidden">
        <div>
          <label for="grid-size-slider" class="block mb-2 text-sm font-medium text-gray-300">ç¶²æ ¼å¤§å°: <span id="grid-size-value">20</span>px</label>
          <input id="grid-size-slider" type="range" min="4" max="120" value="20" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
        </div>
        <div class="p-4 bg-gray-900 rounded-lg">
          <div class="flex border-b border-gray-700 mb-4">
            <div id="grid-color-tab" class="flex -mb-px">
              <button data-tab="solid" class="grid-tab-btn text-white py-2 px-4 border-b-2 border-indigo-500 font-medium">ç´”è‰²</button>
              <button data-tab="gradient" class="grid-tab-btn text-gray-400 py-2 px-4 border-b-2 border-transparent">æ¼¸å±¤</button>
            </div>
          </div>
          <div id="grid-solid-color-panel">
            <label class="block mb-2 text-sm font-medium text-gray-300">ç¶²æ ¼é¡è‰²</label>
            <div class="flex flex-wrap gap-3" id="grid-color-picker"></div>
          </div>
          <div id="grid-gradient-color-panel" class="hidden">
            <label class="block mb-2 text-sm font-medium text-gray-300">ç¶²æ ¼æ¼¸å±¤</label>
            <div class="flex flex-wrap gap-2" id="grid-gradient-picker"></div>
          </div>
        </div>
        <div class="p-4 bg-gray-900 rounded-lg">
          <label class="block mb-2 text-sm font-medium text-gray-300">LEDç©¿å­”</label>
          <div class="flex flex-wrap gap-3">
            <button data-blend="normal" class="blend-mode-btn p-3 bg-indigo-600 rounded-lg text-sm">é—œé–‰</button>
            <button data-blend="multiply" class="blend-mode-btn p-3 bg-gray-700 rounded-lg text-sm">é–‹å•Ÿ</button>
          </div>
          <div id="gap-controls" class="mt-4 hidden">
            <label class="block mb-2 text-sm font-medium text-gray-300">éš™ç¸«é¡è‰²</label>
            <div class="flex flex-wrap gap-3" id="gap-color-picker"></div>
            <div class="mt-4">
              <label for="gap-alpha-slider" class="block mb-2 text-sm font-medium text-gray-300">éš™ç¸«ä¸é€æ˜åº¦: <span id="gap-alpha-value">1.00</span></label>
              <input id="gap-alpha-slider" type="range" min="0.10" max="1.00" step="0.05" value="1.00" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
            </div>
          </div>
        </div>
      </div>

      <div id="text-style-wrapper" class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">æ–‡å­—é¢¨æ ¼</label>
        <div class="flex flex-wrap gap-3">
          <button data-style="normal" class="text-style-btn p-3 bg-indigo-600 rounded-lg text-sm">æ¨™æº–</button>
          <button data-style="glow" class="text-style-btn p-3 bg-gray-700 rounded-lg text-sm">âœ¨ ç™¼å…‰</button>
          <button data-style="outline" class="text-style-btn p-3 bg-gray-700 rounded-lg text-sm">âœï¸ é‚Šæ¡†</button>
          <button data-style="dot-matrix" class="text-style-btn p-3 bg-gray-700 rounded-lg text-sm">ğŸ’¡ é»é™£åœ–</button>
        </div>
      </div>
      <div id="outline-color-section" class="mb-6 hidden">
        <label class="block mb-2 text-sm font-medium text-gray-300">é‚Šæ¡†é¡è‰²</label>
        <div class="flex flex-wrap gap-3" id="outline-color-picker"></div>
      </div>
      
      <div id="text-animation-wrapper" class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">æ–‡å­—å‹•ç•« (æ•´é«”)</label>
        <div class="grid grid-cols-3 gap-3">
          <button data-animation="none" class="text-animation-btn p-3 bg-indigo-600 rounded-lg text-sm">ç„¡</button>
          <button data-animation="blink" class="text-animation-btn p-3 bg-gray-700 rounded-lg text-sm">é–ƒçˆ</button>
          <button data-animation="rainbow" class="text-animation-btn p-3 bg-gray-700 rounded-lg text-sm">ğŸŒˆ å½©è™¹</button>
          <button data-animation="wave" class="text-animation-btn p-3 bg-gray-700 rounded-lg text-sm">ğŸŒŠ æ³¢æµª</button>
          <button data-animation="jump" class="text-animation-btn p-3 bg-gray-700 rounded-lg text-sm">ğŸ¤¸ è·³èº</button>
          <button data-animation="heartbeat" class="text-animation-btn p-3 bg-gray-700 rounded-lg text-sm">â¤ï¸ å¿ƒè·³</button>
          <button data-animation="shake" class="text-animation-btn p-3 bg-gray-700 rounded-lg text-sm">ğŸŒ€ æ–æ™ƒ</button>
        </div>
      </div>

      <div id="border-style-wrapper" class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">èƒŒæ™¯é‚Šæ¡†</label>
        <div class="flex flex-wrap gap-3">
          <button data-border="none" class="border-style-btn p-3 bg-indigo-600 rounded-lg text-sm">ç„¡</button>
          <button data-border="solid" class="border-style-btn p-3 bg-gray-700 rounded-lg text-sm">â¬œï¸ å¯¦ç·š</button>
          <button data-border="rainbow" class="border-style-btn p-3 bg-gray-700 rounded-lg text-sm">ğŸŒˆ å½©è™¹é‚Šæ¡†</button>
        </div>
      </div>
      
      <div id="border-controls-section" class="mb-6 space-y-6 hidden">
        <div>
            <label for="border-width-slider" class="block mb-2 text-sm font-medium text-gray-300">é‚Šæ¡†å¯¬åº¦: <span id="border-width-value">8</span>px</label>
            <input id="border-width-slider" type="range" min="0" max="50" value="8" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
        </div>
        <div>
            <label for="border-radius-slider" class="block mb-2 text-sm font-medium text-gray-300">é‚Šæ¡†åœ“è§’: <span id="border-radius-value">16</span>px</label>
            <input id="border-radius-slider" type="range" min="0" max="100" value="16" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
        </div>
      </div>

      <div id="bg-effect-wrapper" class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">èƒŒæ™¯å‹•ç•«</label>
        <div class="flex flex-wrap gap-3">
          <button data-effect="none" class="bg-effect-btn p-3 bg-indigo-600 rounded-lg text-sm">ç„¡</button>
          <button data-effect="eyes" class="bg-effect-btn p-3 bg-gray-700 rounded-lg text-sm">ğŸ‘€ çœ¼ç›</button>
        </div>
      </div>

      <div class="mt-8 mb-4">
        <a href="#" onclick="window.location.search=''; return false;" class="w-full text-center block bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg">è¿”å›é¦–é </a>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDiXuuIQB9EJQZtW8zYuTByxr-Y5wMpRdc",
    authDomain: "led-run-c168b.firebaseapp.com",
    projectId: "led-run-c168b",
    storageBucket: "led-run-c168b.appspot.com",
    messagingSenderId: "555557259748",
    appId: "1:555557259748:web:7a79d35743bcbadbf11ff1",
    measurementId: "G-7JH5TLX99R"
  };

  let db;
  try { db = getFirestore(initializeApp(firebaseConfig)); } catch(e){ console.error("Firebase åˆå§‹åŒ–å¤±æ•—", e); alert("Firebase é€£ç·šå¤±æ•—ï¼"); }

  const homeView = document.getElementById('home-view'),
        displayView = document.getElementById('display-view'),
        controllerView = document.getElementById('controller-view');

  let currentSessionId = null, unsubscribe = null;
  const controllerState = { textColorMode:'solid', bgColorMode:'solid', gridColorMode:'solid', charColors: [], charAnimations: [] };
  let gridSizeState = 20;
  let selectedCharIndices = new Set();
  let animationFrameId = null; // For canvas animation

  const solid16 = ['#FFFFFF','#000000','#1F2937','#EF4444','#F59E0B','#10B981','#3B82F6','#8B5CF6','#EC4899','#14B8A6','#22D3EE','#A3E635','#F97316','#84CC16'];
  const bgSolid16 = ['#000000','#0B1220','#111827','#1F2937','#374151','#4B5563','#6B7280','#9CA3AF','#EF4444','#F59E0B','#10B981','#3B82F6','#8B5CF6','#EC4899','#14B8A6','#F3F4F6'];
  const gridSolid16 = ['#374151', '#6B7280', '#9CA3AF', '#000000','#F59E0B','#EAB308','#10B981','#22C55E','#3B82F6','#6366F1','#A855F7','#EC4899','#EF4444','#9333EA','#22D3EE','#A3E635'];
  const gapSolid16 = ['#000000','#0B1220','#111827','#1F2937','#374151','#6B7280','#9CA3AF','#FFFFFF','#FFB703','#F59E0B','#22C55E','#3B82F6','#8B5CF6','#EC4899','#22D3EE','#A3E635'];

  const gradients16 = [ 'linear-gradient(90deg,#F37335,#FDC830)','linear-gradient(90deg,#2193b0,#6dd5ed)', 'linear-gradient(90deg,#56ab2f,#a8e063)','linear-gradient(90deg,#e94057,#f27121)', 'linear-gradient(90deg,#4776E6,#8E54E9)','linear-gradient(90deg,#ff9966,#ff5e62)', 'linear-gradient(90deg,#00b09b,#96c93d)','linear-gradient(90deg,#f953c6,#b91d73)', 'linear-gradient(90deg,#00c6ff,#0072ff)','linear-gradient(90deg,#43cea2,#185a9d)', 'linear-gradient(90deg,#ff7e5f,#feb47b)','linear-gradient(90deg,#36d1dc,#5b86e5)', 'linear-gradient(90deg,#c471f5,#fa71cd)','linear-gradient(90deg,#f00000,#dc281e)', 'linear-gradient(90deg,#bdc3c7,#2c3e50)','linear-gradient(90deg,red,orange,yellow,green,blue,indigo,violet)' ];
  const bgGradients16 = [ 'linear-gradient(90deg,#0f2027,#203a43,#2c5364)','linear-gradient(90deg,#111827,#000000)', 'linear-gradient(90deg,#141E30,#243B55)','linear-gradient(90deg,#1e3c72,#2a5298)', 'linear-gradient(90deg,#4b6cb7,#182848)','linear-gradient(90deg,#000428,#004e92)', 'linear-gradient(90deg,#3E5151,#DECBA4)','linear-gradient(90deg,#232526,#414345)', 'linear-gradient(90deg,#5614B0,#DBD65C)','linear-gradient(90deg,#1f4037,#99f2c8)', 'linear-gradient(90deg,#136a8a,#267871)','linear-gradient(90deg,#373B44,#4286f4)', 'linear-gradient(90deg,#485563,#29323c)','linear-gradient(90deg,#2C3E50,#4CA1AF)', 'linear-gradient(90deg,#41295a,#2F0743)','linear-gradient(90deg,#000000,#434343)' ];
  const gridGradients16 = [ 'linear-gradient(90deg,#F8D24E,#FFD84A)','linear-gradient(90deg,#ffd166,#fca311)', 'linear-gradient(90deg,#f6d365,#fda085)','linear-gradient(90deg,#a1ffce,#faffd1)', 'linear-gradient(90deg,#d4fc79,#96e6a1)','linear-gradient(90deg,#fbd3e9,#bb377d)', 'linear-gradient(90deg,#84fab0,#8fd3f4)','linear-gradient(90deg,#a18cd1,#fbc2eb)', 'linear-gradient(90deg,#f093fb,#f5576c)','linear-gradient(90deg,#4facfe,#00f2fe)', 'linear-gradient(90deg,#fad0c4,#ffd1ff)','linear-gradient(90deg,#ffecd2,#fcb69f)', 'linear-gradient(90deg,#cfd9df,#e2ebf0)','linear-gradient(90deg,#fddb92,#d1fdff)', 'linear-gradient(90deg,#fbc2eb,#a6c1ee)','linear-gradient(90deg,#7F7FD5,#86A8E7)' ];

  const defaultSettings = { text: "Hello ğŸ‘‹", textColor: "#FFFFFF", backgroundColor: "#000000", fontSize: 95, fontSizeMode: 'fitHeight', scrollSpeed: 10, scrollDirection: "none", textColorMode: 'solid', bgColorMode: 'solid', gridColorMode: 'solid', gradientText: gradients16[0], gradientBg: bgGradients16[0], gradientGrid: gridGradients16[0], textBlendMode: 'normal', gapColor: "#000000", gapAlpha: 1.0, backgroundBorder: "none", backgroundEffect: "none", gridStyle: "none", gridSize: 20, gridColor: "#374151", textStyle: "normal", outlineColor: "#FF3B30", borderWidth: 8, borderRadius: 16, fontFamily: "'Inter','å¾®è»Ÿæ­£é»‘é«”',sans-serif", isAdvancedText: false, charColors: [], charAnimations: [], textAnimation: 'none', updatedAt: serverTimestamp() };

  window.addEventListener('load', ()=>{
    const params = new URLSearchParams(window.location.search);
    if (params.has('display')) startDisplayMode(params.get('display'));
    else if (params.has('controller')) startControllerMode(params.get('controller'));
    else showView('home');
  });

  function showView(name){ [homeView, displayView, controllerView].forEach(v=>v.classList.add('hidden')); document.getElementById(`${name}-view`).classList.remove('hidden'); }
  function generateId(){ return Math.random().toString(36).substring(2,8).toUpperCase(); }

  function gridMaskSVG(shape){ if (shape==='square') return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='6' y='6' width='88' height='88' rx='12' ry='12' fill='black'/></svg>`; if (shape==='diamond') return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='16' y='16' width='68' height='68' transform='rotate(45 50 50)' fill='black'/></svg>`; return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='48' fill='black'/></svg>`; }
  function gapMaskSVG(shape){ if (shape==='square') return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='white' fill-rule='evenodd' d='M0 0H100V100H0Z M6 6H94V94H6Z'/></svg>`; if (shape==='diamond') return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='white' fill-rule='evenodd' d='M0 0H100V100H0Z M50 7L93 50 50 93 7 50Z'/></svg>`; return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='white' fill-rule='evenodd' d='M0 0H100V100H0Z M50 50 m -48,0 a 48,48 0 1,0 96,0 a 48,48 0 1,0 -96,0 Z'/></svg>`; }

  function applySettings(els, settings, isPreview = false) {
    const { textEl, containerEl, wrapperEl, bgEffectEl, canvasEl } = els;
    if (!containerEl) return;
    
    // æ¸…ç†èˆŠç‹€æ…‹
    if (animationFrameId) cancelAnimationFrame(animationFrameId);
    animationFrameId = null;
    
    // åŸºæœ¬æ¨£å¼è¨­å®š
    const root = containerEl;
    const borderWidth = parseInt(settings.borderWidth, 10) || 0;
    const borderRadius = parseInt(settings.borderRadius, 10) || 0;
    let innerRadius = (settings.backgroundBorder !== 'none') ? Math.max(0, borderRadius - borderWidth) : 0;
    root.style.setProperty('--border-width', `${borderWidth}px`);
    root.style.setProperty('--border-radius', `${borderRadius}px`);
    root.style.setProperty('--inner-border-radius', `${innerRadius}px`);
    root.style.setProperty('--text-color', settings.textColor);
    root.style.setProperty('--outline-color', settings.outlineColor || '#FF3B30');
    root.style.setProperty('--bg-color', (settings.bgColorMode === 'gradient') ? settings.gradientBg : settings.backgroundColor);
    
    // é‚Šæ¡†èˆ‡èƒŒæ™¯
    containerEl.className = containerEl.id.includes('display') ? 'display-screen' : 'controller-preview';
    if (settings.backgroundBorder === 'solid') { containerEl.classList.add('border-style-solid'); } 
    else if (settings.backgroundBorder === 'rainbow') { containerEl.classList.add('border-style-rainbow'); }
    
    // ç¶²æ ¼èˆ‡æ•ˆæœ
    const gridBg = containerEl.querySelector('.grid-bg');
    const gap = containerEl.querySelector('.gap-overlay');
    const isGridEnabled = settings.gridStyle && settings.gridStyle !== 'none';
    if (gridBg) {
        if(isGridEnabled) {
            gridBg.style.display = 'block';
            root.style.setProperty('--grid-mask-image', `url("data:image/svg+xml;utf8,${encodeURIComponent(gridMaskSVG(settings.gridStyle))}")`);
            root.style.setProperty('--grid-color', (settings.gridColorMode === 'gradient') ? settings.gradientGrid : settings.gridColor);
        } else { gridBg.style.display = 'none'; }
    }
    if (gap) {
        if (isGridEnabled && settings.textBlendMode === 'multiply') { gap.style.display = 'block'; } else { gap.style.display = 'none'; }
    }
    if (bgEffectEl) { bgEffectEl.innerHTML = (settings.backgroundEffect === 'eyes') ? `<div class="eye"><div class="pupil"></div></div><div class="eye"><div class="pupil"></div></div>` : ''; }

    // æ ¹æ“šæ–‡å­—é¢¨æ ¼é¸æ“‡æ¸²æŸ“æ–¹å¼
    if (settings.textStyle === 'dot-matrix') {
        textEl.style.display = 'none';
        canvasEl.style.display = 'block';
        startDotMatrixAnimation(els, settings, isPreview);
    } else {
        textEl.style.display = 'inline-block';
        canvasEl.style.display = 'none';
        renderStandardText(els, settings, isPreview);
    }
  }

  function renderStandardText(els, settings, isPreview) {
    const { textEl, containerEl, wrapperEl } = els;
    
    textEl.style.fontFamily = settings.fontFamily || defaultSettings.fontFamily;
    textEl.innerHTML = '';
    textEl.className = 'marquee-text';
    
    let globalAnims = [];
    if (settings.scrollDirection !== 'none') {
        globalAnims.push(`${settings.scrollDirection} ${Number(settings.scrollSpeed) || 10}s linear infinite`);
    }
    if (settings.textAnimation === 'blink' && !settings.isAdvancedText) {
        textEl.classList.add('text-anim-blink');
    }
    textEl.style.animation = globalAnims.join(', ');

    const chars = Array.from(settings.text);
    const useAdvanced = settings.isAdvancedText && Array.isArray(settings.charColors) && Array.isArray(settings.charAnimations);
    const perCharGlobalAnims = ['wave', 'jump', 'heartbeat', 'shake'];
    const isPerCharGlobalAnim = perCharGlobalAnims.includes(settings.textAnimation) && !useAdvanced;

    const fragment = document.createDocumentFragment();
    chars.forEach((char, index) => {
        const span = document.createElement('span');
        span.textContent = char;
        
        if (useAdvanced) {
            const color = settings.charColors[index];
            const anim = settings.charAnimations[index];
            if (color) span.style.color = color;
            if (anim && anim !== 'none') {
                span.style.display = 'inline-block';
                span.style.animation = `${anim}-anim 1.2s ease-in-out infinite`;
                span.style.animationDelay = `${index * 0.1}s`;
            }
        } else if (isPerCharGlobalAnim) {
             span.style.display = 'inline-block';
             span.style.animation = `${settings.textAnimation}-anim 1.2s ease-in-out infinite`;
             span.style.animationDelay = `${index * 0.1}s`;
        }
        fragment.appendChild(span);
    });
    textEl.appendChild(fragment);

    if (!useAdvanced) {
        if (settings.textAnimation === 'rainbow') { textEl.classList.add('gradient-text', 'text-anim-rainbow'); }
        else if (settings.textStyle === 'outline') { textEl.classList.add('gradient-text', 'text-style-outline'); textEl.style.backgroundImage = (settings.textColorMode === 'gradient') ? settings.gradientText : `linear-gradient(90deg, ${settings.textColor}, ${settings.textColor})`; }
        else {
            if (settings.textColorMode === 'gradient') { textEl.classList.add('gradient-text'); textEl.style.backgroundImage = settings.gradientText; }
            else { textEl.style.color = settings.textColor; }
            if (settings.textStyle === 'glow') { textEl.classList.add('text-style-glow'); }
        }
    }
    
    let finalFontSize = 100;
    // ... (å­—é«”å¤§å°è¨ˆç®—é‚è¼¯ï¼Œèˆ‡ä¹‹å‰ç›¸åŒ)
    switch(settings.fontSizeMode){
      case 'fitHeight': finalFontSize = containerEl.clientHeight * (settings.fontSize / 100); break;
      case 'fitWidth': {
        let low = 1, high = 2000, bestSize = 10;
        for(let i=0; i<10; i++){ let mid = Math.floor((low+high)/2); textEl.style.fontSize = mid + 'px'; if(textEl.scrollWidth <= containerEl.clientWidth) { bestSize = mid; low = mid + 1; } else { high = mid - 1; } }
        finalFontSize = bestSize; break;
      }
      case 'multiline': {
        textEl.style.whiteSpace = 'pre-wrap';
        let low = 1, high = 2000, bestSize = 10;
        for(let i=0; i<10; i++){ let mid = Math.floor((low+high)/2); textEl.style.fontSize = mid + 'px'; if(textEl.scrollHeight <= containerEl.clientHeight && textEl.scrollWidth <= containerEl.clientWidth) { bestSize = mid; low = mid + 1;} else { high = mid - 1; } }
        finalFontSize = bestSize; break;
      }
      default: finalFontSize = isPreview ? Math.min(Number(settings.fontSize) || 80, containerEl.clientHeight * 0.8) : (Number(settings.fontSize) || 80); break;
    }
    textEl.style.fontSize = `${finalFontSize}px`;

    wrapperEl.style.display = settings.scrollDirection === 'none' ? 'flex' : 'block';
    if (settings.scrollDirection === 'none') wrapperEl.style.justifyContent = (settings.fontSizeMode === 'fitHeight') ? 'flex-start' : 'center'; else wrapperEl.style.justifyContent = '';
  }

  function startDotMatrixAnimation(els, settings, isPreview) {
    const { canvasEl, containerEl } = els;
    const ctx = canvasEl.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const rect = canvasEl.getBoundingClientRect();
    canvasEl.width = rect.width * dpr;
    canvasEl.height = rect.height * dpr;
    ctx.scale(dpr, dpr);

    let finalFontSize = 100;
    // ... (èˆ‡ä¸Šé¢é¡ä¼¼çš„å­—é«”å¤§å°è¨ˆç®—é‚è¼¯)
    switch(settings.fontSizeMode){
      case 'fitHeight': finalFontSize = containerEl.clientHeight * (settings.fontSize / 100); break;
      // ... ç°¡åŒ– fitWidth å’Œ multiline for canvas
      default: finalFontSize = isPreview ? Math.min(Number(settings.fontSize) || 80, containerEl.clientHeight * 0.8) : (Number(settings.fontSize) || 80); break;
    }
    
    const offscreenCanvas = document.createElement('canvas');
    const offscreenCtx = offscreenCanvas.getContext('2d');
    offscreenCanvas.width = canvasEl.width;
    offscreenCanvas.height = canvasEl.height;
    
    const font = `${finalFontSize}px ${settings.fontFamily}`;
    offscreenCtx.font = font;
    const textWidth = offscreenCtx.measureText(settings.text).width;
    
    let x = (settings.scrollDirection === 'none') ? (containerEl.clientWidth - textWidth) / 2 : (settings.scrollDirection === 'marquee-left' ? containerEl.clientWidth : -textWidth);
    const speed = (containerEl.clientWidth + textWidth) / (settings.scrollSpeed * 60);

    function draw() {
        ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
        offscreenCtx.clearRect(0, 0, offscreenCanvas.width, offscreenCanvas.height);

        offscreenCtx.fillStyle = 'white';
        offscreenCtx.font = font;
        offscreenCtx.textBaseline = 'middle';
        offscreenCtx.fillText(settings.text, x, containerEl.clientHeight / 2);

        const imageData = offscreenCtx.getImageData(0, 0, offscreenCanvas.width, offscreenCanvas.height);
        const data = imageData.data;
        
        const dotSize = Math.max(1.5, finalFontSize / 35);
        const gap = Math.max(3, dotSize * 2);

        ctx.fillStyle = settings.textColor;
        for (let y = 0; y < offscreenCanvas.height; y += gap) {
            for (let x = 0; x < offscreenCanvas.width; x += gap) {
                const i = (Math.floor(y) * offscreenCanvas.width + Math.floor(x)) * 4;
                if (data[i + 3] > 128) { // if alpha > 50%
                    ctx.beginPath();
                    ctx.arc(x / dpr, y / dpr, dotSize / 2, 0, 2 * Math.PI);
                    ctx.fill();
                }
            }
        }

        if (settings.scrollDirection === 'marquee-left') {
            x -= speed;
            if (x < -textWidth) x = containerEl.clientWidth;
        } else if (settings.scrollDirection === 'marquee-right') {
            x += speed;
            if (x > containerEl.clientWidth) x = -textWidth;
        }
        
        animationFrameId = requestAnimationFrame(draw);
    }
    draw();
  }
  
  // ... å…¶ä»– setup, startDisplayMode, listenToChanges å‡½æ•¸ä¸è®Š ...
  async function setupDisplayListeners() { /* ... no changes ... */ }
  async function startDisplayMode(sessionId) {
      currentSessionId = sessionId; showView('display');
      const displayEls = {
          textEl: document.getElementById('marquee-text'),
          containerEl: document.getElementById('display-screen'),
          wrapperEl: document.getElementById('marquee-container-wrapper'),
          bgEffectEl: document.getElementById('background-effects-container'),
          canvasEl: document.getElementById('display-canvas')
      };
      // ... a
  }
  
  async function startControllerMode(sessionId) {
      // ...
      Object.assign(controllerState, {
          // ...
          charAnimations: settings.charAnimations || []
      });
      // ...
  }

  function updateControllerUI(settings) {
    // ...
    document.getElementById('advanced-text-toggle').checked = !!settings.isAdvancedText;
    // ...
    updateButtonGroupState('.text-animation-btn', 'animation', settings.textAnimation);
    // ...
    toggleAdvancedModeUI(settings.isAdvancedText, settings.text);
    // ...
  }
  
  function toggleAdvancedModeUI(isActive, text) {
      document.getElementById('advanced-text-wrapper').classList.toggle('hidden', !isActive);
      document.getElementById('global-color-wrapper').classList.toggle('control-disabled', isActive);
      document.getElementById('text-style-wrapper').classList.toggle('control-disabled', isActive);
      document.getElementById('text-animation-wrapper').classList.toggle('control-disabled', isActive);
      
      if (isActive) {
          renderCharSelector(text);
      } else {
          selectedCharIndices.clear();
      }
  }

  function renderCharSelector(text) {
      const selector = document.getElementById('char-selector');
      selector.innerHTML = '';
      selectedCharIndices.clear();
      const chars = Array.from(text);
      
      const ensureArray = (arr, len) => (!Array.isArray(arr) || arr.length !== len) ? new Array(len).fill(null) : arr;
      controllerState.charColors = ensureArray(controllerState.charColors, chars.length);
      controllerState.charAnimations = ensureArray(controllerState.charAnimations, chars.length);

      chars.forEach((char, index) => {
          const btn = document.createElement('button');
          btn.className = 'char-btn p-1 rounded-md bg-gray-800 text-white font-mono';
          btn.textContent = char;
          btn.dataset.index = index;
          if (controllerState.charColors[index]) btn.style.backgroundColor = controllerState.charColors[index];
          btn.addEventListener('click', () => { /* ... no changes ... */ });
          selector.appendChild(btn);
      });
  }
  
  function setupControllerListeners() {
      // ...
      document.getElementById('advanced-text-toggle').addEventListener('change', (e) => {
          toggleAdvancedModeUI(e.target.checked, document.getElementById('text-input').value);
          if (!e.target.checked) {
              controllerState.charColors = [];
              controllerState.charAnimations = [];
          }
          updateSession();
      });

      // ...
      // For individual animation buttons
      document.getElementById('char-animation-picker').addEventListener('click', (e) => {
          const el = e.target.closest('[data-char-animation]');
          if (el) {
              const anim = el.dataset.charAnimation;
              selectedCharIndices.forEach(index => {
                  controllerState.charAnimations[index] = anim === 'none' ? null : anim;
              });
              // No visual update needed on char buttons, just save state
              updateSession();
          }
      });
  }
  
  function getSettings() {
      return {
          // ...
          isAdvancedText: document.getElementById('advanced-text-toggle').checked,
          charAnimations: controllerState.charAnimations,
          // ...
      };
  }
  
  let updateTimeout;
  function updateSession() {
      // ...
  }
  
  function updatePreview() {
      const settings = getSettings();
      const previewEls = {
          textEl: document.getElementById('preview-marquee-text'),
          containerEl: document.getElementById('controller-preview'),
          wrapperEl: document.getElementById('preview-marquee-container-wrapper'),
          canvasEl: document.getElementById('preview-canvas'),
          bgEffectEl: null // No bg effects in preview
      };
      applySettings(previewEls, settings, true);
  }

</script>
</body>
</html>

