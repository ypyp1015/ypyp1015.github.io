<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>遠端遙控 LED 跑馬燈 v22.15.1 (Gemini)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<!-- 引入所有需要的字體 -->
<link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Noto+Serif+TC:wght@400;700&family=ZCOOL+KuaiLe&family=Cutive+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
  html, body { height:100%; margin:0; padding:0; background:#0f172a; }
  body { font-family:'Inter','微軟正黑體',sans-serif; overscroll-behavior:none; }
  .led-font { font-family:'DotGothic16',sans-serif; }

  @keyframes marquee-left { from{ transform:translateX(100vw);} to{ transform:translateX(-100%);} }
  @keyframes marquee-right{ from{ transform:translateX(-100%);} to{ transform:translateX(100vw);} }
  @keyframes marquee-up { from{ transform:translateY(100vh);} to{ transform:translateY(-100%);} }
  @keyframes marquee-down { from{ transform:translateY(-100%);} to{ transform:translateY(100vh);} }
  @keyframes blink-effect { 50%{ opacity:0; } }
  @keyframes jump-effect {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(calc(-1 * var(--jump-amplitude, 20px))); }
  }
  @keyframes eye-blink-anim { 0%,40%,100%{ transform:scaleY(1);} 42%{ transform:scaleY(0.1);} }
  @keyframes eye-move-anim { 0%,20%{ transform:translateX(0);} 30%,50%{ transform:translateX(-10px);} 60%,80%{ transform:translateX(10px);} 90%,100%{ transform:translateX(0);} }
  @keyframes rainbow-border-anim { 0%{background-position:0% 50%;} 50%{background-position:100% 50%;} 100%{background-position:0% 50%;} }
  @keyframes rainbow-text-anim { 0%{background-position:0% 50%;} 50%{background-position:100% 50%;} 100%{background-position:0% 50%;} }

  .marquee-text{
    font-size:var(--font-size,80px);
    color:var(--text-color,#FFFFFF);
    white-space:nowrap;
    display:inline-block;
    line-height:1.1;
    position:relative;
    z-index:1;
    transition: color .2s, background-color .2s, text-shadow .2s;
  }
  .gradient-text{
    background-clip:text; -webkit-background-clip:text;
    color:transparent !important; -webkit-text-fill-color:transparent;
  }
  .text-style-glow{ text-shadow:0 0 8px var(--text-color,#fff), 0 0 12px var(--text-color,#fff); }
  .text-style-outline{
    -webkit-text-stroke: 1.5px var(--outline-color);
    -webkit-text-fill-color: currentColor; /* 使用 currentColor 讓 span 的 color 生效 */
    paint-order: stroke fill;
    text-shadow: none !important;
  }
  /* 當 outline 與 gradient-text 並存時，才讓文字透明 */
  .gradient-text.text-style-outline {
     -webkit-text-fill-color: transparent;
  }
  .text-style-dotted {
    background-clip: text; -webkit-background-clip: text;
    color: transparent !important; -webkit-text-fill-color: transparent;
    background-image: radial-gradient(var(--text-color) 35%, transparent 40%);
    background-size: 3px 3px;
    text-shadow: none !important;
    -webkit-text-stroke: 0;
  }
  .text-style-rainbow {
    background-image: linear-gradient(90deg, #ff004e, #ffe848, #00ffef, #0047ff, #ff004e);
    background-size: 200% 200%;
    animation: rainbow-text-anim 4s linear infinite;
  }

  .display-screen{
    width:100%; height:100%; position:relative;
    background:var(--bg-color,#000); box-sizing:border-box;
    isolation: isolate;
  }
  .marquee-container-wrapper{ position:absolute; top:50%; left:0; width:100%; transform:translateY(-50%); overflow:hidden; z-index:2; }

  .grid-bg{
    position:absolute; inset:0; z-index:1; pointer-events:none;
    background: var(--grid-color);
    mask-image: var(--grid-mask-image); -webkit-mask-image: var(--grid-mask-image);
    mask-size: var(--grid-size) var(--grid-size); -webkit-mask-size: var(--grid-size) var(--grid-size);
    mask-position: left top; -webkit-mask-position: left top;
    mask-repeat: repeat; -webkit-mask-repeat: repeat;
    border-radius: var(--inner-border-radius, 0px);
    mask-mode: alpha; -webkit-mask-mode: alpha;
  }

  .gap-overlay{
    position:absolute; inset:0; z-index:3; pointer-events:none;
    background: var(--gap-color,#000); opacity: var(--gap-alpha,1);
    mask-image: var(--gap-mask-image); -webkit-mask-image: var(--gap-mask-image);
    mask-size: var(--grid-size) var(--grid-size); -webkit-mask-size: var(--grid-size) var(--grid-size);
    mask-position: left top; -webkit-mask-position: left top;
    mask-repeat: repeat; -webkit-mask-repeat: repeat;
    display:none;
    border-radius: var(--inner-border-radius, 0px);
    mask-mode: alpha; -webkit-mask-mode: alpha;
  }

  .border-style-solid {
    border-style: solid;
    border-color: white;
    border-width: var(--border-width, 8px);
    border-radius: var(--border-radius, 16px);
  }
  .border-style-rainbow {
    position: relative;
    border-radius: var(--border-radius, 16px);
    animation: rainbow-border-anim 3s linear infinite;
    background-size: 200% 200%;
  }
  .border-style-rainbow::after {
    content: '';
    position: absolute;
    inset: var(--border-width, 8px);
    background: var(--bg-color);
    border-radius: var(--inner-border-radius, 8px);
    z-index: 0;
  }


  #background-effects-container{ position:absolute; inset:0; display:flex; justify-content:center; align-items:center; gap:20px; pointer-events:none; z-index:1; }
  .eye{ width:80px; height:80px; background:#fff; border-radius:50%; position:relative; animation:eye-blink-anim 5s infinite; overflow:hidden; }
  .pupil{ width:40px; height:40px; background:#222; border-radius:50%; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); animation: eye-move-anim 10s infinite; }

  .sticky-preview{ position:sticky; top:0; z-index:10; background:#1e293b; padding:1.5rem; margin-left:-1.5rem; margin-right:-1.5rem; }
  .controller-preview{ 
    height:120px; 
    position:relative; 
    background:var(--bg-color,#000); 
    outline:1px solid #374151; 
    box-sizing:border-box; 
    isolation: isolate;
    overflow: hidden; /* Prevent visual overflow */
  }
  .controller-preview .marquee-text{ font-size:var(--font-size,40px); }

  .no-scrollbar::-webkit-scrollbar{ display:none; }
  .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
  .control-btn-active{ box-shadow:0 0 0 3px #4f46e5; }
  .control-disabled{ opacity:.4; pointer-events:none; cursor:not-allowed; }
 
  /* 【新增】個別文字上色 UI 樣式 */
  .char-btn {
    transition: all 0.2s;
    border: 2px solid transparent;
    position: relative;
  }
  .char-btn-active {
    border-color: #6366f1; /* Indigo */
    transform: scale(1.1);
    background-color: #4f46e5 !important;
    color: white !important;
  }
  .effect-indicator {
    position: absolute;
    top: -4px;
    right: -4px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #f59e0b;
    border: 1px solid #1e293b;
  }
</style>
</head>
<body class="text-white">
<div id="app-container" class="h-full w-full">
  <!-- 首頁 -->
  <div id="home-view" class="flex flex-col items-center justify-center h-full p-8 text-center bg-gray-900">
    <h1 class="text-5xl font-bold mb-4 led-font">LED Scroller</h1>
    <p class="text-gray-400 mb-12">數位跑馬燈・遠端遙控</p>
    <div class="space-y-4 w-full max-w-xs">
      <button id="create-display-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">建立新的顯示面板</button>
      <p class="text-gray-500">或</p>
      <div class="relative">
        <input type="text" id="session-id-input" placeholder="輸入面板 ID 進入控制台" class="w-full bg-gray-800 border border-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <button id="open-controller-btn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-3 rounded-md">進入</button>
      </div>
    </div>
    <p class="text-gray-600 mt-12 text-sm">提示：在設備 A 建立顯示面板，<br>然後在設備 B 輸入面板 ID 進行遙控。</p>
  </div>

  <!-- 顯示面板 -->
  <div id="display-view" class="hidden h-full w-full">
    <div class="display-screen" id="display-screen">
      <div class="grid-bg"></div>
      <div id="background-effects-container"></div>
      <div class="marquee-container-wrapper" id="marquee-container-wrapper">
        <div class="marquee-text" id="marquee-text"><span>請稍候...</span></div>
      </div>
      <div class="gap-overlay" id="gap-overlay"></div>
    </div>
    <div id="info-overlay" class="absolute top-4 left-4 bg-black bg-opacity-70 p-4 rounded-lg text-white transition-opacity duration-500">
      <p class="text-sm">輕觸螢幕可隱藏/顯示此資訊</p>
      <p id="session-id-display" class="font-mono text-lg my-2 bg-gray-700 px-2 py-1 rounded"></p>
      <div id="qrcode-container" class="p-2 bg-white rounded-md mt-2"></div>
    </div>
    <button id="fullscreen-btn" class="absolute bottom-4 right-4 text-white bg-black bg-opacity-50 p-3 rounded-full hover:bg-opacity-75 transition" aria-label="fullscreen">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
    </button>
  </div>

  <!-- 控制台 -->
  <div id="controller-view" class="hidden h-full w-full bg-gray-800 overflow-y-auto no-scrollbar">
    <div class="p-6 max-w-md mx-auto">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold led-font">控制台</h2>
        <p class="text-sm text-gray-400 font-mono">ID: <span id="controller-session-id"></span></p>
      </div>

      <div class="sticky-preview">
        <label class="block mb-2 text-sm font-medium text-gray-300">效果預覽</label>
        <div class="controller-preview" id="controller-preview">
          <div class="grid-bg"></div>
          <div class="marquee-container-wrapper" id="preview-marquee-container-wrapper">
            <div class="marquee-text" id="preview-marquee-text"></div>
          </div>
          <div class="gap-overlay"></div>
        </div>
      </div>

      <div class="mb-6 mt-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">顯示文字</label>
        <textarea id="text-input" rows="3" class="w-full bg-gray-700 border border-gray-600 text-white text-lg p-2.5 rounded-lg" placeholder="在此輸入文字..."></textarea>
      </div>
     
      <div class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">字體選擇</label>
        <div class="grid grid-cols-3 gap-3">
            <button data-font="'Inter','微軟正黑體',sans-serif" class="font-btn p-3 bg-indigo-600 rounded-lg text-sm">標準體</button>
            <button data-font="'DotGothic16', sans-serif" class="font-btn p-3 bg-gray-700 rounded-lg text-sm">點陣體</button>
            <button data-font="'Noto Serif TC', serif" class="font-btn p-3 bg-gray-700 rounded-lg text-sm">宋體</button>
            <button data-font="'ZCOOL KuaiLe', cursive" class="font-btn p-3 bg-gray-700 rounded-lg text-sm">快樂體</button>
            <button data-font="'Cutive Mono', monospace" class="font-btn p-3 bg-gray-700 rounded-lg text-sm">等寬體</button>
        </div>
      </div>

      <div class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">字體模式</label>
        <div class="grid grid-cols-2 gap-3">
          <button data-mode="fixed" class="font-mode-btn p-3 bg-gray-700 rounded-lg text-sm">固定大小</button>
          <button data-mode="fitHeight" class="font-mode-btn p-3 bg-indigo-600 rounded-lg text-sm">填滿高度</button>
          <button data-mode="fitWidth" class="font-mode-btn p-3 bg-gray-700 rounded-lg text-sm">填滿寬度</button>
          <button data-mode="multiline" class="font-mode-btn p-3 bg-gray-700 rounded-lg text-sm">自動換行</button>
        </div>
      </div>

      <!-- Font Size Controls -->
      <div id="fit-height-controls" class="mb-2 space-y-2 transition-opacity">
          <label for="fit-height-slider" class="block text-sm font-medium text-gray-300">高度佔比: <span id="fit-height-value">95</span>%</label>
          <input id="fit-height-slider" type="range" min="10" max="100" value="95" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
      </div>
      <div id="fixed-size-controls" class="mb-6 space-y-2 transition-opacity hidden">
          <label for="fixed-size-slider" class="block text-sm font-medium text-gray-300">字體大小: <span id="fixed-size-value">100</span>px</label>
          <input id="fixed-size-slider" type="range" min="10" max="500" value="100" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
      </div>

      <div class="mb-6">
        <label for="speed-slider" class="block mb-2 text-sm font-medium text-gray-300">滾動速度: <span id="speed-value">10</span>s</label>
        <input id="speed-slider" type="range" min="1" max="60" value="10" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
      </div>
      <div class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">滾動方向</label>
        <div class="grid grid-cols-5 gap-2 text-center">
          <button data-direction="marquee-left" class="direction-btn p-3 bg-gray-700 rounded-lg text-lg">←</button>
          <button data-direction="marquee-up" class="direction-btn p-3 bg-gray-700 rounded-lg text-lg">↑</button>
          <button data-direction="none" class="direction-btn p-3 bg-indigo-600 rounded-lg text-base">❚❚</button>
          <button data-direction="marquee-down" class="direction-btn p-3 bg-gray-700 rounded-lg text-lg">↓</button>
          <button data-direction="marquee-right" class="direction-btn p-3 bg-gray-700 rounded-lg text-lg">→</button>
        </div>
      </div>

      <div id="global-color-wrapper" class="mb-6 p-4 bg-gray-900 rounded-lg">
        <div class="flex border-b border-gray-700 mb-4">
          <div id="color-tab" class="flex -mb-px">
            <button data-tab="solid" class="tab-btn text-white py-2 px-4 border-b-2 border-indigo-500 font-medium">純色</button>
            <button data-tab="gradient" class="tab-btn text-gray-400 py-2 px-4 border-b-2 border-transparent">漸層</button>
          </div>
        </div>
        <div id="solid-color-panel">
          <label class="block mb-2 text-sm font-medium text-gray-300">文字顏色</label>
          <div class="flex flex-wrap gap-3 mb-4" id="text-color-picker"></div>
          <label class="block mb-2 text-sm font-medium text-gray-300">背景顏色</label>
          <div class="flex flex-wrap gap-3" id="bg-color-picker"></div>
        </div>
        <div id="gradient-color-panel" class="hidden">
          <label class="block mb-2 text-sm font-medium text-gray-300">文字漸層</label>
          <div class="flex flex-wrap gap-2 mb-4" id="text-gradient-picker"></div>
          <label class="block mb-2 text-sm font-medium text-gray-300">背景漸層</label>
          <div class="flex flex-wrap gap-2" id="bg-gradient-picker"></div>
        </div>
      </div>

      <div class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">背景網格</label>
        <div class="flex flex-wrap gap-3">
          <button data-grid="none" class="grid-style-btn p-3 bg-indigo-600 rounded-lg text-sm">無</button>
          <button data-grid="dot" class="grid-style-btn p-3 bg-gray-700 rounded-lg text-sm">⚫️ 點狀</button>
          <button data-grid="square" class="grid-style-btn p-3 bg-gray-700 rounded-lg text-sm">⬛️ 方形</button>
          <button data-grid="diamond" class="grid-style-btn p-3 bg-gray-700 rounded-lg text-sm">♦️ 菱形</button>
        </div>
      </div>

      <div id="grid-advanced-section" class="mb-6 space-y-6 hidden">
        <div>
          <label for="grid-size-slider" class="block mb-2 text-sm font-medium text-gray-300">網格大小: <span id="grid-size-value">20</span>px</label>
          <input id="grid-size-slider" type="range" min="4" max="120" value="20" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
        </div>

        <div class="p-4 bg-gray-900 rounded-lg">
          <div class="flex border-b border-gray-700 mb-4">
            <div id="grid-color-tab" class="flex -mb-px">
              <button data-tab="solid" class="grid-tab-btn text-white py-2 px-4 border-b-2 border-indigo-500 font-medium">純色</button>
              <button data-tab="gradient" class="grid-tab-btn text-gray-400 py-2 px-4 border-b-2 border-transparent">漸層</button>
            </div>
          </div>
          <div id="grid-solid-color-panel">
            <label class="block mb-2 text-sm font-medium text-gray-300">網格顏色</label>
            <div class="flex flex-wrap gap-3" id="grid-color-picker"></div>
          </div>
          <div id="grid-gradient-color-panel" class="hidden">
            <label class="block mb-2 text-sm font-medium text-gray-300">網格漸層</label>
            <div class="flex flex-wrap gap-2" id="grid-gradient-picker"></div>
          </div>
        </div>
       
        <div class="p-4 bg-gray-900 rounded-lg">
          <label class="block mb-2 text-sm font-medium text-gray-300">LED穿孔</label>
          <div class="flex flex-wrap gap-3">
            <button data-blend="normal" class="blend-mode-btn p-3 bg-indigo-600 rounded-lg text-sm">關閉</button>
            <button data-blend="multiply" class="blend-mode-btn p-3 bg-gray-700 rounded-lg text-sm">開啟</button>
          </div>
          <div id="gap-controls" class="mt-4 hidden">
            <label class="block mb-2 text-sm font-medium text-gray-300">隙縫顏色</label>
            <div class="flex flex-wrap gap-3" id="gap-color-picker"></div>
            <div class="mt-4">
              <label for="gap-alpha-slider" class="block mb-2 text-sm font-medium text-gray-300">隙縫不透明度: <span id="gap-alpha-value">1.00</span></label>
              <input id="gap-alpha-slider" type="range" min="0.10" max="1.00" step="0.05" value="1.00" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
            </div>
          </div>
        </div>
      </div>

      <div id="text-style-wrapper" class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">文字風格</label>
        <div class="flex flex-wrap gap-3">
          <button data-style="normal" class="text-style-btn p-3 bg-indigo-600 rounded-lg text-sm">標準</button>
          <button data-style="glow" class="text-style-btn p-3 bg-gray-700 rounded-lg text-sm">✨ 發光</button>
          <button data-style="outline" class="text-style-btn p-3 bg-gray-700 rounded-lg text-sm">✏️ 邊框</button>
          <button data-style="dotted" class="text-style-btn p-3 bg-gray-700 rounded-lg text-sm">⚫️ 點狀</button>
          <button data-style="rainbow" class="text-style-btn p-3 bg-gray-700 rounded-lg text-sm">🌈 彩虹漸層</button>
        </div>
      </div>
      <div id="outline-color-section" class="mb-6 hidden">
        <label class="block mb-2 text-sm font-medium text-gray-300">邊框顏色</label>
        <div class="flex flex-wrap gap-3" id="outline-color-picker"></div>
      </div>
      
      <div class="mb-6 p-4 bg-gray-900/50 rounded-lg">
        <label class="block mb-2 text-sm font-medium text-gray-300">文字效果與個性化</label>
        <div id="global-text-effect-wrapper">
            <div class="flex flex-wrap gap-3">
                <button data-effect="none" class="text-effect-btn p-3 bg-indigo-600 rounded-lg text-sm">無</button>
                <button data-effect="blink" class="text-effect-btn p-3 bg-gray-700 rounded-lg text-sm">✨ 閃爍</button>
                <button data-effect="jump" class="text-effect-btn p-3 bg-gray-700 rounded-lg text-sm">🤸‍♀️ 跳躍</button>
            </div>
        </div>
        <div id="jump-controls-section" class="mt-4 space-y-4 hidden">
            <div>
                <label for="jump-amplitude-slider" class="block mb-2 text-sm font-medium text-gray-300">跳躍幅度: <span id="jump-amplitude-value">20</span>px</label>
                <input id="jump-amplitude-slider" type="range" min="5" max="100" value="20" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
            </div>
            <div>
                <label for="jump-frequency-slider" class="block mb-2 text-sm font-medium text-gray-300">跳躍頻率: <span id="jump-frequency-value">1.5</span>s</label>
                <input id="jump-frequency-slider" type="range" min="0.5" max="5" step="0.1" value="1.5" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
            </div>
        </div>
        <div class="border-t border-gray-700 my-4"></div>
        <div class="flex items-center justify-between">
            <label class="block text-sm font-medium text-gray-300">個性化設定</label>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="char-personalization-toggle" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
            </label>
        </div>
        <div id="char-editor-wrapper" class="hidden space-y-4 mt-4">
            <div>
                <label class="block mb-2 text-sm font-medium text-gray-400">1. 點選下方文字以選取</label>
                <div id="char-personalization-selector" class="flex flex-wrap gap-2 p-2 bg-gray-700 rounded-md min-h-[44px] items-center"></div>
            </div>
            <div>
                <label class="block mb-2 text-sm font-medium text-gray-400">2. 為選取的文字上色</label>
                 <div class="flex flex-wrap gap-3" id="personal-char-color-picker"></div>
            </div>
            <div>
                <label class="block mb-2 text-sm font-medium text-gray-400">3. 為選取的文字套用特效</label>
                <div id="personal-char-effect-picker" class="flex flex-wrap gap-3">
                    <button data-effect="none" class="personal-char-effect-btn p-3 bg-indigo-600 rounded-lg text-sm">無</button>
                    <button data-effect="blink" class="personal-char-effect-btn p-3 bg-gray-700 rounded-lg text-sm">✨ 閃爍</button>
                    <button data-effect="jump" class="personal-char-effect-btn p-3 bg-gray-700 rounded-lg text-sm">🤸‍♀️ 跳躍</button>
                </div>
            </div>
        </div>
      </div>


      <div id="border-style-wrapper" class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">背景邊框</label>
        <div class="flex flex-wrap gap-3">
          <button data-border="none" class="border-style-btn p-3 bg-indigo-600 rounded-lg text-sm">無</button>
          <button data-border="solid" class="border-style-btn p-3 bg-gray-700 rounded-lg text-sm">⬜️ 實線</button>
          <button data-border="rainbow" class="border-style-btn p-3 bg-gray-700 rounded-lg text-sm">🌈 彩虹邊框</button>
        </div>
      </div>
     
      <div id="border-controls-section" class="mb-6 space-y-6 hidden">
        <div>
            <label for="border-width-slider" class="block mb-2 text-sm font-medium text-gray-300">邊框寬度: <span id="border-width-value">8</span>px</label>
            <input id="border-width-slider" type="range" min="0" max="50" value="8" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
        </div>
        <div>
            <label for="border-radius-slider" class="block mb-2 text-sm font-medium text-gray-300">邊框圓角: <span id="border-radius-value">16</span>px</label>
            <input id="border-radius-slider" type="range" min="0" max="100" value="16" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
        </div>
      </div>

      <div id="bg-effect-wrapper" class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">背景動畫</label>
        <div class="flex flex-wrap gap-3">
          <button data-effect="none" class="bg-effect-btn p-3 bg-indigo-600 rounded-lg text-sm">無</button>
          <button data-effect="eyes" class="bg-effect-btn p-3 bg-gray-700 rounded-lg text-sm">👀 眼睛</button>
        </div>
      </div>

      <div class="mt-8 mb-4">
        <a href="#" onclick="window.location.search=''; return false;" class="w-full text-center block bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg">返回首頁</a>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDiXuuIQB9EJQZtW8zYuTByxr-Y5wMpRdc",
    authDomain: "led-run-c168b.firebaseapp.com",
    projectId: "led-run-c168b",
    storageBucket: "led-run-c168b.appspot.com",
    messagingSenderId: "555557259748",
    appId: "1:555557259748:web:7a79d35743bcbadbf11ff1",
    measurementId: "G-7JH5TLX99R"
  };

  let db;
  try { db = getFirestore(initializeApp(firebaseConfig)); } catch(e){ console.error("Firebase 初始化失敗", e); alert("Firebase 連線失敗！"); }

  const homeView = document.getElementById('home-view'),
        displayView = document.getElementById('display-view'),
        controllerView = document.getElementById('controller-view');

  let currentSessionId = null, unsubscribe = null;
  const controllerState = { textColorMode:'solid', bgColorMode:'solid', gridColorMode:'solid', charColors: [], charEffects: [] };
  let gridSizeState = 20;
  let selectedCharIndices = new Set();
  // 為不同模式建立獨立的字體大小狀態
  let fillHeightPercentage = 95;
  let fixedFontSize = 100;
  let currentFontSizeMode = 'fitHeight';


  const solid16 = ['#FFFFFF','#000000','#1F2937','#EF4444','#F59E0B','#10B981','#3B82F6','#8B5CF6','#EC4899','#14B8A6','#22D3EE','#A3E635','#F97316','#84CC16'];
  const bgSolid16 = ['#000000','#0B1220','#111827','#1F2937','#374151','#4B5563','#6B7280','#9CA3AF','#EF4444','#F59E0B','#10B981','#3B82F6','#8B5CF6','#EC4899','#14B8A6','#F3F4F6'];
  const gridSolid16 = ['#374151', '#6B7280', '#9CA3AF', '#000000','#F59E0B','#EAB308','#10B981','#22C55E','#3B82F6','#6366F1','#A855F7','#EC4899','#EF4444','#9333EA','#22D3EE','#A3E635'];
  const gapSolid16 = ['#000000','#0B1220','#111827','#1F2937','#374151','#6B7280','#9CA3AF','#FFFFFF','#FFB703','#F59E0B','#22C55E','#3B82F6','#8B5CF6','#EC4899','#22D3EE','#A3E635'];
  const outlineSolid = ['#FF3B30','#FFFFFF','#000000','#22C55E','#3B82F6','#F59E0B','#A855F7','#EC4899'];

  const gradients16 = [ 'linear-gradient(90deg,#F37335,#FDC830)','linear-gradient(90deg,#2193b0,#6dd5ed)', 'linear-gradient(90deg,#56ab2f,#a8e063)','linear-gradient(90deg,#e94057,#f27121)', 'linear-gradient(90deg,#4776E6,#8E54E9)','linear-gradient(90deg,#ff9966,#ff5e62)', 'linear-gradient(90deg,#00b09b,#96c93d)','linear-gradient(90deg,#f953c6,#b91d73)', 'linear-gradient(90deg,#00c6ff,#0072ff)','linear-gradient(90deg,#43cea2,#185a9d)', 'linear-gradient(90deg,#ff7e5f,#feb47b)','linear-gradient(90deg,#36d1dc,#5b86e5)', 'linear-gradient(90deg,#c471f5,#fa71cd)','linear-gradient(90deg,#f00000,#dc281e)', 'linear-gradient(90deg,#bdc3c7,#2c3e50)','linear-gradient(90deg,red,orange,yellow,green,blue,indigo,violet)' ];
  const bgGradients16 = [ 'linear-gradient(90deg,#0f2027,#203a43,#2c5364)','linear-gradient(90deg,#111827,#000000)', 'linear-gradient(90deg,#141E30,#243B55)','linear-gradient(90deg,#1e3c72,#2a5298)', 'linear-gradient(90deg,#4b6cb7,#182848)','linear-gradient(90deg,#000428,#004e92)', 'linear-gradient(90deg,#3E5151,#DECBA4)','linear-gradient(90deg,#232526,#414345)', 'linear-gradient(90deg,#5614B0,#DBD65C)','linear-gradient(90deg,#1f4037,#99f2c8)', 'linear-gradient(90deg,#136a8a,#267871)','linear-gradient(90deg,#373B44,#4286f4)', 'linear-gradient(90deg,#485563,#29323c)','linear-gradient(90deg,#2C3E50,#4CA1AF)', 'linear-gradient(90deg,#41295a,#2F0743)','linear-gradient(90deg,#000000,#434343)' ];
  const gridGradients16 = [ 'linear-gradient(90deg,#F8D24E,#FFD84A)','linear-gradient(90deg,#ffd166,#fca311)', 'linear-gradient(90deg,#f6d365,#fda085)','linear-gradient(90deg,#a1ffce,#faffd1)', 'linear-gradient(90deg,#d4fc79,#96e6a1)','linear-gradient(90deg,#fbd3e9,#bb377d)', 'linear-gradient(90deg,#84fab0,#8fd3f4)','linear-gradient(90deg,#a18cd1,#fbc2eb)', 'linear-gradient(90deg,#f093fb,#f5576c)','linear-gradient(90deg,#4facfe,#00f2fe)', 'linear-gradient(90deg,#fad0c4,#ffd1ff)','linear-gradient(90deg,#ffecd2,#fcb69f)', 'linear-gradient(90deg,#cfd9df,#e2ebf0)','linear-gradient(90deg,#fddb92,#d1fdff)', 'linear-gradient(90deg,#fbc2eb,#a6c1ee)','linear-gradient(90deg,#7F7FD5,#86A8E7)' ];

  const defaultSettings = { text: "Hello 👋", textColor: "#FFFFFF", backgroundColor: "#000000", fontSize: 95, fixedFontSize: 100, fontSizeMode: 'fitHeight', scrollSpeed: 10, scrollDirection: "none", textEffect: "none", jumpAmplitude: 20, jumpFrequency: 1.5, isCharPersonalizing: false, charColors: [], charEffects: [], textColorMode: 'solid', bgColorMode: 'solid', gridColorMode: 'solid', gradientText: gradients16[0], gradientBg: bgGradients16[0], gradientGrid: gridGradients16[0], textBlendMode: 'normal', gapColor: "#000000", gapAlpha: 1.0, backgroundBorder: "none", backgroundEffect: "none", gridStyle: "none", gridSize: 20, gridColor: "#374151", textStyle: "normal", outlineColor: "#FF3B30", borderWidth: 8, borderRadius: 16, fontFamily: "'Inter','微軟正黑體',sans-serif", updatedAt: serverTimestamp() };

  window.addEventListener('load', ()=>{
    const params = new URLSearchParams(window.location.search);
    if (params.has('display')) startDisplayMode(params.get('display'));
    else if (params.has('controller')) startControllerMode(params.get('controller'));
    else showView('home');
  });

  function showView(name){ [homeView, displayView, controllerView].forEach(v=>v.classList.add('hidden')); document.getElementById(`${name}-view`).classList.remove('hidden'); }
  function generateId(){ return Math.random().toString(36).substring(2,8).toUpperCase(); }

  function gridMaskSVG(shape){ if (shape==='square') return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='6' y='6' width='88' height='88' rx='12' ry='12' fill='black'/></svg>`; if (shape==='diamond') return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='16' y='16' width='68' height='68' transform='rotate(45 50 50)' fill='black'/></svg>`; return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='48' fill='black'/></svg>`; }
  function gapMaskSVG(shape){ if (shape==='square') return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='white' fill-rule='evenodd' d='M0 0H100V100H0Z M6 6H94V94H6Z'/></svg>`; if (shape==='diamond') return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='white' fill-rule='evenodd' d='M0 0H100V100H0Z M50 7L93 50 50 93 7 50Z'/></svg>`; return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='white' fill-rule='evenodd' d='M0 0H100V100H0Z M50 50 m -48,0 a 48,48 0 1,0 96,0 a 48,48 0 1,0 -96,0 Z'/></svg>`; }

  function applySettings(els, settings, isPreview = false) {
    const { textEl, containerEl, wrapperEl, bgEffectEl } = els;
    if (!textEl || !containerEl || !wrapperEl) return;
    const root = containerEl;
    const gridBg = containerEl.querySelector('.grid-bg');
    const gap = containerEl.querySelector('.gap-overlay');

    const borderWidth = parseInt(settings.borderWidth, 10) || 0;
    const borderRadius = parseInt(settings.borderRadius, 10) || 0;
    let innerRadius = (settings.backgroundBorder !== 'none') ? Math.max(0, borderRadius - borderWidth) : 0;

    root.style.setProperty('--border-width', `${borderWidth}px`);
    root.style.setProperty('--border-radius', `${borderRadius}px`);
    root.style.setProperty('--inner-border-radius', `${innerRadius}px`);
    root.style.setProperty('--text-color', settings.textColor);
    root.style.setProperty('--outline-color', settings.outlineColor || '#FF3B30');
    root.style.setProperty('--jump-amplitude', `${settings.jumpAmplitude}px`);
   
    const backgroundValue = (settings.bgColorMode === 'gradient') ? settings.gradientBg : settings.backgroundColor;
    root.style.setProperty('--bg-color', backgroundValue);
   
    root.style.setProperty('--grid-color', ((settings.gridColorMode === 'gradient') ? settings.gradientGrid : settings.gridColor));
    root.style.setProperty('--gap-color', settings.gapColor || '#000000');
    root.style.setProperty('--gap-alpha', settings.gapAlpha != null ? settings.gapAlpha : 1);
   
    textEl.style.fontFamily = settings.fontFamily || defaultSettings.fontFamily;
   
    const chars = Array.from(settings.text);
    const hasValidCharSettings = settings.isCharPersonalizing && settings.charColors && settings.charEffects && settings.charColors.length === chars.length && settings.charEffects.length === chars.length;

    textEl.innerHTML = '';
    textEl.className = 'marquee-text';
    textEl.style.color = '';
    textEl.style.backgroundImage = '';
    textEl.style.fontSize = ''; // 清除殘留的 inline font-size 以避免鎖定
    textEl.style.animation = ''; // Clear parent animation before rebuilding

    // Global Styles that apply to the container
    textEl.classList.remove('text-style-dotted', 'text-style-outline', 'text-style-glow', 'text-style-rainbow', 'gradient-text');

    if (settings.textStyle === 'rainbow' && !settings.isCharPersonalizing) {
        textEl.classList.add('gradient-text', 'text-style-rainbow');
    } else if (settings.textStyle === 'dotted' && !settings.isCharPersonalizing) {
        textEl.classList.add('text-style-dotted');
    } else if (settings.textStyle === 'outline') {
        textEl.classList.add('text-style-outline');
        if (settings.textColorMode === 'gradient' && !settings.isCharPersonalizing) {
            textEl.classList.add('gradient-text');
            textEl.style.backgroundImage = settings.gradientText;
        } else {
            textEl.style.color = settings.textColor;
        }
    } else { // Normal or Glow
        if (settings.textColorMode === 'gradient' && !settings.isCharPersonalizing) {
            textEl.classList.add('gradient-text');
            textEl.style.backgroundImage = settings.gradientText;
        } else {
            textEl.style.color = settings.textColor;
        }
        if (settings.textStyle === 'glow') {
            textEl.classList.add('text-style-glow');
        }
    }

    // Always render with spans to handle effects and colors robustly
    chars.forEach((char, index) => {
        const span = document.createElement('span');
        span.textContent = char === ' ' ? '\u00A0' : char; // Use non-breaking space
        span.style.display = 'inline-block';

        if (hasValidCharSettings) {
            if (settings.charColors[index]) {
                span.style.color = settings.charColors[index];
                if (settings.textStyle === 'glow') {
                    span.style.textShadow = `0 0 8px ${settings.charColors[index]}, 0 0 12px ${settings.charColors[index]}`;
                }
            }
            const charEffect = settings.charEffects[index];
            if (charEffect && charEffect !== 'none') {
                if (charEffect === 'blink') {
                    span.style.animation = 'blink-effect 1s step-end infinite';
                } else if (charEffect === 'jump') {
                    span.style.animation = `jump-effect ${settings.jumpFrequency}s ease-in-out infinite`;
                }
            }
        } else {
             // Apply global effect if not in personalization mode
            let effectAnimation = '';
            if (settings.textEffect !== 'none') {
                if (settings.textEffect === 'blink') {
                    effectAnimation = 'blink-effect 1s step-end infinite';
                } else if (settings.textEffect === 'jump') {
                    effectAnimation = `jump-effect ${settings.jumpFrequency}s ease-in-out infinite`;
                }
            }
            span.style.animation = effectAnimation;
        }
        
        textEl.appendChild(span);
    });
   
    let finalFontSize = 100;
    const isVertical = ['marquee-up', 'marquee-down'].includes(settings.scrollDirection);
   
    switch(settings.fontSizeMode){
      case 'fitHeight': {
        const hasNewline = settings.text.includes('\n');
        textEl.style.whiteSpace = hasNewline ? 'pre' : 'nowrap';
        
        let low = 1, high = 2000, bestSize = 10;
        const targetHeight = containerEl.clientHeight * (settings.fontSize / 100);

        for (let i = 0; i < 12; i++) {
            let mid = Math.floor((low + high) / 2);
            if (mid === 0) break; 
            textEl.style.fontSize = mid + 'px';
            if (textEl.scrollHeight <= targetHeight) {
                bestSize = mid;
                low = mid + 1;
            } else {
                high = mid - 1;
            }
        }
        finalFontSize = bestSize;
        break;
      }
     
      case 'fitWidth': {
        const hasNewline = settings.text.includes('\n');
        textEl.style.whiteSpace = hasNewline ? 'pre' : 'nowrap';
       
        let low = 1, high = 2000, bestSize = 10;
        for(let i=0; i<10; i++){
          let mid = Math.floor((low + high) / 2);
          textEl.style.fontSize = mid + 'px';
         
          let fits = textEl.scrollWidth <= containerEl.clientWidth;
          if (hasNewline) {
            fits = fits && (textEl.scrollHeight <= containerEl.clientHeight);
          }
         
          if(fits) {
            bestSize = mid;
            low = mid + 1;
          } else {
            high = mid - 1;
          }
        }
        finalFontSize = bestSize;
        break;
      }
      case 'multiline': {
        textEl.style.whiteSpace = 'pre-wrap';
        let low = 1, high = 2000, bestSize = 10;
        for(let i=0; i<10; i++){
          let mid = Math.floor((low + high) / 2);
          textEl.style.fontSize = mid + 'px';
          if(textEl.scrollHeight <= containerEl.clientHeight && textEl.scrollWidth <= containerEl.clientWidth) {
            bestSize = mid;
            low = mid + 1;
          } else {
            high = mid - 1;
          }
        }
        finalFontSize = bestSize;
        break;
      }

      default: // 'fixed' mode
        textEl.style.whiteSpace = 'pre';
        finalFontSize = isPreview ? Math.min(Number(settings.fixedFontSize) || 80, containerEl.clientHeight * 0.8) : (Number(settings.fixedFontSize) || 80);
        break;
    }
   
    root.style.setProperty('--font-size', `${finalFontSize}px`);
   
    // Scroll animation is applied to the parent container
    if (settings.scrollDirection !== 'none') {
      textEl.style.animation = `${settings.scrollDirection} ${settings.scrollSpeed}s linear infinite`;
    }

    // --- Layout Logic ---
    // Reset first
    wrapperEl.style.alignItems = '';
    wrapperEl.style.justifyContent = '';
    textEl.style.textAlign = '';
    textEl.style.width = '';
    textEl.style.padding = '';
    textEl.style.boxSizing = '';

    if (isVertical) {
        textEl.style.whiteSpace = settings.text.includes('\n') ? 'pre' : 'nowrap'; // Respect newlines, otherwise single line
        wrapperEl.style.top = '0';
        wrapperEl.style.height = '100%';
        wrapperEl.style.transform = 'none';
        wrapperEl.style.display = 'flex'; 
        wrapperEl.style.justifyContent = 'center';
        textEl.style.width = 'auto'; // Let width be natural for single line
        if (settings.text.includes('\n')) {
          textEl.style.width = '100%'; // Full width to allow wrapping for multiline
          textEl.style.textAlign = 'center';
          textEl.style.padding = '0 1rem'; 
          textEl.style.boxSizing = 'border-box';
        }

    } else {
        // Restore horizontal/none styles
        wrapperEl.style.top = '50%';
        wrapperEl.style.height = 'auto';
        wrapperEl.style.transform = 'translateY(-50%)';
        
        wrapperEl.style.display = settings.scrollDirection === 'none' ? 'flex' : 'block';
        if (settings.scrollDirection === 'none') {
            wrapperEl.style.alignItems = 'center';
            wrapperEl.style.justifyContent = (settings.fontSizeMode === 'fitHeight' && !settings.text.includes('\n')) ? 'flex-start' : 'center';
        }
    }
   
    containerEl.className = containerEl.id === 'display-screen' ? 'display-screen' : 'controller-preview';
    containerEl.style.animation = ''; containerEl.style.backgroundSize = ''; containerEl.style.border = '';
   
    const borderWidthPx = `${borderWidth}px`;
    if (gridBg) gridBg.style.inset = '0px'; if (gap) gap.style.inset = '0px';

    if (settings.backgroundBorder === 'solid') {
      containerEl.classList.add('border-style-solid'); containerEl.style.background = backgroundValue; 
    } else if (settings.backgroundBorder === 'rainbow') {
      containerEl.classList.add('border-style-rainbow'); containerEl.style.background = 'conic-gradient( #ff004e, #ffe848, #00ffef, #0047ff, #ff004e )';
      if (gridBg) gridBg.style.inset = borderWidthPx; if (gap) gap.style.inset = borderWidthPx;
    } else { containerEl.style.background = backgroundValue; }

    const effSize = Number.isFinite(Number(settings.gridSize)) ? Number(settings.gridSize) : 20;
    const gridSizePx = (isPreview ? Math.max(4, Math.min(120, Math.round(effSize / 2))) : Math.max(4, Math.min(120, effSize))) + 'px';
    root.style.setProperty('--grid-size', gridSizePx);
   
    const isGridEnabled = settings.gridStyle && settings.gridStyle !== 'none';
    if (gridBg) {
        if (isGridEnabled) {
            gridBg.style.display = 'block';
            root.style.setProperty('--grid-mask-image', `url("data:image/svg+xml;utf8,${encodeURIComponent(gridMaskSVG(settings.gridStyle))}")`);
            gridBg.style.background = (settings.gridColorMode === 'gradient') ? settings.gradientGrid : settings.gridColor;
        } else { gridBg.style.display = 'none'; }
    }
    if (gap) {
        if (isGridEnabled && settings.textBlendMode === 'multiply') {
            gap.style.display = 'block';
            root.style.setProperty('--gap-mask-image', `url("data:image/svg+xml;utf8,${encodeURIComponent(gapMaskSVG(settings.gridStyle))}")`);
        } else { gap.style.display = 'none'; }
    }
    if (bgEffectEl) { bgEffectEl.innerHTML = (settings.backgroundEffect === 'eyes') ? `<div class="eye"><div class="pupil"></div></div><div class="eye"><div class="pupil"></div></div>` : ''; }
  }

  function setupDisplayListeners(){
    const info = document.getElementById('info-overlay');
    document.getElementById('display-view').addEventListener('click',(e)=>{ if (!e.target.closest('#fullscreen-btn') && !e.target.closest('#info-overlay')) info.classList.toggle('opacity-0'); });
    setTimeout(()=>info.classList.add('opacity-0'), 5000);
    document.getElementById('fullscreen-btn').addEventListener('click', ()=>{ if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); });
  }

  async function startDisplayMode(sessionId){
    currentSessionId = sessionId; showView('display');
    const displayEls = { textEl: document.getElementById('marquee-text'), containerEl: document.getElementById('display-screen'), wrapperEl: document.getElementById('marquee-container-wrapper'), bgEffectEl: document.getElementById('background-effects-container') };
    applySettings(displayEls, defaultSettings);
    document.getElementById('session-id-display').textContent = sessionId;
    const url = `${window.location.href.split('?')[0]}?controller=${sessionId}`;
    new QRCode(document.getElementById("qrcode-container"), { text:url, width:128, height:128 });
    const ref = doc(db,"sessions",sessionId);
    try{
      const snap = await getDoc(ref);
      if (!snap.exists()) await setDoc(ref, defaultSettings);
      listenToChanges(sessionId, displayEls);
    }catch(e){ console.error('Firestore 讀寫失敗', e); }
    setupDisplayListeners();
  }

  function listenToChanges(sessionId, displayEls){
    if (unsubscribe) unsubscribe();
    const ref = doc(db,"sessions",sessionId);
    unsubscribe = onSnapshot(ref, (docSnap)=>{
      const settings = docSnap.exists() ? { ...defaultSettings, ...docSnap.data() } : defaultSettings;
      applySettings(displayEls, settings);
    }, (error)=>{ console.error('onSnapshot 監聽錯誤', error); });
  }

  async function startControllerMode(sessionId){
    currentSessionId = sessionId; showView('controller');
    document.getElementById('controller-session-id').textContent = sessionId;
    createPickers();
    const ref = doc(db,"sessions",sessionId);
    const snap = await getDoc(ref);
    let settings = snap.exists() ? { ...defaultSettings, ...snap.data() } : defaultSettings;
    if (!snap.exists()) await setDoc(ref, defaultSettings);
    Object.assign(controllerState, { 
      textColorMode: settings.textColorMode, 
      bgColorMode: settings.bgColorMode, 
      gridColorMode: settings.gridColorMode,
      charColors: settings.charColors || [],
      charEffects: settings.charEffects || []
    });
    gridSizeState = Number(settings.gridSize) || 20;
   
    fillHeightPercentage = settings.fontSize || 95;
    fixedFontSize = settings.fixedFontSize || 100;
    currentFontSizeMode = settings.fontSizeMode || 'fitHeight';

    updateControllerUI(settings);
    updatePreview(settings);
    updateColorTab('color-tab', 'solid'); 
    updateColorTab('grid-color-tab', 'solid');
    setupControllerListeners();
  }
  
  function updateFontSizeUI(mode) {
      const fitHeightControls = document.getElementById('fit-height-controls');
      const fixedSizeControls = document.getElementById('fixed-size-controls');
      
      // 先全部隱藏
      fitHeightControls.classList.add('hidden');
      fixedSizeControls.classList.add('hidden');

      // 根據模式顯示對應的選項
      if (mode === 'fitHeight') {
          fitHeightControls.classList.remove('hidden');
          const slider = document.getElementById('fit-height-slider');
          slider.value = fillHeightPercentage;
          document.getElementById('fit-height-value').textContent = fillHeightPercentage;
      } else if (mode === 'fixed') {
          fixedSizeControls.classList.remove('hidden');
          const slider = document.getElementById('fixed-size-slider');
          slider.value = fixedFontSize;
          document.getElementById('fixed-size-value').textContent = fixedFontSize;
      }
  }

  function updateControlsVisibility(settings) {
    // Jump controls
    const showJumpControls = (settings.textEffect === 'jump' && !settings.isCharPersonalizing) || settings.isCharPersonalizing;
    document.getElementById('jump-controls-section').classList.toggle('hidden', !showJumpControls);

    // Outline color section
    document.getElementById('outline-color-section').classList.toggle('hidden', settings.textStyle !== 'outline');

    // Grid controls
    const gridOn = settings.gridStyle && settings.gridStyle !== 'none';
    document.getElementById('grid-advanced-section').classList.toggle('hidden', !gridOn);
    document.getElementById('gap-controls').classList.toggle('hidden', !(gridOn && settings.textBlendMode === 'multiply'));

    // Border controls
    document.getElementById('border-controls-section').classList.toggle('hidden', !(settings.backgroundBorder && settings.backgroundBorder !== 'none'));
  }


  function updateControllerUI(settings){
    document.getElementById('text-input').value = settings.text;
    document.getElementById('speed-slider').value = settings.scrollSpeed;
    document.getElementById('speed-value').textContent = settings.scrollSpeed;
    document.getElementById('char-personalization-toggle').checked = !!settings.isCharPersonalizing;
   
    // 初始化時，使用settings的值更新狀態，然後用新的UI函數來設定UI
    fillHeightPercentage = settings.fontSize;
    fixedFontSize = settings.fixedFontSize;
    updateFontSizeUI(settings.fontSizeMode);
   
    document.getElementById('border-width-slider').value = settings.borderWidth;
    document.getElementById('border-width-value').textContent = settings.borderWidth;
    document.getElementById('border-radius-slider').value = settings.borderRadius;
    document.getElementById('border-radius-value').textContent = settings.borderRadius;
   
    document.getElementById('grid-size-slider').value = gridSizeState;
    document.getElementById('grid-size-value').textContent = gridSizeState;

    updatePickerState('text-color-picker', settings.textColor, 'color');
    updatePickerState('bg-color-picker', settings.backgroundColor, 'color');
    updatePickerState('grid-color-picker', settings.gridColor, 'color');
    updatePickerState('text-gradient-picker', settings.gradientText, 'gradient');
    updatePickerState('bg-gradient-picker', settings.gradientBg, 'gradient');
    updatePickerState('grid-gradient-picker', settings.gradientGrid, 'gradient');
    updatePickerState('gap-color-picker', settings.gapColor, 'color');
    updatePickerState('outline-color-picker', settings.outlineColor, 'color');
    updateButtonGroupState('.direction-btn','direction', settings.scrollDirection);
    updateButtonGroupState('.grid-style-btn','grid', settings.gridStyle);
    updateButtonGroupState('.text-style-btn','style', settings.textStyle);
    updateButtonGroupState('.border-style-btn','border', settings.backgroundBorder);
    updateButtonGroupState('.font-mode-btn','mode', settings.fontSizeMode);
    updateButtonGroupState('.font-btn', 'font', settings.fontFamily);
    updateButtonGroupState('.bg-effect-btn','effect', settings.backgroundEffect);
    updateButtonGroupState('.blend-mode-btn','blend', settings.textBlendMode);
    updateButtonGroupState('.text-effect-btn', 'effect', settings.textEffect || 'none');
    
    document.getElementById('jump-amplitude-slider').value = settings.jumpAmplitude;
    document.getElementById('jump-amplitude-value').textContent = settings.jumpAmplitude;
    document.getElementById('jump-frequency-slider').value = settings.jumpFrequency;
    document.getElementById('jump-frequency-value').textContent = settings.jumpFrequency;
   
    togglePersonalizationUI(settings.isCharPersonalizing, settings.text);
    updateControlsVisibility(settings);
  }

  function togglePersonalizationUI(isActive, text) {
      document.getElementById('char-editor-wrapper').classList.toggle('hidden', !isActive);
      
      // Disable global controls when personalizing
      document.getElementById('global-color-wrapper').classList.toggle('control-disabled', isActive);
      document.getElementById('global-text-effect-wrapper').classList.toggle('control-disabled', isActive);
      document.querySelector('[data-style="dotted"]').classList.toggle('control-disabled', isActive);
      document.querySelector('[data-style="rainbow"]').classList.toggle('control-disabled', isActive);
     
      if (isActive) {
          renderPersonalizationSelector(text);
          // Unset global styles/effects that conflict
          const currentStyle = document.querySelector('.text-style-btn.bg-indigo-600')?.dataset.style;
          if (currentStyle === 'dotted' || currentStyle === 'rainbow') {
              updateButtonGroupState('.text-style-btn', 'style', 'normal');
          }
          const currentGlobalEffect = document.querySelector('.text-effect-btn.bg-indigo-600')?.dataset.effect;
          if (currentGlobalEffect !== 'none') {
              updateButtonGroupState('.text-effect-btn', 'effect', 'none');
          }
      }
  }


  function renderPersonalizationSelector(text) {
      const selector = document.getElementById('char-personalization-selector');
      selector.innerHTML = '';
      selectedCharIndices.clear();
      const chars = Array.from(text);

      if (controllerState.charColors.length !== chars.length) {
          controllerState.charColors = new Array(chars.length).fill(null);
      }
      if (controllerState.charEffects.length !== chars.length) {
          controllerState.charEffects = new Array(chars.length).fill(null);
      }

      chars.forEach((char, index) => {
          const btn = document.createElement('button');
          btn.className = 'char-btn p-1 rounded-md bg-gray-800 text-white font-mono';
          btn.textContent = char;
          btn.dataset.index = index;
          
          if (controllerState.charColors[index]) {
            btn.style.backgroundColor = controllerState.charColors[index];
          }

          const effect = controllerState.charEffects[index];
          if (effect && effect !== 'none') {
              const indicator = document.createElement('div');
              indicator.className = 'effect-indicator';
              btn.appendChild(indicator);
          }
          
          btn.addEventListener('click', () => {
              btn.classList.toggle('char-btn-active');
              if (selectedCharIndices.has(index)) {
                  selectedCharIndices.delete(index);
              } else {
                  selectedCharIndices.add(index);
              }
          });
          selector.appendChild(btn);
      });
  }
  
  function setupControllerListeners(){
    const debouncedInputs = ['text-input', 'speed-slider', 'gap-alpha-slider', 'border-width-slider', 'border-radius-slider', 'grid-size-slider', 'jump-amplitude-slider', 'jump-frequency-slider'];
    debouncedInputs.forEach(id => {
        const el = document.getElementById(id);
        el && el.addEventListener('input', (e) => {
            const value = e.target.value;
            switch (id) {
                case 'text-input':
                    if (document.getElementById('char-personalization-toggle').checked) {
                        controllerState.charColors = new Array(value.length).fill(null);
                        controllerState.charEffects = new Array(value.length).fill(null);
                        renderPersonalizationSelector(value);
                    }
                    break;
                 case 'speed-slider': document.getElementById('speed-value').textContent = value; break;
                 case 'border-width-slider': document.getElementById('border-width-value').textContent = value; break;
                 case 'border-radius-slider': document.getElementById('border-radius-value').textContent = value; break;
                 case 'grid-size-slider': document.getElementById('grid-size-value').textContent = value; gridSizeState = value; break;
                 case 'gap-alpha-slider': document.getElementById('gap-alpha-value').textContent = parseFloat(value).toFixed(2); break;
                 case 'jump-amplitude-slider': document.getElementById('jump-amplitude-value').textContent = value; break;
                 case 'jump-frequency-slider': document.getElementById('jump-frequency-value').textContent = parseFloat(value).toFixed(1); break;
            }
            updateSessionDebounced();
        });
    });

    document.getElementById('fit-height-slider').addEventListener('input', (e) => {
        fillHeightPercentage = Number(e.target.value);
        document.getElementById('fit-height-value').textContent = fillHeightPercentage;
        updateSessionDebounced();
    });
    document.getElementById('fixed-size-slider').addEventListener('input', (e) => {
        fixedFontSize = Number(e.target.value);
        document.getElementById('fixed-size-value').textContent = fixedFontSize;
        updateSessionDebounced();
    });
   
    document.getElementById('char-personalization-toggle').addEventListener('change', (e) => {
        const isActive = e.target.checked;
        togglePersonalizationUI(isActive, document.getElementById('text-input').value);
        updateSession();
    });


    // --- 字體模式按鈕的專屬事件處理 ---
    document.querySelectorAll('.font-mode-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const target = e.currentTarget;
            const newMode = target.dataset.mode;
            currentFontSizeMode = newMode;
            if (newMode === 'fitHeight') {
                fillHeightPercentage = 95;
            }
            updateFontSizeUI(newMode);
            document.querySelectorAll('.font-mode-btn').forEach(b => b.classList.replace('bg-indigo-600', 'bg-gray-700'));
            target.classList.replace('bg-gray-700', 'bg-indigo-600');
            updateSession();
        });
    });

    // --- 其他一般按鈕群組的事件處理 ---
    document.querySelectorAll('.direction-btn, .grid-style-btn, .text-style-btn, .border-style-btn, .bg-effect-btn, .blend-mode-btn, .font-btn, .text-effect-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const target = e.currentTarget;
            if (target.classList.contains('control-disabled')) return;
            
            const group = target.classList[0];
            document.querySelectorAll(`.${group}`).forEach(b => b.classList.replace('bg-indigo-600', 'bg-gray-700'));
            target.classList.replace('bg-gray-700', 'bg-indigo-600');
            
            updateSession();
        });
    });


    const setupPicker = (pickerId, mode, stateKey, stateValue) => {
      document.getElementById(pickerId).addEventListener('click', (e) => {
          const el = e.target.closest(`[data-${mode}]`);
          if (el) {
              if (pickerId === 'text-color-picker' || pickerId === 'text-gradient-picker') {
                  document.getElementById('char-personalization-toggle').checked = false;
                  togglePersonalizationUI(false, document.getElementById('text-input').value);
              }

              if (pickerId === 'personal-char-color-picker') {
                  const color = el.dataset[mode];
                  selectedCharIndices.forEach(index => {
                      controllerState.charColors[index] = color;
                  });
                  renderPersonalizationSelector(document.getElementById('text-input').value);
              } else {
                  if (stateKey) controllerState[stateKey] = stateValue;
                  updatePickerState(pickerId, el.dataset[mode], mode);
              }
              updateSession();
          }
      });
    };
    setupPicker('text-color-picker', 'color', 'textColorMode', 'solid');
    setupPicker('bg-color-picker', 'color', 'bgColorMode', 'solid');
    setupPicker('grid-color-picker', 'color', 'gridColorMode', 'solid');
    setupPicker('gap-color-picker', 'color');
    setupPicker('outline-color-picker', 'color');
    setupPicker('text-gradient-picker', 'gradient', 'textColorMode', 'gradient');
    setupPicker('bg-gradient-picker', 'gradient', 'bgColorMode', 'gradient');
    setupPicker('grid-gradient-picker', 'gradient', 'gridColorMode', 'gradient');
    setupPicker('personal-char-color-picker', 'color');

    document.getElementById('personal-char-effect-picker').addEventListener('click', (e) => {
        const el = e.target.closest('.personal-char-effect-btn');
        if(el) {
            const effect = el.dataset.effect;
            document.querySelectorAll('#personal-char-effect-picker .personal-char-effect-btn').forEach(b => b.classList.replace('bg-indigo-600', 'bg-gray-700'));
            el.classList.replace('bg-gray-700', 'bg-indigo-600');
            selectedCharIndices.forEach(index => {
                controllerState.charEffects[index] = effect;
            });
            renderPersonalizationSelector(document.getElementById('text-input').value);
            updateSession();
        }
    });

    document.querySelectorAll('#color-tab .tab-btn, #grid-color-tab .grid-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tabGroup = btn.closest('#color-tab, #grid-color-tab');
            const targetMode = btn.dataset.tab;
            updateColorTab(tabGroup.id, targetMode);
        });
    });
  }

  function getSettings(){
    const settings = {
      text: document.getElementById('text-input').value,
      fontSizeMode: currentFontSizeMode,
      scrollSpeed: document.getElementById('speed-slider').value,
      isCharPersonalizing: document.getElementById('char-personalization-toggle').checked,
      charColors: controllerState.charColors,
      charEffects: controllerState.charEffects,
      borderWidth: document.getElementById('border-width-slider').value,
      borderRadius: document.getElementById('border-radius-slider').value,
      textColorMode: controllerState.textColorMode,
      bgColorMode: controllerState.bgColorMode,
      gridColorMode: controllerState.gridColorMode,
      textColor: document.querySelector('#text-color-picker .control-btn-active')?.dataset.color || defaultSettings.textColor,
      backgroundColor: document.querySelector('#bg-color-picker .control-btn-active')?.dataset.color || defaultSettings.backgroundColor,
      gridColor: document.querySelector('#grid-color-picker .control-btn-active')?.dataset.color || defaultSettings.gridColor,
      gradientText: document.querySelector('#text-gradient-picker .control-btn-active')?.dataset.gradient || defaultSettings.gradientText,
      gradientBg: document.querySelector('#bg-gradient-picker .control-btn-active')?.dataset.gradient || defaultSettings.gradientBg,
      gradientGrid: document.querySelector('#grid-gradient-picker .control-btn-active')?.dataset.gradient || defaultSettings.gradientGrid,
      gapColor: document.querySelector('#gap-color-picker .control-btn-active')?.dataset.color || defaultSettings.gapColor,
      gapAlpha: document.getElementById('gap-alpha-slider') ? parseFloat(document.getElementById('gap-alpha-slider').value) : 1,
      outlineColor: document.querySelector('#outline-color-picker .control-btn-active')?.dataset.color || defaultSettings.outlineColor,
      textStyle: document.querySelector('.text-style-btn.bg-indigo-600')?.dataset.style || 'normal',
      backgroundBorder: document.querySelector('.border-style-btn.bg-indigo-600')?.dataset.border || 'none',
      backgroundEffect: document.querySelector('.bg-effect-btn.bg-indigo-600')?.dataset.effect || 'none',
      gridStyle: document.querySelector('.grid-style-btn.bg-indigo-600')?.dataset.grid || 'none',
      gridSize: gridSizeState,
      scrollDirection: document.querySelector('.direction-btn.bg-indigo-600')?.dataset.direction || 'none',
      textBlendMode: document.querySelector('.blend-mode-btn.bg-indigo-600')?.dataset.blend || 'normal',
      fontFamily: document.querySelector('.font-btn.bg-indigo-600')?.dataset.font || defaultSettings.fontFamily,
      fontSize: fillHeightPercentage,
      fixedFontSize: fixedFontSize,
      textEffect: document.querySelector('.text-effect-btn.bg-indigo-600')?.dataset.effect || 'none',
      jumpAmplitude: document.getElementById('jump-amplitude-slider').value,
      jumpFrequency: document.getElementById('jump-frequency-slider').value,
    };
    return settings;
  }


  let updateTimeout;

  function updateSession() { 
      clearTimeout(updateTimeout);
      const settings = getSettings();
      updateControlsVisibility(settings);
      updatePreview(settings);
      if (currentSessionId) { 
          setDoc(doc(db,"sessions",currentSessionId), { ...settings, updatedAt: serverTimestamp() }, { merge:true });
      }
  }
 
  function updateSessionDebounced() {
    clearTimeout(updateTimeout);
    updateTimeout = setTimeout(updateSession, 200);
  }

  function updatePreview(settings){
    applySettings({ textEl: document.getElementById('preview-marquee-text'), containerEl: document.getElementById('controller-preview'), wrapperEl: document.getElementById('preview-marquee-container-wrapper') }, settings, true);
  }
  
  function createCustomColorInput(pickerId, settingsKey, stateKey = null) {
      const picker = document.getElementById(pickerId);
      const inputWrap = document.createElement('div');
      inputWrap.className = "w-8 h-8 rounded-full flex items-center justify-center border-2 border-gray-600 overflow-hidden cursor-pointer";
      const colorInput = document.createElement('input');
      colorInput.type = "color";
      colorInput.className = "w-12 h-12 cursor-pointer border-none -translate-x-2 -translate-y-2";
      colorInput.value = "#5588dd";
      colorInput.title = "自選色碼";

      colorInput.addEventListener('input', e => {
          const color = e.target.value;
          inputWrap.dataset.color = color;
          picker.querySelectorAll('div').forEach(div => div.classList.remove('control-btn-active'));
          inputWrap.classList.add('control-btn-active');
          
          if(pickerId === 'personal-char-color-picker'){
             selectedCharIndices.forEach(index => {
                controllerState.charColors[index] = color;
             });
             renderPersonalizationSelector(document.getElementById('text-input').value);
          } else {
              if (stateKey) {
                controllerState[stateKey] = 'solid';
              }
              document.getElementById('char-personalization-toggle').checked = false;
              togglePersonalizationUI(false, document.getElementById('text-input').value);
          }
          updateSession();
      });
      inputWrap.appendChild(colorInput);
      return inputWrap;
  }

  function createPickers(){
    const create = (id, palette, isGradient=false, hasCustomPicker=false)=>{
      const picker = document.getElementById(id); if (!picker) return; picker.innerHTML='';
      
      if(hasCustomPicker) {
        let settingsKey, stateKey = null;
        if(id.includes('text-color')) { settingsKey = 'textColor'; stateKey = 'textColorMode'; }
        if(id.includes('bg-color')) { settingsKey = 'backgroundColor'; stateKey = 'bgColorMode'; }
        if(id.includes('grid-color')) { settingsKey = 'gridColor'; stateKey = 'gridColorMode'; }
        if(id.includes('gap-color')) { settingsKey = 'gapColor'; }
        if(id.includes('outline-color')) { settingsKey = 'outlineColor'; }
        
        picker.appendChild(createCustomColorInput(id, settingsKey, stateKey));
      }

      palette.forEach((value)=>{
        const el = document.createElement('div');
        el.className = 'w-8 h-8 rounded-full cursor-pointer border-2 border-gray-600';
        el.style.background = value;
        if (isGradient) el.dataset.gradient = value; else el.dataset.color = value;
        picker.appendChild(el);
      });
    };
    
    create('text-color-picker', solid16, false, true);
    create('bg-color-picker', bgSolid16, false, true);
    create('grid-color-picker', gridSolid16, false, true);
    create('gap-color-picker', gapSolid16, false, true);
    create('outline-color-picker', outlineSolid, false, true);
    
    create('text-gradient-picker', gradients16, true);
    create('bg-gradient-picker', bgGradients16, true);
    create('grid-gradient-picker', gridGradients16, true);
    create('personal-char-color-picker', solid16, false, true); 
  }

  function updatePickerState(id, activeValue, prop){
    let found = false;
    document.querySelectorAll(`#${id} > div`).forEach(div=>{
      const isActive = div.dataset[(prop||'color')] === activeValue;
      div.classList.toggle('control-btn-active', isActive);
      if(isActive) found = true;
    });

    // If activeValue not in swatches, maybe it's a custom color
    if (!found && activeValue && !activeValue.startsWith('linear-gradient')) {
        const customPickerInput = document.querySelector(`#${id} input[type=color]`);
        if (customPickerInput) {
            customPickerInput.value = activeValue;
            customPickerInput.parentElement.classList.add('control-btn-active');
            customPickerInput.parentElement.dataset.color = activeValue;
        }
    }
  }
  function updateButtonGroupState(selector, dataAttr, value){
    document.querySelectorAll(selector).forEach(btn=>{
      const isActive = btn.dataset[dataAttr] === String(value);
      btn.classList.toggle('bg-indigo-600', isActive);
      btn.classList.toggle('bg-gray-700', !isActive);
    });
  }
  function updateColorTab(tabGroupId, activeTab){
    const isMainColorTab = tabGroupId === 'color-tab';
    const solidPanel = document.getElementById(isMainColorTab ? 'solid-color-panel' : 'grid-solid-color-panel');
    const gradientPanel = document.getElementById(isMainColorTab ? 'gradient-color-panel' : 'grid-gradient-color-panel');
    if(solidPanel) solidPanel.style.display = activeTab!=='solid' ? 'none' : 'block';
    if(gradientPanel) gradientPanel.style.display = activeTab!=='gradient' ? 'none' : 'block';
    document.querySelectorAll(`#${tabGroupId} button`).forEach(btn=>{
      btn.classList.toggle('border-indigo-500', btn.dataset.tab===activeTab);
      btn.classList.toggle('text-white', btn.dataset.tab===activeTab);
      btn.classList.toggle('border-transparent', btn.dataset.tab!==activeTab);
      btn.classList.toggle('text-gray-400', btn.dataset.tab!==activeTab);
    });
  }

  document.getElementById('create-display-btn').addEventListener('click', ()=>{ window.location.href = `${window.location.href.split('?')[0]}?display=${generateId()}`; });
  document.getElementById('open-controller-btn').addEventListener('click', ()=>{ const id = document.getElementById('session-id-input').value.trim().toUpperCase(); if (id) window.location.href = `${window.location.href.split('?')[0]}?controller=${id}`; else alert('請輸入面板 ID'); });
</script>
</body>
</html>

