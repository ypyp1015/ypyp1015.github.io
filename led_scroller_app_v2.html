<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>遠端遙控 LED 跑馬燈 v20.6.3（UI微調＋緊密網格）</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
  html, body { height:100%; margin:0; padding:0; background:#0f172a; }
  body { font-family:'Inter','微軟正黑體',sans-serif; overscroll-behavior:none; }
  .led-font { font-family:'DotGothic16',sans-serif; }

  @keyframes marquee-left { from{ transform:translateX(100vw);} to{ transform:translateX(-100%);} }
  @keyframes marquee-right{ from{ transform:translateX(-100%);} to{ transform:translateX(100vw);} }
  @keyframes blink-effect { 50%{ opacity:0; } }
  @keyframes eye-blink-anim { 0%,40%,100%{ transform:scaleY(1);} 42%{ transform:scaleY(0.1);} }
  @keyframes eye-move-anim { 0%,20%{ transform:translateX(0);} 30%,50%{ transform:translateX(-10px);} 60%,80%{ transform:translateX(10px);} 90%,100%{ transform:translateX(0);} }
  @keyframes rainbow-border-anim { 0%{background-position:0% 50%;} 50%{background-position:100% 50%;} 100%{background-position:0% 50%;} }

  .marquee-text{
    font-size:var(--font-size,80px);
    color:var(--text-color,#FFFFFF);
    white-space:nowrap;
    display:inline-block;
    line-height:1.1;
    position:relative;
    z-index:1;
    transition: color .2s, background-color .2s, text-shadow .2s;
  }
  .gradient-text{
    background-clip:text;
    -webkit-background-clip:text;
    color:transparent !important;
    -webkit-text-fill-color:transparent; /* 確保漸層填色不被其他 color 覆蓋 */
  }
  .text-style-glow{ text-shadow:0 0 8px var(--text-color,#fff), 0 0 12px var(--text-color,#fff); }
  .text-style-outline{
    text-shadow:
      -2px -2px 0 var(--outline-color),
       2px -2px 0 var(--outline-color),
      -2px  2px 0 var(--outline-color),
       2px  2px 0 var(--outline-color),
      -3px  0   0 var(--outline-color),
       3px  0   0 var(--outline-color),
       0   -3px 0 var(--outline-color),
       0    3px 0 var(--outline-color);
  }

  .display-screen{
    width:100%; height:100%; overflow:hidden; position:relative;
    background:var(--bg-color,#000); box-sizing:border-box;
    isolation:isolate; /* 限制所有混合/遮罩合成於容器內 */
  }
  .marquee-container-wrapper{ position:absolute; top:50%; left:0; width:100%; transform:translateY(-50%); overflow:hidden; z-index:1; }

  /* 底層：網格（圖形本體可見） */
  .grid-bg{
    position:absolute; inset:0; z-index:0; pointer-events:none;
    background: var(--grid-color) !important;
    mask-image: var(--grid-mask-image); -webkit-mask-image: var(--grid-mask-image);
    mask-size: var(--grid-size) var(--grid-size); -webkit-mask-size: var(--grid-size) var(--grid-size);
    mask-position: left top; -webkit-mask-position: left top;
    mask-repeat: repeat; -webkit-mask-repeat: repeat;
  }
  .grid-bg.gradient-grid{ background: var(--grid-gradient); }

  /* 頂層：穿孔覆蓋（孔外顯示 gapColor*gapAlpha） */
  .gap-overlay{
    position:absolute; inset:0; z-index:2; pointer-events:none;
    background: var(--gap-color,#000); opacity: var(--gap-alpha,1);
    mask-image: var(--gap-mask-image); -webkit-mask-image: var(--gap-mask-image);
    mask-size: var(--grid-size) var(--grid-size); -webkit-mask-size: var(--grid-size) var(--grid-size);
    mask-position: left top; -webkit-mask-position: left top;
    mask-repeat: repeat; -webkit-mask-repeat: repeat;
    display:none;
  }

  /* 邊框：僅保留實線；Rainbow Frame 轉移到背景動畫控制 */
  .border-style-solid { border:8px solid white; }

  /* 背景裝飾 */
  #background-effects-container{ position:absolute; inset:0; display:flex; justify-content:center; align-items:center; gap:20px; pointer-events:none; }
  .eye{ width:80px; height:80px; background:#fff; border-radius:50%; position:relative; animation:eye-blink-anim 5s infinite; overflow:hidden; }
  .pupil{ width:40px; height:40px; background:#222; border-radius:50%; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); animation: eye-move-anim 10s infinite; }

  /* Rainbow Frame 背景動畫（改列至背景動畫） */
  .effect-rainbow-frame{ padding:8px; position:relative; box-shadow:0 0 25px rgba(255,100,255,.7); }
  .effect-rainbow-frame::before{
    content:''; position:absolute; inset:0; z-index:-1; margin:-8px;
    background:linear-gradient(45deg,red,orange,yellow,green,blue,indigo,violet,red);
    background-size:400% 400%; animation: rainbow-border-anim 2s linear infinite;
  }

  /* 控制台預覽 */
  .sticky-preview{ position:sticky; top:0; z-index:10; background:#1e293b; padding:1.5rem; margin-left:-1.5rem; margin-right:-1.5rem; }
  .controller-preview{ height:120px; border-radius:.5rem; position:relative; overflow:hidden; background:var(--bg-color,#000); border:1px solid #374151; box-sizing:border-box; }
  .controller-preview .marquee-text{ font-size:var(--font-size,40px) !important; }

  .no-scrollbar::-webkit-scrollbar{ display:none; }
  .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
  .control-btn-active{ box-shadow:0 0 0 3px #4f46e5; }
  .control-disabled{ opacity:.4; pointer-events:none; cursor:not-allowed; }
</style>
</head>
<body class="text-white">
<div id="app-container" class="h-full w-full">
  <!-- 首頁 -->
  <div id="home-view" class="flex flex-col items-center justify-center h-full p-8 text-center bg-gray-900">
    <h1 class="text-5xl font-bold mb-4 led-font">LED Scroller</h1>
    <p class="text-gray-400 mb-12">數位跑馬燈・遠端遙控</p>
    <div class="space-y-4 w-full max-w-xs">
      <button id="create-display-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">建立新的顯示面板</button>
      <p class="text-gray-500">或</p>
      <div class="relative">
        <input type="text" id="session-id-input" placeholder="輸入面板 ID 進入控制台" class="w-full bg-gray-800 border border-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <button id="open-controller-btn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-3 rounded-md">進入</button>
      </div>
    </div>
    <p class="text-gray-600 mt-12 text-sm">提示：在設備 A 建立顯示面板，<br>然後在設備 B 輸入面板 ID 進行遙控。</p>
  </div>

  <!-- 顯示面板 -->
  <div id="display-view" class="hidden h-full w-full">
    <div class="display-screen" id="display-screen">
      <div class="grid-bg"></div>
      <div id="background-effects-container"></div>
      <div class="marquee-container-wrapper" id="marquee-container-wrapper">
        <div class="marquee-text" id="marquee-text"><span>請稍候...</span></div>
      </div>
      <div class="gap-overlay" id="gap-overlay"></div>
    </div>
    <div id="info-overlay" class="absolute top-4 left-4 bg-black bg-opacity-70 p-4 rounded-lg text-white transition-opacity duration-500">
      <p class="text-sm">輕觸螢幕可隱藏/顯示此資訊</p>
      <p id="session-id-display" class="font-mono text-lg my-2 bg-gray-700 px-2 py-1 rounded"></p>
      <div id="qrcode-container" class="p-2 bg-white rounded-md mt-2"></div>
    </div>
    <button id="fullscreen-btn" class="absolute bottom-4 right-4 text-white bg-black bg-opacity-50 p-3 rounded-full hover:bg-opacity-75 transition" aria-label="fullscreen">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
    </button>
  </div>

  <!-- 控制台 -->
  <div id="controller-view" class="hidden h-full w-full bg-gray-800 overflow-y-auto no-scrollbar">
    <div class="p-6 max-w-md mx-auto">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold led-font">控制台</h2>
        <p class="text-sm text-gray-400 font-mono">ID: <span id="controller-session-id"></span></p>
      </div>

      <div class="sticky-preview">
        <label class="block mb-2 text-sm font-medium text-gray-300">效果預覽</label>
        <div class="controller-preview" id="controller-preview">
          <div class="grid-bg"></div>
          <div class="marquee-container-wrapper" id="preview-marquee-container-wrapper">
            <div class="marquee-text" id="preview-marquee-text"></div>
          </div>
          <div class="gap-overlay"></div>
        </div>
      </div>

      <!-- 顯示文字 -->
      <div class="mb-6 mt-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">顯示文字</label>
        <textarea id="text-input" rows="3" class="w-full bg-gray-700 border border-gray-600 text-white text-lg p-2.5 rounded-lg" placeholder="在此輸入文字..."></textarea>
      </div>

      <!-- 上移：字體大小、速度、方向 -->
      <div class="mb-6">
        <label for="font-size-slider" class="block mb-2 text-sm font-medium text-gray-300">字體大小: <span id="font-size-value">80</span>px</label>
        <input id="font-size-slider" type="range" min="10" max="300" value="80" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
      </div>
      <div class="mb-6">
        <label for="speed-slider" class="block mb-2 text-sm font-medium text-gray-300">滾動速度: <span id="speed-value">10</span>s</label>
        <input id="speed-slider" type="range" min="1" max="60" value="10" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
      </div>
      <div class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">滾動方向</label>
        <div class="grid grid-cols-3 gap-3">
          <button data-direction="marquee-left" class="direction-btn p-3 bg-gray-700 rounded-lg">← 向左</button>
          <button data-direction="none" class="direction-btn p-3 bg-indigo-600 rounded-lg">❚❚ 靜止</button>
          <button data-direction="marquee-right" class="direction-btn p-3 bg-gray-700 rounded-lg">向右 →</button>
        </div>
      </div>

      <!-- 色彩/漸層（16色） -->
      <div class="mb-6 p-4 bg-gray-900 rounded-lg">
        <div class="flex border-b border-gray-700 mb-4">
          <div id="color-tab" class="flex -mb-px">
            <button data-tab="solid" class="tab-btn text-white py-2 px-4 border-b-2 border-indigo-500 font-medium">純色</button>
            <button data-tab="gradient" class="tab-btn text-gray-400 py-2 px-4 border-b-2 border-transparent">漸層</button>
          </div>
        </div>
        <div id="solid-color-panel">
          <label class="block mb-2 text-sm font-medium text-gray-300">文字顏色</label>
          <div class="flex flex-wrap gap-3 mb-4" id="text-color-picker"></div>
          <label class="block mb-2 text-sm font-medium text-gray-300">背景顏色</label>
          <div class="flex flex-wrap gap-3" id="bg-color-picker"></div>
        </div>
        <div id="gradient-color-panel" class="hidden">
          <label class="block mb-2 text-sm font-medium text-gray-300">文字漸層</label>
          <div class="flex flex-wrap gap-2 mb-4" id="text-gradient-picker"></div>
          <label class="block mb-2 text-sm font-medium text-gray-300">背景漸層</label>
          <div class="flex flex-wrap gap-2" id="bg-gradient-picker"></div>
        </div>
      </div>

      <!-- 背景網格（預設無） -->
      <div class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">背景網格</label>
        <div class="flex flex-wrap gap-3">
          <button data-grid="none" class="grid-style-btn p-3 bg-indigo-600 rounded-lg text-sm">無</button>
          <button data-grid="dot" class="grid-style-btn p-3 bg-gray-700 rounded-lg text-sm">⚫️ 點狀</button>
          <button data-grid="square" class="grid-style-btn p-3 bg-gray-700 rounded-lg text-sm">⬛️ 方形</button>
          <button data-grid="diamond" class="grid-style-btn p-3 bg-gray-700 rounded-lg text-sm">♦️ 菱形</button>
        </div>
      </div>

      <div id="grid-advanced-section" class="mb-6 space-y-6 hidden">
        <div>
          <label for="grid-size-slider" class="block mb-2 text-sm font-medium text-gray-300">網格大小: <span id="grid-size-value">20</span>px</label>
          <input id="grid-size-slider" type="range" min="5" max="100" value="20" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
        </div>

        <div class="p-4 bg-gray-900 rounded-lg">
          <div class="flex border-b border-gray-700 mb-4">
            <div id="grid-color-tab" class="flex -mb-px">
              <button data-tab="solid" class="grid-tab-btn text-white py-2 px-4 border-b-2 border-indigo-500 font-medium">純色</button>
              <button data-tab="gradient" class="grid-tab-btn text-gray-400 py-2 px-4 border-b-2 border-transparent">漸層</button>
            </div>
          </div>
          <div id="grid-solid-color-panel">
            <label class="block mb-2 text-sm font-medium text-gray-300">網格顏色</label>
            <div class="flex flex-wrap gap-3" id="grid-color-picker"></div>
          </div>
          <div id="grid-gradient-color-panel" class="hidden">
            <label class="block mb-2 text-sm font-medium text-gray-300">網格漸層</label>
            <div class="flex flex-wrap gap-2" id="grid-gradient-picker"></div>
          </div>
        </div>

        <!-- 上移：LED 穿孔（在網格顏色下方） -->
        <div class="p-4 bg-gray-900 rounded-lg">
          <label class="block mb-2 text-sm font-medium text-gray-300">LED穿孔</label>
          <div class="flex flex-wrap gap-3">
            <button data-blend="normal" class="blend-mode-btn p-3 bg-indigo-600 rounded-lg text-sm">關閉</button>
            <button data-blend="multiply" class="blend-mode-btn p-3 bg-gray-700 rounded-lg text-sm">開啟</button>
          </div>
          <div id="gap-controls" class="mt-4 hidden">
            <label class="block mb-2 text-sm font-medium text-gray-300">隙縫顏色</label>
            <div class="flex flex-wrap gap-3" id="gap-color-picker"></div>
            <div class="mt-4">
              <label for="gap-alpha-slider" class="block mb-2 text-sm font-medium text-gray-300">隙縫不透明度: <span id="gap-alpha-value">1.00</span></label>
              <input id="gap-alpha-slider" type="range" min="0.10" max="1.00" step="0.05" value="1.00" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
            </div>
          </div>
        </div>
      </div>

      <!-- 文字風格與閃爍 -->
      <div id="text-style-wrapper" class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">文字風格</label>
        <div class="flex flex-wrap gap-3">
          <button data-style="normal" class="text-style-btn p-3 bg-indigo-600 rounded-lg text-sm">標準</button>
          <button data-style="glow" class="text-style-btn p-3 bg-gray-700 rounded-lg text-sm">✨ 發光</button>
          <button data-style="outline" class="text-style-btn p-3 bg-gray-700 rounded-lg text-sm">✏️ 邊框</button>
        </div>
      </div>
      <div id="outline-color-section" class="mb-6 hidden">
        <label class="block mb-2 text-sm font-medium text-gray-300">邊框顏色</label>
        <div class="flex flex-wrap gap-3" id="outline-color-picker"></div>
      </div>
      <div class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">文字特效</label>
        <div class="flex flex-wrap gap-4">
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="blink-toggle" class="sr-only peer">
            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
            <span class="ml-3 text-sm font-medium text-gray-300">文字閃爍</span>
          </label>
        </div>
      </div>

      <!-- 背景邊框與動畫（移除邊框：彩虹；新增背景動畫：Rainbow Frame） -->
      <div id="border-style-wrapper" class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">背景邊框</label>
        <div class="flex flex-wrap gap-3">
          <button data-border="none" class="border-style-btn p-3 bg-indigo-600 rounded-lg text-sm">無</button>
          <button data-border="solid" class="border-style-btn p-3 bg-gray-700 rounded-lg text-sm">⬜️ 實線</button>
        </div>
      </div>
      <div id="bg-effect-wrapper" class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">背景動畫</label>
        <div class="flex flex-wrap gap-3">
          <button data-effect="none" class="bg-effect-btn p-3 bg-indigo-600 rounded-lg text-sm">無</button>
          <button data-effect="eyes" class="bg-effect-btn p-3 bg-gray-700 rounded-lg text-sm">👀 眼睛</button>
          <button data-effect="rainbow-frame" class="bg-effect-btn p-3 bg-gray-700 rounded-lg text-sm">🌈 Rainbow Frame</button>
        </div>
      </div>

      <div class="mt-8 mb-4">
        <a href="./led_scroller_app_v3.html" class="w-full text-center block bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg">返回首頁</a>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDiXuuIQB9EJQZtW8zYuTByxr-Y5wMpRdc",
    authDomain: "led-run-c168b.firebaseapp.com",
    projectId: "led-run-c168b",
    storageBucket: "led-run-c168b.appspot.com",
    messagingSenderId: "555557259748",
    appId: "1:555557259748:web:7a79d35743bcbadbf11ff1",
    measurementId: "G-7JH5TLX99R"
  };

  let db;
  try { db = getFirestore(initializeApp(firebaseConfig)); } catch(e){ console.error("Firebase 初始化失敗", e); alert("Firebase 連線失敗！"); }

  const homeView = document.getElementById('home-view'),
        displayView = document.getElementById('display-view'),
        controllerView = document.getElementById('controller-view');

  let currentSessionId = null, unsubscribe = null;

  const controllerState = { textColorMode:'solid', bgColorMode:'solid', gridColorMode:'solid' };
  const uiState = { activeColorTab:'solid', activeGridTab:'solid' };

  let gridSizeState = 20;

  // 16色純色與 16 組漸層
  const solid16 = ['#FFFFFF','#000000','#F5F5F5','#1F2937','#EF4444','#F59E0B','#10B981','#3B82F6','#8B5CF6','#EC4899','#14B8A6','#22D3EE','#A3E635','#F97316','#84CC16','#EAB308'];
  const bgSolid16 = ['#000000','#0B1220','#111827','#1F2937','#374151','#4B5563','#6B7280','#9CA3AF','#EF4444','#F59E0B','#10B981','#3B82F6','#8B5CF6','#EC4899','#14B8A6','#F3F4F6'];
  const gridSolid16 = ['#FFD84A','#FFE08A','#F8D24E','#FFB703','#F59E0B','#EAB308','#10B981','#22C55E','#3B82F6','#6366F1','#A855F7','#EC4899','#EF4444','#9333EA','#22D3EE','#A3E635'];

  const gradients16 = [
    'linear-gradient(90deg,#F37335,#FDC830)','linear-gradient(90deg,#2193b0,#6dd5ed)',
    'linear-gradient(90deg,#56ab2f,#a8e063)','linear-gradient(90deg,#e94057,#f27121)',
    'linear-gradient(90deg,#4776E6,#8E54E9)','linear-gradient(90deg,#ff9966,#ff5e62)',
    'linear-gradient(90deg,#00b09b,#96c93d)','linear-gradient(90deg,#f953c6,#b91d73)',
    'linear-gradient(90deg,#00c6ff,#0072ff)','linear-gradient(90deg,#43cea2,#185a9d)',
    'linear-gradient(90deg,#ff7e5f,#feb47b)','linear-gradient(90deg,#36d1dc,#5b86e5)',
    'linear-gradient(90deg,#c471f5,#fa71cd)','linear-gradient(90deg,#f00000,#dc281e)',
    'linear-gradient(90deg,#bdc3c7,#2c3e50)','linear-gradient(90deg,red,orange,yellow,green,blue,indigo,violet)'
  ];
  const bgGradients16 = [
    'linear-gradient(90deg,#0f2027,#203a43,#2c5364)','linear-gradient(90deg,#111827,#000000)',
    'linear-gradient(90deg,#141E30,#243B55)','linear-gradient(90deg,#1e3c72,#2a5298)',
    'linear-gradient(90deg,#4b6cb7,#182848)','linear-gradient(90deg,#000428,#004e92)',
    'linear-gradient(90deg,#3E5151,#DECBA4)','linear-gradient(90deg,#232526,#414345)',
    'linear-gradient(90deg,#5614B0,#DBD65C)','linear-gradient(90deg,#1f4037,#99f2c8)',
    'linear-gradient(90deg,#136a8a,#267871)','linear-gradient(90deg,#373B44,#4286f4)',
    'linear-gradient(90deg,#485563,#29323c)','linear-gradient(90deg,#2C3E50,#4CA1AF)',
    'linear-gradient(90deg,#41295a,#2F0743)','linear-gradient(90deg,#000000,#434343)'
  ];
  const gridGradients16 = [
    'linear-gradient(90deg,#F8D24E,#FFD84A)','linear-gradient(90deg,#ffd166,#fca311)',
    'linear-gradient(90deg,#f6d365,#fda085)','linear-gradient(90deg,#a1ffce,#faffd1)',
    'linear-gradient(90deg,#d4fc79,#96e6a1)','linear-gradient(90deg,#fbd3e9,#bb377d)',
    'linear-gradient(90deg,#84fab0,#8fd3f4)','linear-gradient(90deg,#a18cd1,#fbc2eb)',
    'linear-gradient(90deg,#f093fb,#f5576c)','linear-gradient(90deg,#4facfe,#00f2fe)',
    'linear-gradient(90deg,#fad0c4,#ffd1ff)','linear-gradient(90deg,#ffecd2,#fcb69f)',
    'linear-gradient(90deg,#cfd9df,#e2ebf0)','linear-gradient(90deg,#fddb92,#d1fdff)',
    'linear-gradient(90deg,#fbc2eb,#a6c1ee)','linear-gradient(90deg,#7F7FD5,#86A8E7)'
  ];
  const gapSolid16 = ['#000000','#0B1220','#111827','#1F2937','#374151','#6B7280','#9CA3AF','#FFFFFF','#FFB703','#F59E0B','#22C55E','#3B82F6','#8B5CF6','#EC4899','#22D3EE','#A3E635'];

  const defaultSettings = {
    text: "Hello 👋",
    textColor: "#B96A00",
    backgroundColor: "#000000",
    fontSize: 80,
    scrollSpeed: 10,
    scrollDirection: "none",
    isBlinking: false,

    textColorMode: 'solid',
    bgColorMode: 'solid',
    gridColorMode: 'solid',

    gradientText: gradients16[41],
    gradientBg: bgGradients16[42],
    gradientGrid: gridGradients16,

    textBlendMode: 'normal',     // 預設關閉穿孔
    gapColor: "#000000",
    gapAlpha: 1.0,

    backgroundBorder: "none",    // 邊框只保留 none/solid
    backgroundEffect: "none",    // none | eyes | rainbow-frame

    gridStyle: "none",           // 預設：無
    gridSize: 20,
    gridColor: "#FFD84A",

    outlineColor: "#FF3B30",
    updatedAt: serverTimestamp()
  };

  window.addEventListener('load', ()=>{
    const params = new URLSearchParams(window.location.search);
    if (params.has('display')) startDisplayMode(params.get('display'));
    else if (params.has('controller')) startControllerMode(params.get('controller'));
    else showView('home');
  });

  function showView(name){ [homeView, displayView, controllerView].forEach(v=>v.classList.add('hidden')); document.getElementById(`${name}-view`).classList.remove('hidden'); }
  function generateId(){ return Math.random().toString(36).substring(2,8).toUpperCase(); }

  async function startDisplayMode(sessionId){
    currentSessionId = sessionId; showView('display');
    document.getElementById('session-id-display').textContent = sessionId;
    const url = `${window.location.href.split('?')}?controller=${sessionId}`;
    document.getElementById('qrcode-container').innerHTML = '';
    new QRCode(document.getElementById("qrcode-container"), { text:url, width:128, height:128 });

    const ref = doc(db,"sessions",sessionId);
    if (!(await getDoc(ref)).exists()) await setDoc(ref, defaultSettings);
    listenToChanges(sessionId);
    setupDisplayListeners();
  }

  function listenToChanges(sessionId){
    if (unsubscribe) unsubscribe();
    const ref = doc(db,"sessions",sessionId);
    unsubscribe = onSnapshot(ref, (docSnap)=>{
      if (docSnap.exists()){
        const settings = { ...defaultSettings, ...docSnap.data() };
        applySettings({
          textEl: document.getElementById('marquee-text'),
          containerEl: document.getElementById('display-screen'),
          wrapperEl: document.getElementById('marquee-container-wrapper'),
          bgEffectEl: document.getElementById('background-effects-container')
        }, settings);
      } else {
        document.getElementById('marquee-text').textContent = "此面板ID已失效";
      }
    });
  }

  // 更緊密的遮罩圖磚（減少邊留白）
  function gridMaskSVG(shape){
    if (shape==='square') return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='6' y='6' width='88' height='88' rx='12' ry='12' fill='black'/></svg>`;
    if (shape==='diamond') return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='16' y='16' width='68' height='68' transform='rotate(45 50 50)' fill='black'/></svg>`;
    return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='48' fill='black'/></svg>`;
  }
  function gapMaskSVG(shape){
    if (shape==='square') return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='white' fill-rule='evenodd' d='M0 0H100V100H0Z M6 6H94V94H6Z'/></svg>`;
    if (shape==='diamond') return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='white' fill-rule='evenodd' d='M0 0H100V100H0Z M50 7L93 50 50 93 7 50Z'/></svg>`;
    return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='white' fill-rule='evenodd' d='M0 0H100V100H0Z M50 50 m -48,0 a 48,48 0 1,0 96,0 a 48,48 0 1,0 -96,0 Z'/></svg>`;
  }

  function applySettings(els, settings, isPreview=false){
    const { textEl, containerEl, wrapperEl, bgEffectEl } = els;
    if (!textEl || !containerEl || !wrapperEl) return;

    const root = containerEl;
    root.style.setProperty('--text-color', settings.textColor);
    root.style.setProperty('--outline-color', settings.outlineColor || '#FF3B30');
    root.style.setProperty('--bg-color', settings.backgroundColor);
    root.style.setProperty('--grid-color', settings.gridColor);
    root.style.setProperty('--grid-gradient', settings.gradientGrid);
    root.style.setProperty('--gap-color', settings.gapColor || '#000000');
    root.style.setProperty('--gap-alpha', settings.gapAlpha != null ? settings.gapAlpha : 1);

    const isGridEnabled = settings.gridStyle && settings.gridStyle !== 'none';
    const perforateOn = (settings.textBlendMode==='multiply');

    // 背景
    containerEl.classList.remove('effect-rainbow-frame');
    if (settings.backgroundEffect==='rainbow-frame') containerEl.classList.add('effect-rainbow-frame');
    containerEl.style.background = (settings.bgColorMode==='gradient') ? settings.gradientBg : settings.backgroundColor;

    // 文字（漸層模式堅持 clip-text 以免被 color 覆蓋）
    textEl.textContent = settings.text;
    const fontPx = isPreview ? Math.min(Number(settings.fontSize)||80, containerEl.clientHeight*0.8) : (Number(settings.fontSize)||80);
    textEl.style.fontSize = `${fontPx}px`;
    textEl.className = 'marquee-text';
    if (settings.textColorMode==='gradient'){
      textEl.classList.add('gradient-text');
      textEl.style.backgroundImage = settings.gradientText;
      textEl.style.color = ''; // 不覆蓋漸層
    } else {
      textEl.style.backgroundImage = '';
      textEl.style.color = settings.textColor;
    }
    if ((settings.textStyle||'normal')!=='normal') textEl.classList.add(`text-style-${settings.textStyle}`);

    // 動畫
    let anims = [];
    if (settings.scrollDirection!=='none') anims.push(`${settings.scrollDirection} ${Number(settings.scrollSpeed)||10}s linear infinite`);
    if (settings.isBlinking) anims.push('blink-effect 1s step-end infinite');
    textEl.style.animation = anims.join(', ');

    // 置中
    wrapperEl.style.display = settings.scrollDirection==='none' ? 'flex' : 'block';
    wrapperEl.style.justifyContent = settings.scrollDirection==='none' ? 'center' : '';

    // 即時指定遮罩尺寸（兩層、含 WebKit），確保重繪
    const sizeNum = Number(settings.gridSize);
    const effSize = Number.isFinite(sizeNum) ? sizeNum : gridSizeState || 20;
    const effPreview = isPreview ? Math.max(5, Math.min(100, Math.round(effSize/2))) : Math.max(5, Math.min(100, effSize));
    const gridSizePx = effPreview + 'px';
    const pair = gridSizePx + ' ' + gridSizePx;
    root.style.setProperty('--grid-size', gridSizePx);

    const gridBg = containerEl.querySelector('.grid-bg');
    const gap = containerEl.querySelector('.gap-overlay');

    if (gridBg) {
      if (isGridEnabled){
        gridBg.style.display = 'block';
        gridBg.style.maskSize = pair; gridBg.style.WebkitMaskSize = pair;
        gridBg.style.maskPosition = 'left top'; gridBg.style.WebkitMaskPosition = 'left top';
        root.style.setProperty('--grid-mask-image', `url("data:image/svg+xml;utf8,${encodeURIComponent(gridMaskSVG(settings.gridStyle))}")`);
        if (settings.gridColorMode==='gradient'){
          gridBg.classList.add('gradient-grid');
        } else {
          gridBg.classList.remove('gradient-grid');
          root.style.setProperty('--grid-color', settings.gridColor);
          gridBg.style.background = settings.gridColor;
        }
      } else {
        gridBg.style.display = 'none';
      }
    }

    if (gap) {
      if (isGridEnabled && perforateOn){
        gap.style.display = 'block';
        gap.style.maskSize = pair; gap.style.WebkitMaskSize = pair;
        gap.style.maskPosition = 'left top'; gap.style.WebkitMaskPosition = 'left top';
        root.style.setProperty('--gap-mask-image', `url("data:image/svg+xml;utf8,${encodeURIComponent(gapMaskSVG(settings.gridStyle))}")`);
      } else {
        gap.style.display = 'none';
      }
    }

    // 邊框
    containerEl.className = isPreview ? 'display-screen controller-preview' : 'display-screen';
    if (isGridEnabled) containerEl.classList.add('grid-enabled');
    if (settings.backgroundBorder && settings.backgroundBorder!=='none') containerEl.classList.add(`border-style-${settings.backgroundBorder}`);

    // 背景特效
    if (bgEffectEl){
      if ((settings.backgroundEffect||'none')==='eyes'){
        bgEffectEl.innerHTML = `<div class="eye"><div class="pupil"></div></div><div class="eye"><div class="pupil"></div></div>`;
      } else {
        bgEffectEl.innerHTML = '';
      }
    }
  }

  function setupDisplayListeners(){
    const info = document.getElementById('info-overlay');
    document.getElementById('display-view').addEventListener('click',(e)=>{
      if (!e.target.closest('#fullscreen-btn') && !e.target.closest('#info-overlay')) info.classList.toggle('opacity-0');
    });
    setTimeout(()=>info.classList.add('opacity-0'), 5000);
    document.getElementById('fullscreen-btn').addEventListener('click', ()=>{
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else document.exitFullscreen();
    });
  }

  async function startControllerMode(sessionId){
    currentSessionId = sessionId; showView('controller');
    document.getElementById('controller-session-id').textContent = sessionId;

    createPickers();
    const ref = doc(db,"sessions",sessionId);
    const snap = await getDoc(ref);
    if (snap.exists()){
      const raw = snap.data();
      const loaded = {
        ...defaultSettings, ...raw,
        textColorMode: raw.textColorMode || 'solid',
        bgColorMode: raw.bgColorMode || 'solid',
        gridColorMode: raw.gridColorMode || 'solid',
        textBlendMode: raw.textBlendMode || 'normal',
        gapColor: raw.gapColor || '#000000',
        gapAlpha: typeof raw.gapAlpha==='number' ? raw.gapAlpha : 1.0
      };
      controllerState.textColorMode = loaded.textColorMode;
      controllerState.bgColorMode = loaded.bgColorMode;
      controllerState.gridColorMode = loaded.gridColorMode;
      gridSizeState = Number(loaded.gridSize) || 20;
      updateControllerUI(loaded);
    } else {
      alert("找不到此面板 ID");
      window.location.href = window.location.href.split('?');
      return;
    }
    setupControllerListeners();
  }

  function updateControllerUI(settings){
    document.getElementById('text-input').value = settings.text;
    document.getElementById('font-size-slider').value = settings.fontSize;
    document.getElementById('font-size-value').textContent = settings.fontSize;
    document.getElementById('speed-slider').value = settings.scrollSpeed;
    document.getElementById('speed-value').textContent = settings.scrollSpeed;

    const gsz = Math.max(5, Math.min(100, Number(gridSizeState)||20));
    document.getElementById('grid-size-slider').value = String(gsz);
    document.getElementById('grid-size-value').textContent = String(gsz);
    document.getElementById('blink-toggle').checked = !!settings.isBlinking;

    // 顯示/隱藏進階網格與隙縫
    const gridAdv = document.getElementById('grid-advanced-section');
    const gapCtrls = document.getElementById('gap-controls');
    const gridOn = (settings.gridStyle && settings.gridStyle!=='none');
    gridAdv.classList.toggle('hidden', !gridOn);
    const perforateOn = (settings.textBlendMode==='multiply');
    gapCtrls.classList.toggle('hidden', !(gridOn && perforateOn));

    // 分頁顯示只受 uiState 控制
    updateColorTab('color-tab', uiState.activeColorTab);
    updateColorTab('grid-color-tab', uiState.activeGridTab);

    // 選色 active
    updatePickerState('text-color-picker', settings.textColor, 'color');
    updatePickerState('bg-color-picker', settings.backgroundColor, 'color');
    updatePickerState('grid-color-picker', settings.gridColor, 'color');
    updatePickerState('text-gradient-picker', settings.gradientText, 'gradient');
    updatePickerState('bg-gradient-picker', settings.gradientBg, 'gradient');
    updatePickerState('grid-gradient-picker', settings.gradientGrid, 'gradient');
    updatePickerState('gap-color-picker', settings.gapColor, 'color');
    updatePickerState('outline-color-picker', settings.outlineColor || '#FF3B30', 'color');

    // 群組按鈕
    updateButtonGroupState('.direction-btn','direction', settings.scrollDirection);
    updateButtonGroupState('.grid-style-btn','grid', settings.gridStyle);
    updateButtonGroupState('.border-style-btn','border', settings.backgroundBorder || 'none');
    updateButtonGroupState('.bg-effect-btn','effect', settings.backgroundEffect || 'none');
    document.querySelectorAll('.blend-mode-btn').forEach(b=>{
      b.classList.toggle('bg-indigo-600', b.dataset.blend === (settings.textBlendMode || 'normal'));
      b.classList.toggle('bg-gray-700', b.dataset.blend !== (settings.textBlendMode || 'normal'));
    });

    document.getElementById('outline-color-section').classList.toggle('hidden', (settings.textStyle||'normal')!=='outline');

    updatePreview();
  }

  function setupControllerListeners(){
    // 一般輸入
    ['text-input','font-size-slider','speed-slider','gap-alpha-slider','blink-toggle'].forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener(el.type==='checkbox' ? 'change':'input', updateSession);
    });

    // 網格大小穩健處理
    const gridSlider = document.getElementById('grid-size-slider');
    const syncGridSize = ()=>{
      const raw = gridSlider.value || gridSlider.getAttribute('value');
      let v = parseInt(raw,10);
      if (!Number.isFinite(v)) v = gridSizeState || 20;
      v = Math.max(5, Math.min(100, v));
      gridSizeState = v;
      document.getElementById('grid-size-value').textContent = String(v);
      updateSession();
    };
    ['input','change','pointerup','touchend'].forEach(ev=>gridSlider.addEventListener(ev, syncGridSize));

    // 群組切換
    const group = (sel)=>document.querySelectorAll(sel).forEach(btn=>{
      btn.addEventListener('click',(e)=>{
        document.querySelectorAll(sel).forEach(b=>b.classList.replace('bg-indigo-600','bg-gray-700'));
        e.currentTarget.classList.replace('bg-gray-700','bg-indigo-600');
        updateSession();
      });
    });
    group('.direction-btn'); group('.grid-style-btn'); group('.blend-mode-btn');
    group('.border-style-btn'); group('.bg-effect-btn'); group('.text-style-btn');

    // 選色器
    document.getElementById('text-color-picker').addEventListener('click',(e)=>{ if(e.target.dataset.color){ controllerState.textColorMode='solid'; updatePickerState('text-color-picker', e.target.dataset.color, 'color'); updateSession(); }});
    document.getElementById('bg-color-picker').addEventListener('click',(e)=>{ if(e.target.dataset.color){ controllerState.bgColorMode='solid'; updatePickerState('bg-color-picker', e.target.dataset.color, 'color'); updateSession(); }});
    document.getElementById('grid-color-picker').addEventListener('click',(e)=>{ if(e.target.dataset.color){ controllerState.gridColorMode='solid'; updatePickerState('grid-color-picker', e.target.dataset.color, 'color'); updateSession(); }});
    document.getElementById('gap-color-picker').addEventListener('click',(e)=>{ if(e.target.dataset.color){ updatePickerState('gap-color-picker', e.target.dataset.color, 'color'); updateSession(); }});
    document.getElementById('outline-color-picker').addEventListener('click',(e)=>{ if(e.target.dataset.color){ updatePickerState('outline-color-picker', e.target.dataset.color, 'color'); updateSession(); }});

    document.getElementById('text-gradient-picker').addEventListener('click',(e)=>{ const el=e.target.closest('[data-gradient]'); if(el){ controllerState.textColorMode='gradient'; updatePickerState('text-gradient-picker', el.dataset.gradient, 'gradient'); updateSession(); }});
    document.getElementById('bg-gradient-picker').addEventListener('click',(e)=>{ const el=e.target.closest('[data-gradient]'); if(el){ controllerState.bgColorMode='gradient'; updatePickerState('bg-gradient-picker', el.dataset.gradient, 'gradient'); updateSession(); }});
    document.getElementById('grid-gradient-picker').addEventListener('click',(e)=>{ const el=e.target.closest('[data-gradient]'); if(el){ controllerState.gridColorMode='gradient'; updatePickerState('grid-gradient-picker', el.dataset.gradient, 'gradient'); updateSession(); }});

    // 分頁
    document.querySelectorAll('#color-tab .tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{ uiState.activeColorTab = btn.dataset.tab; updateColorTab('color-tab', uiState.activeColorTab); });
    });
    document.querySelectorAll('#grid-color-tab .grid-tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{ uiState.activeGridTab = btn.dataset.tab; updateColorTab('grid-color-tab', uiState.activeGridTab); });
    });
  }

  function getSettings(){
    const gridOn = document.querySelector('.grid-style-btn.bg-indigo-600')?.dataset.grid !== 'none';
    const perforateSel = document.querySelector('.blend-mode-btn.bg-indigo-600')?.dataset.blend || 'normal';
    return {
      text: document.getElementById('text-input').value,
      fontSize: document.getElementById('font-size-slider').value,
      scrollSpeed: document.getElementById('speed-slider').value,
      isBlinking: document.getElementById('blink-toggle').checked,

      textColorMode: controllerState.textColorMode,
      bgColorMode: controllerState.bgColorMode,
      gridColorMode: controllerState.gridColorMode,

      textColor: document.querySelector('#text-color-picker .control-btn-active')?.dataset.color || defaultSettings.textColor,
      backgroundColor: document.querySelector('#bg-color-picker .control-btn-active')?.dataset.color || defaultSettings.backgroundColor,
      gridColor: document.querySelector('#grid-color-picker .control-btn-active')?.dataset.color || defaultSettings.gridColor,

      gradientText: document.querySelector('#text-gradient-picker .control-btn-active')?.dataset.gradient || defaultSettings.gradientText,
      gradientBg: document.querySelector('#bg-gradient-picker .control-btn-active')?.dataset.gradient || defaultSettings.gradientBg,
      gradientGrid: document.querySelector('#grid-gradient-picker .control-btn-active')?.dataset.gradient || defaultSettings.gradientGrid,

      textBlendMode: perforateSel,                       // 關閉即為 normal
      gapColor: document.querySelector('#gap-color-picker .control-btn-active')?.dataset.color || defaultSettings.gapColor,
      gapAlpha: parseFloat(document.getElementById('gap-alpha-slider')?.value || (defaultSettings.gapAlpha||1)),

      outlineColor: document.querySelector('#outline-color-picker .control-btn-active')?.dataset.color || '#FF3B30',
      textStyle: document.querySelector('.text-style-btn.bg-indigo-600')?.dataset.style || 'normal',
      backgroundBorder: document.querySelector('.border-style-btn.bg-indigo-600')?.dataset.border || 'none',
      backgroundEffect: document.querySelector('.bg-effect-btn.bg-indigo-600')?.dataset.effect || 'none',
      gridStyle: document.querySelector('.grid-style-btn.bg-indigo-600')?.dataset.grid || 'none',
      gridSize: gridOn ? gridSizeState : defaultSettings.gridSize,   // 無網格時保留既有值但不顯示
      scrollDirection: document.querySelector('.direction-btn.bg-indigo-600')?.dataset.direction || 'none'
    };
  }

  let lastSettings = {};
  function updateSession(){
    if (!currentSessionId) { updatePreview(); return; }
    const settings = getSettings();
    const diff = {};
    for (const k in settings){ if (settings[k] !== lastSettings[k]) diff[k] = settings[k]; }
    if (Object.keys(diff).length){
      diff.updatedAt = serverTimestamp();
      setDoc(doc(db,"sessions",currentSessionId), diff, { merge:true });
    }
    lastSettings = settings;
    updateControllerUI(settings);
  }

  function updatePreview(){
    const settings = getSettings();
    applySettings({
      textEl: document.getElementById('preview-marquee-text'),
      containerEl: document.getElementById('controller-preview'),
      wrapperEl: document.getElementById('preview-marquee-container-wrapper')
    }, settings, true);
  }

  function createPickers(){
    const create = (id, palette, isGradient=false)=>{
      const picker = document.getElementById(id); if (!picker) return; picker.innerHTML='';
      palette.forEach((value, i)=>{
        const el = document.createElement('div');
        el.className = 'w-8 h-8 rounded-full cursor-pointer border-2 border-gray-600';
        el.style.background = value;
        if (isGradient) el.dataset.gradient = value; else el.dataset.color = value;
        if (i===0) el.classList.add('control-btn-active');
        picker.appendChild(el);
      });
    };
    create('text-color-picker', solid16);
    create('bg-color-picker', bgSolid16);
    create('grid-color-picker', gridSolid16);
    create('gap-color-picker', gapSolid16);
    create('outline-color-picker', ['#FF3B30','#FFFFFF','#000000','#22C55E','#3B82F6','#F59E0B','#A855F7','#EF4444']);
    create('text-gradient-picker', gradients16, true);
    create('bg-gradient-picker', bgGradients16, true);
    create('grid-gradient-picker', gridGradients16, true);
  }

  function updatePickerState(id, activeValue, prop){
    document.querySelectorAll(`#${id} > div`).forEach(div=>{
      div.classList.toggle('control-btn-active', div.dataset[(prop||'color')]===activeValue);
    });
  }
  function updateButtonGroupState(selector, dataAttr, value){
    document.querySelectorAll(selector).forEach(btn=>{
      btn.classList.toggle('bg-indigo-600', btn.dataset[dataAttr]===value);
      btn.classList.toggle('bg-gray-700', btn.dataset[dataAttr]!==value);
    });
  }
  function updateColorTab(tabGroupId, activeTab){
    const solidPanel = document.getElementById(tabGroupId==='color-tab' ? 'solid-color-panel' : 'grid-solid-color-panel');
    const gradientPanel = document.getElementById(tabGroupId==='color-tab' ? 'gradient-color-panel' : 'grid-gradient-color-panel');
    solidPanel.classList.toggle('hidden', activeTab!=='solid');
    gradientPanel.classList.toggle('hidden', activeTab!=='gradient');
    document.querySelectorAll(`#${tabGroupId} button`).forEach(btn=>{
      btn.classList.toggle('border-indigo-500', btn.dataset.tab===activeTab);
      btn.classList.toggle('text-white', btn.dataset.tab===activeTab);
      btn.classList.toggle('border-transparent', btn.dataset.tab!==activeTab);
      btn.classList.toggle('text-gray-400', btn.dataset.tab!==activeTab);
    });
  }

  document.getElementById('create-display-btn').addEventListener('click', ()=>{
    window.location.href = `${window.location.href.split('?')}?display=${generateId()}`;
  });
  document.getElementById('open-controller-btn').addEventListener('click', ()=>{
    const id = document.getElementById('session-id-input').value.trim().toUpperCase();
    if (id) window.location.href = `${window.location.href.split('?')}?controller=${id}`;
    else alert('請輸入面板 ID');
  });
</script>
</body>
</html>
