<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>é ç«¯é™æ§ LED è·‘é¦¬ç‡ˆ v22.1.41 (FontModeFix)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Noto+Serif+TC:wght@400;700&family=ZCOOL+KuaiLe&family=Cutive+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
  html,body{height:100%;margin:0;padding:0;background:#0f172a}
  body{font-family:'Inter','å¾®è»Ÿæ­£é»‘é«”',sans-serif;overscroll-behavior:none}
  .led-font{font-family:'DotGothic16',sans-serif}
  @keyframes marquee-left{from{transform:translateX(100vw)}to{transform:translateX(-100%)}}
  @keyframes marquee-right{from{transform:translateX(-100%)}to{transform:translateX(100vw)}}
  @keyframes blink-effect{50%{opacity:0}}
  @keyframes eye-blink-anim{0%,40%,100%{transform:scaleY(1)}42%{transform:scaleY(0.1)}}
  @keyframes eye-move-anim{0%,20%{transform:translateX(0)}30%,50%{transform:translateX(-10px)}60%,80%{transform:translateX(10px)}90%,100%{transform:translateX(0)}}
  @keyframes rainbow-border-anim{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  .marquee-text{font-size:var(--font-size,80px);color:var(--text-color,#fff);white-space:nowrap;display:inline-block;line-height:1.1;position:relative;z-index:1;transition:color .2s,background-color .2s,text-shadow .2s}
  .gradient-text{background-clip:text;-webkit-background-clip:text;color:transparent!important;-webkit-text-fill-color:transparent}
  .text-style-glow{text-shadow:0 0 8px var(--text-color,#fff),0 0 12px var(--text-color,#fff)}
  .text-style-outline{-webkit-text-stroke:1.5px var(--outline-color);-webkit-text-fill-color:transparent;paint-order:stroke fill;text-shadow:none!important}
  .text-style-dotted{background-clip:text;-webkit-background-clip:text;color:transparent!important;-webkit-text-fill-color:transparent;background-image:radial-gradient(var(--text-color) 35%,transparent 40%);background-size:3px 3px;text-shadow:none!important;-webkit-text-stroke:0}
  .display-screen{width:100%;height:100%;position:relative;background:var(--bg-color,#000);box-sizing:border-box;isolation:isolate}
  .marquee-container-wrapper{position:absolute;top:50%;left:0;width:100%;transform:translateY(-50%);overflow:hidden;z-index:2}
  .grid-bg{position:absolute;inset:0;z-index:1;pointer-events:none;background:var(--grid-color);mask-image:var(--grid-mask-image);-webkit-mask-image:var(--grid-mask-image);mask-size:var(--grid-size) var(--grid-size);-webkit-mask-size:var(--grid-size) var(--grid-size);mask-position:left top;-webkit-mask-position:left top;mask-repeat:repeat;-webkit-mask-repeat:repeat;border-radius:var(--inner-border-radius,0px)}
  .gap-overlay{position:absolute;inset:0;z-index:3;pointer-events:none;background:var(--gap-color,#000);opacity:var(--gap-alpha,1);mask-image:var(--gap-mask-image);-webkit-mask-image:var(--gap-mask-image);mask-size:var(--grid-size) var(--grid-size);-webkit-mask-size:var(--grid-size) var(--grid-size);mask-position:left top;-webkit-mask-position:left top;mask-repeat:repeat;-webkit-mask-repeat:repeat;display:none;border-radius:var(--inner-border-radius,0px)}
  .border-style-solid{border-style:solid;border-color:#fff;border-width:var(--border-width,8px);border-radius:var(--border-radius,16px)}
  .border-style-rainbow{position:relative;border-radius:var(--border-radius,16px);animation:rainbow-border-anim 3s linear infinite;background-size:200% 200%}
  .border-style-rainbow::after{content:'';position:absolute;inset:var(--border-width,8px);background:var(--bg-color);border-radius:var(--inner-border-radius,8px);z-index:0}
  #background-effects-container{position:absolute;inset:0;display:flex;justify-content:center;align-items:center;gap:20px;pointer-events:none;z-index:1}
  .eye{width:80px;height:80px;background:#fff;border-radius:50%;position:relative;animation:eye-blink-anim 5s infinite;overflow:hidden}
  .pupil{width:40px;height:40px;background:#222;border-radius:50%;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);animation:eye-move-anim 10s infinite}
  .sticky-preview{position:sticky;top:0;z-index:10;background:#1e293b;padding:1.5rem;margin-left:-1.5rem;margin-right:-1.5rem}
  .controller-preview{height:120px;position:relative;background:var(--bg-color,#000);outline:1px solid #374151;box-sizing:border-box;isolation:isolate}
  .controller-preview .marquee-text{font-size:var(--font-size,40px)}
  .no-scrollbar::-webkit-scrollbar{display:none}
  .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
  .control-btn-active{box-shadow:0 0 0 3px #4f46e5}
  .control-disabled{opacity:.4;pointer-events:none;cursor:not-allowed}
  .char-btn{transition:all .2s;border:2px solid transparent}
  .char-btn-active{border-color:#6366f1;transform:scale(1.1);background-color:#4f46e5!important;color:#fff!important}
</style>
</head>
<body class="text-white">
<div id="app-container" class="h-full w-full">
  <div id="home-view" class="flex flex-col items-center justify-center h-full p-8 text-center bg-gray-900">
    <h1 class="text-5xl font-bold mb-4 led-font">LED Scroller</h1>
    <p class="text-gray-400 mb-12">æ•¸ä½è·‘é¦¬ç‡ˆãƒ»é ç«¯é™æ§</p>
    <div class="space-y-4 w-full max-w-xs">
      <button id="create-display-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">å»ºç«‹æ–°çš„é¡¯ç¤ºé¢æ¿</button>
      <p class="text-gray-500">æˆ–</p>
      <div class="relative">
        <input type="text" id="session-id-input" placeholder="è¼¸å…¥é¢æ¿ ID é€²å…¥æ§åˆ¶å°" class="w-full bg-gray-800 border border-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <button id="open-controller-btn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-3 rounded-md">é€²å…¥</button>
      </div>
    </div>
    <p class="text-gray-600 mt-12 text-sm">æç¤ºï¼šåœ¨è¨­å‚™ A å»ºç«‹é¡¯ç¤ºé¢æ¿ï¼Œç„¶å¾Œåœ¨è¨­å‚™ B è¼¸å…¥é¢æ¿ ID é€²è¡Œé™æ§ã€‚</p>
  </div>

  <div id="display-view" class="hidden h-full w-full">
    <div class="display-screen" id="display-screen">
      <div class="grid-bg"></div>
      <div id="background-effects-container"></div>
      <div class="marquee-container-wrapper" id="marquee-container-wrapper">
        <div class="marquee-text" id="marquee-text"><span>è«‹ç¨å€™...</span></div>
      </div>
      <div class="gap-overlay" id="gap-overlay"></div>
    </div>
    <div id="info-overlay" class="absolute top-4 left-4 bg-black bg-opacity-70 p-4 rounded-lg text-white transition-opacity duration-500">
      <p class="text-sm">è¼•è§¸è¢å¹•å¯éš±è—/é¡¯ç¤ºæ­¤è³‡è¨Š</p>
      <p id="session-id-display" class="font-mono text-lg my-2 bg-gray-700 px-2 py-1 rounded"></p>
      <div id="qrcode-container" class="p-2 bg-white rounded-md mt-2"></div>
    </div>
    <button id="fullscreen-btn" class="absolute bottom-4 right-4 text-white bg-black bg-opacity-50 p-3 rounded-full hover:bg-opacity-75 transition" aria-label="fullscreen">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
    </button>
  </div>

  <div id="controller-view" class="hidden h-full w-full bg-gray-800 overflow-y-auto no-scrollbar">
    <div class="p-6 max-w-md mx-auto">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold led-font">æ§åˆ¶å°</h2>
        <p class="text-sm text-gray-400 font-mono">ID: <span id="controller-session-id"></span></p>
      </div>

      <div class="sticky-preview">
        <label class="block mb-2 text-sm font-medium text-gray-300">æ•ˆæœé è¦½</label>
        <div class="controller-preview" id="controller-preview">
          <div class="grid-bg"></div>
          <div class="marquee-container-wrapper" id="preview-marquee-container-wrapper">
            <div class="marquee-text" id="preview-marquee-text"></div>
          </div>
          <div class="gap-overlay"></div>
        </div>
      </div>

      <div class="mb-6 mt-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">é¡¯ç¤ºæ–‡å­—</label>
        <textarea id="text-input" rows="3" class="w-full bg-gray-700 border border-gray-600 text-white text-lg p-2.5 rounded-lg" placeholder="åœ¨æ­¤è¼¸å…¥æ–‡å­—..."></textarea>
      </div>

      <div class="mb-6 p-4 bg-gray-900/50 rounded-lg">
        <div class="flex items-center justify-between mb-4">
          <label class="block text-sm font-medium text-gray-300">å€‹æ€§åŒ–æ–‡å­—é¡è‰²</label>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="char-color-toggle" class="sr-only peer">
            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
          </label>
        </div>
        <div id="char-colorizer-wrapper" class="hidden space-y-4">
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-400">1. é»é¸ä¸‹æ–¹æ–‡å­—ä»¥é¸å–</label>
            <div id="char-selector" class="flex flex-wrap gap-2 p-2 bg-gray-700 rounded-md min-h-[44px] items-center"></div>
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-400">2. ç‚ºé¸å–çš„æ–‡å­—ä¸Šè‰²</label>
            <div class="flex flex-wrap gap-3" id="char-color-picker"></div>
          </div>
        </div>
      </div>

      <div class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">å­—é«”é¸æ“‡</label>
        <div class="grid grid-cols-3 gap-3">
          <button data-font="'Inter','å¾®è»Ÿæ­£é»‘é«”',sans-serif" class="font-btn p-3 bg-indigo-600 rounded-lg text-sm">æ¨™æº–é«”</button>
          <button data-font="'DotGothic16',sans-serif" class="font-btn p-3 bg-gray-700 rounded-lg text-sm">é»é™£é«”</button>
          <button data-font="'Noto Serif TC',serif" class="font-btn p-3 bg-gray-700 rounded-lg text-sm">å®‹é«”</button>
          <button data-font="'ZCOOL KuaiLe',cursive" class="font-btn p-3 bg-gray-700 rounded-lg text-sm">å¿«æ¨‚é«”</button>
          <button data-font="'Cutive Mono',monospace" class="font-btn p-3 bg-gray-700 rounded-lg text-sm">ç­‰å¯¬é«”</button>
        </div>
      </div>

      <div class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">å­—é«”æ¨¡å¼</label>
        <div class="grid grid-cols-2 gap-3">
          <button data-mode="fixed" class="font-mode-btn p-3 bg-gray-700 rounded-lg text-sm">å›ºå®šå¤§å°</button>
          <button data-mode="fitHeight" class="font-mode-btn p-3 bg-indigo-600 rounded-lg text-sm">å¡«æ»¿é«˜åº¦</button>
          <button data-mode="fitWidth" class="font-mode-btn p-3 bg-gray-700 rounded-lg text-sm">å¡«æ»¿å¯¬åº¦</button>
          <button data-mode="multiline" class="font-mode-btn p-3 bg-gray-700 rounded-lg text-sm">è‡ªå‹•æ›è¡Œ</button>
        </div>
      </div>

      <div id="font-size-controls" class="mb-6">
        <label id="font-size-label" for="font-size-slider" class="block mb-2 text-sm font-medium text-gray-300">é«˜åº¦ä½”æ¯”: <span id="font-size-value">95</span>%</label>
        <input id="font-size-slider" type="range" min="10" max="100" value="95" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
      </div>

      <div class="mb-6">
        <label for="speed-slider" class="block mb-2 text-sm font-medium text-gray-300">æ»¾å‹•é€Ÿåº¦: <span id="speed-value">10</span>s</label>
        <input id="speed-slider" type="range" min="1" max="60" value="10" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
      </div>

      <div class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">æ»¾å‹•æ–¹å‘</label>
        <div class="grid grid-cols-3 gap-3">
          <button data-direction="marquee-left" class="direction-btn p-3 bg-gray-700 rounded-lg">â† å‘å·¦</button>
          <button data-direction="none" class="direction-btn p-3 bg-indigo-600 rounded-lg">âšâš éœæ­¢</button>
          <button data-direction="marquee-right" class="direction-btn p-3 bg-gray-700 rounded-lg">å‘å³ â†’</button>
        </div>
      </div>

      <div id="global-color-wrapper" class="mb-6 p-4 bg-gray-900 rounded-lg">
        <div class="flex border-b border-gray-700 mb-4">
          <div id="color-tab" class="flex -mb-px">
            <button data-tab="solid" class="tab-btn text-white py-2 px-4 border-b-2 border-indigo-500 font-medium">ç´”è‰²</button>
            <button data-tab="gradient" class="tab-btn text-gray-400 py-2 px-4 border-b-2 border-transparent">æ¼¸å±¤</button>
          </div>
        </div>
        <div id="solid-color-panel">
          <label class="block mb-2 text-sm font-medium text-gray-300">æ–‡å­—é¡è‰²</label>
          <div class="flex flex-wrap gap-3 mb-4" id="text-color-picker"></div>
          <label class="block mb-2 text-sm font-medium text-gray-300">èƒŒæ™¯é¡è‰²</label>
          <div class="flex flex-wrap gap-3" id="bg-color-picker"></div>
        </div>
        <div id="gradient-color-panel" class="hidden">
          <label class="block mb-2 text-sm font-medium text-gray-300">æ–‡å­—æ¼¸å±¤</label>
          <div class="flex flex-wrap gap-2 mb-4" id="text-gradient-picker"></div>
          <label class="block mb-2 text-sm font-medium text-gray-300">èƒŒæ™¯æ¼¸å±¤</label>
          <div class="flex flex-wrap gap-2" id="bg-gradient-picker"></div>
        </div>
      </div>

      <div class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">èƒŒæ™¯ç¶²æ ¼</label>
        <div class="flex flex-wrap gap-3">
          <button data-grid="none" class="grid-style-btn p-3 bg-indigo-600 rounded-lg text-sm">ç„¡</button>
          <button data-grid="dot" class="grid-style-btn p-3 bg-gray-700 rounded-lg text-sm">âš«ï¸ é»ç‹€</button>
          <button data-grid="square" class="grid-style-btn p-3 bg-gray-700 rounded-lg text-sm">â¬›ï¸ æ–¹å½¢</button>
          <button data-grid="diamond" class="grid-style-btn p-3 bg-gray-700 rounded-lg text-sm">â™¦ï¸ è±å½¢</button>
        </div>
      </div>

      <div id="grid-advanced-section" class="mb-6 space-y-6 hidden">
        <div>
          <label for="grid-size-slider" class="block mb-2 text-sm font-medium text-gray-300">ç¶²æ ¼å¤§å°: <span id="grid-size-value">20</span>px</label>
          <input id="grid-size-slider" type="range" min="4" max="120" value="20" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
        </div>
        <div class="p-4 bg-gray-900 rounded-lg">
          <div class="flex border-b border-gray-700 mb-4">
            <div id="grid-color-tab" class="flex -mb-px">
              <button data-tab="solid" class="grid-tab-btn text-white py-2 px-4 border-b-2 border-indigo-500 font-medium">ç´”è‰²</button>
              <button data-tab="gradient" class="grid-tab-btn text-gray-400 py-2 px-4 border-b-2 border-transparent">æ¼¸å±¤</button>
            </div>
          </div>
          <div id="grid-solid-color-panel">
            <label class="block mb-2 text-sm font-medium text-gray-300">ç¶²æ ¼é¡è‰²</label>
            <div class="flex flex-wrap gap-3" id="grid-color-picker"></div>
          </div>
          <div id="grid-gradient-color-panel" class="hidden">
            <label class="block mb-2 text-sm font-medium text-gray-300">ç¶²æ ¼æ¼¸å±¤</label>
            <div class="flex flex-wrap gap-2" id="grid-gradient-picker"></div>
          </div>
        </div>
        <div class="p-4 bg-gray-900 rounded-lg">
          <label class="block mb-2 text-sm font-medium text-gray-300">LEDç©¿å­”</label>
          <div class="flex flex-wrap gap-3">
            <button data-blend="normal" class="blend-mode-btn p-3 bg-indigo-600 rounded-lg text-sm">é—œé–‰</button>
            <button data-blend="multiply" class="blend-mode-btn p-3 bg-gray-700 rounded-lg text-sm">é–‹å•Ÿ</button>
          </div>
          <div id="gap-controls" class="mt-4 hidden">
            <label class="block mb-2 text-sm font-medium text-gray-300">éš™ç¸«é¡è‰²</label>
            <div class="flex flex-wrap gap-3" id="gap-color-picker"></div>
            <div class="mt-4">
              <label for="gap-alpha-slider" class="block mb-2 text-sm font-medium text-gray-300">éš™ç¸«ä¸é€æ˜åº¦: <span id="gap-alpha-value">1.00</span></label>
              <input id="gap-alpha-slider" type="range" min="0.10" max="1.00" step="0.05" value="1.00" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
            </div>
          </div>
        </div>
      </div>

      <div id="text-style-wrapper" class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">æ–‡å­—é¢¨æ ¼</label>
        <div class="flex flex-wrap gap-3">
          <button data-style="normal" class="text-style-btn p-3 bg-indigo-600 rounded-lg text-sm">æ¨™æº–</button>
          <button data-style="glow" class="text-style-btn p-3 bg-gray-700 rounded-lg text-sm">âœ¨ ç™¼å…‰</button>
          <button data-style="outline" class="text-style-btn p-3 bg-gray-700 rounded-lg text-sm">âœï¸ é‚Šæ¡†</button>
          <button data-style="dotted" class="text-style-btn p-3 bg-gray-700 rounded-lg text-sm">âš«ï¸ é»ç‹€</button>
        </div>
      </div>
      <div id="outline-color-section" class="mb-6 hidden">
        <label class="block mb-2 text-sm font-medium text-gray-300">é‚Šæ¡†é¡è‰²</label>
        <div class="flex flex-wrap gap-3" id="outline-color-picker"></div>
      </div>

      <div id="border-style-wrapper" class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">èƒŒæ™¯é‚Šæ¡†</label>
        <div class="flex flex-wrap gap-3">
          <button data-border="none" class="border-style-btn p-3 bg-indigo-600 rounded-lg text-sm">ç„¡</button>
          <button data-border="solid" class="border-style-btn p-3 bg-gray-700 rounded-lg text-sm">â¬œï¸ å¯¦ç·š</button>
          <button data-border="rainbow" class="border-style-btn p-3 bg-gray-700 rounded-lg text-sm">ğŸŒˆ å½©è™¹é‚Šæ¡†</button>
        </div>
      </div>

      <div id="border-controls-section" class="mb-6 space-y-6 hidden">
        <div>
          <label for="border-width-slider" class="block mb-2 text-sm font-medium text-gray-300">é‚Šæ¡†å¯¬åº¦: <span id="border-width-value">8</span>px</label>
          <input id="border-width-slider" type="range" min="0" max="50" value="8" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
        </div>
        <div>
          <label for="border-radius-slider" class="block mb-2 text-sm font-medium text-gray-300">é‚Šæ¡†åœ“è§’: <span id="border-radius-value">16</span>px</label>
          <input id="border-radius-slider" type="range" min="0" max="100" value="16" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
        </div>
      </div>

      <div id="bg-effect-wrapper" class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">èƒŒæ™¯å‹•ç•«</label>
        <div class="flex flex-wrap gap-3">
          <button data-effect="none" class="bg-effect-btn p-3 bg-indigo-600 rounded-lg text-sm">ç„¡</button>
          <button data-effect="eyes" class="bg-effect-btn p-3 bg-gray-700 rounded-lg text-sm">ğŸ‘€ çœ¼ç›</button>
        </div>
      </div>

      <div class="mt-8 mb-4">
        <a href="#" onclick="window.location.search='';return false" class="w-full text-center block bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg">è¿”å›é¦–é </a>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = { apiKey:"AIzaSyDiXuuIQB9EJQZtW8zYuTByxr-Y5wMpRdc", authDomain:"led-run-c168b.firebaseapp.com", projectId:"led-run-c168b", storageBucket:"led-run-c168b.appspot.com", messagingSenderId:"555557259748", appId:"1:555557259748:web:7a79d35743bcbadbf11ff1", measurementId:"G-7JH5TLX99R" };
  let db; try { db = getFirestore(initializeApp(firebaseConfig)); } catch(e){ console.error("Firebase åˆå§‹åŒ–å¤±æ•—", e); alert("Firebase é€£ç·šå¤±æ•—ï¼"); }

  const homeView = document.getElementById('home-view');
  const displayView = document.getElementById('display-view');
  const controllerView = document.getElementById('controller-view');

  const btn = (sel)=>Array.from(document.querySelectorAll(sel));
  const $  = (id)=>document.getElementById(id);

  let currentSessionId = null, unsubscribe = null;

  // ç¨ç«‹ä¿å­˜å…©ç¨®æ¨¡å¼çš„å€¼ï¼Œé¿å… UI åˆ‡æ›éºå¤±
  let fillHeightPercentage = 95;  // 10~100ï¼ˆ%ï¼‰
  let fixedFontSize = 100;        // 10~500ï¼ˆpxï¼‰

  const defaultSettings = {
    text: "Hello ğŸ‘‹",
    textColor: "#FFFFFF",
    backgroundColor: "#000000",
    fontFamily: "'Inter','å¾®è»Ÿæ­£é»‘é«”',sans-serif",
    fontSizeMode: "fitHeight",   // fixed | fitHeight | fitWidth | multiline
    fontSize: 95,                // ç”¨æ–¼ fitHeightï¼ˆ%ï¼‰
    fixedFontSize: 100,          // ç”¨æ–¼ fixedï¼ˆpxï¼‰
    scrollSpeed: 10,
    scrollDirection: "none",
    textStyle: "normal",
    outlineColor: "#FF3B30",
    textColorMode: "solid",
    bgColorMode: "solid",
    gridColorMode: "solid",
    gridStyle: "none",
    gridSize: 20,
    gridColor: "#374151",
    textBlendMode: "normal",
    gapColor: "#000000",
    gapAlpha: 1,
    backgroundBorder: "none",
    borderWidth: 8,
    borderRadius: 16,
    backgroundEffect: "none",
    isBlinking: false,
    isCharColoring: false,
    charColors: [],
    updatedAt: serverTimestamp()
  };

  function showView(name){
    [homeView, displayView, controllerView].forEach(v=>v.classList.add('hidden'));
    (name==='home'?homeView:(name==='display'?displayView:controllerView)).classList.remove('hidden');
  }

  function generateId(){ return Math.random().toString(36).substring(2,8).toUpperCase(); }

  window.addEventListener('load', ()=>{
    const params = new URLSearchParams(location.search);
    if (params.has('display')) startDisplayMode(params.get('display'));
    else if (params.has('controller')) startControllerMode(params.get('controller'));
    else showView('home');
  });

  $('create-display-btn').addEventListener('click', ()=>{
    const id = generateId();
    location.search = `?display=${id}`;
  });

  $('open-controller-btn').addEventListener('click', ()=>{
    const id = $('session-id-input').value.trim();
    if (!id) return;
    location.search = `?controller=${id}`;
  });

  // é è¦½/é¡¯ç¤ºå¥—ç”¨ï¼ˆæ­¤è™•ç°¡åŒ–ï¼Œä¿ç•™ä¸»è¦èˆ‡å­—é«”æ¨¡å¼ç›¸é—œï¼‰
  function applySettings(els, s){
    const textEl = els.textEl;
    const wrapper = els.wrapperEl;
    const container = els.containerEl;

    textEl.style.fontFamily = s.fontFamily;
    textEl.textContent = s.text;
    textEl.style.setProperty('--text-color', s.textColor);
    container.style.setProperty('--bg-color', s.backgroundColor);

    // æ–‡å­—é¢¨æ ¼
    textEl.classList.remove('text-style-glow','text-style-outline','text-style-dotted');
    if (s.textStyle==='glow') textEl.classList.add('text-style-glow');
    if (s.textStyle==='outline') { textEl.classList.add('text-style-outline'); textEl.style.setProperty('--outline-color', s.outlineColor); }
    if (s.textStyle==='dotted') textEl.classList.add('text-style-dotted');

    // æ»¾å‹•æ–¹å‘
    textEl.style.animation = 'none';
    if (s.scrollDirection==='marquee-left'){
      const dur = Math.max(1, Number(s.scrollSpeed)||10);
      textEl.style.animation = `marquee-left ${dur}s linear infinite`;
    } else if (s.scrollDirection==='marquee-right'){
      const dur = Math.max(1, Number(s.scrollSpeed)||10);
      textEl.style.animation = `marquee-right ${dur}s linear infinite`;
    }

    // å­—é«”æ¨¡å¼
    const wrapperRect = wrapper.getBoundingClientRect();
    const containerRect = container.getBoundingClientRect();

    if (s.fontSizeMode==='fixed'){
      textEl.style.whiteSpace = 'nowrap';
      textEl.style.display = 'inline-block';
      textEl.style.fontSize = `${s.fixedFontSize || 100}px`;
      textEl.style.lineHeight = '1.1';
    }
    else if (s.fontSizeMode==='fitHeight'){
      const percent = Math.min(100, Math.max(10, Number(s.fontSize)||95));
      const targetH = Math.max(10, wrapperRect.height || 120) * (percent/100);
      // ç›´æ¥ä»¥è¨ˆç®—çµæœæŒ‡å®š fontSize
      textEl.style.whiteSpace = 'nowrap';
      textEl.style.display = 'inline-block';
      textEl.style.lineHeight = '1.05';
      textEl.style.fontSize = `${Math.floor(targetH)}px`;
    }
    else if (s.fontSizeMode==='fitWidth'){
      // äºŒåˆ†æœå°‹è‡ªå‹•å¡æ»¿å¯¬åº¦ï¼ˆä¿æŒä½ çš„åŸé‚è¼¯ï¼‰
      const maxW = Math.max(10, wrapperRect.width || containerRect.width || 320);
      textEl.style.whiteSpace = 'nowrap';
      textEl.style.display = 'inline-block';
      textEl.style.lineHeight = '1.05';

      let lo = 4, hi = 1000, best = 40;
      for (let i=0;i<12;i++){
        const mid = Math.floor((lo+hi)/2);
        textEl.style.fontSize = `${mid}px`;
        const w = textEl.getBoundingClientRect().width;
        if (w<=maxW){ best = mid; lo = mid+1; } else { hi = mid-1; }
      }
      textEl.style.fontSize = `${best}px`;
    }
    else if (s.fontSizeMode==='multiline'){
      // å¤šè¡Œè‡ªå‹•æ›è¡Œï¼Œçµ¦ä¸€å€‹åˆç†å¤§å°
      textEl.style.whiteSpace = 'normal';
      textEl.style.display = 'inline-block';
      textEl.style.lineHeight = '1.25';
      const basis = Math.max(10, containerRect.height || 200);
      textEl.style.fontSize = `${Math.floor(basis*0.4)}px`;
    }
  }

  function getPreviewEls(){
    return {
      textEl: $('preview-marquee-text'),
      wrapperEl: $('preview-marquee-container-wrapper'),
      containerEl: $('controller-preview')
    };
  }

  function getDisplayEls(){
    return {
      textEl: $('marquee-text'),
      wrapperEl: $('marquee-container-wrapper'),
      containerEl: $('display-screen')
    };
  }

  // UIï¼šæ ¹æ“šæ¨¡å¼åˆ·æ–°å­—é«” Sliderï¼ˆé¡¯ç¤º/éš±è—ã€min/max/valueã€æ¨™ç±¤ï¼‰
  function updateFontSizeUIByMode(mode){
    const box = $('font-size-controls');
    const slider = $('font-size-slider');
    const label = $('font-size-label');

    if (mode==='fitHeight'){
      box.style.display = 'block';
      slider.min = '10';
      slider.max = '100';
      slider.value = String(fillHeightPercentage);
      label.innerHTML = `é«˜åº¦ä½”æ¯”: <span id="font-size-value">${fillHeightPercentage}</span>%`;
    } else if (mode==='fixed'){
      box.style.display = 'block';
      slider.min = '10';
      slider.max = '500';
      slider.value = String(fixedFontSize);
      label.innerHTML = `å­—é«”å¤§å°: <span id="font-size-value">${fixedFontSize}</span>px`;
    } else {
      // fitWidth æˆ– multiline ä¸é¡¯ç¤º slider
      box.style.display = 'none';
    }
  }

  async function startDisplayMode(sessionId){
    currentSessionId = sessionId;
    showView('display');

    const els = getDisplayEls();
    applySettings(els, defaultSettings);

    $('session-id-display').textContent = sessionId;
    const url = `${location.href.split('?')[0]}?controller=${sessionId}`;
    new QRCode($('qrcode-container'), { text:url, width:128, height:128 });

    const ref = doc(db,'sessions',sessionId);
    const snap = await getDoc(ref);
    if (!snap.exists()) await setDoc(ref, defaultSettings);

    listenToChanges(sessionId, els);

    // ç°¡æ˜“é®ç½©æç¤ºé¡¯ç¤º/éš±è— & å…¨è¢å¹•
    const info = $('info-overlay');
    setTimeout(()=>info.classList.add('opacity-0'), 5000);
    $('display-view').addEventListener('click',(e)=>{
      if (!e.target.closest('#fullscreen-btn') && !e.target.closest('#info-overlay')){
        info.classList.toggle('opacity-0');
      }
    });
    $('fullscreen-btn').addEventListener('click', ()=>{
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else document.exitFullscreen();
    });
  }

  function listenToChanges(sessionId, els){
    if (unsubscribe) unsubscribe();
    const ref = doc(db,'sessions',sessionId);
    unsubscribe = onSnapshot(ref, (snap)=>{
      if (!snap.exists()) return;
      const s = { ...defaultSettings, ...snap.data() };
      applySettings(els, s);
    }, (err)=>console.error(err));
  }

  async function startControllerMode(sessionId){
    currentSessionId = sessionId;
    showView('controller');
    $('controller-session-id').textContent = sessionId;

    const ref = doc(db,'sessions',sessionId);
    const snap = await getDoc(ref);
    if (!snap.exists()) await setDoc(ref, defaultSettings);
    const s = snap.exists() ? { ...defaultSettings, ...snap.data() } : defaultSettings;

    // åˆå§‹åŒ–å…§éƒ¨å€¼
    fillHeightPercentage = Number(s.fontSize)||95;
    fixedFontSize = Number(s.fixedFontSize)||100;

    // åˆå§‹ UI
    $('text-input').value = s.text;
    $('speed-slider').value = s.scrollSpeed;
    $('speed-value').textContent = String(s.scrollSpeed);

    // è¨­å®šæ¨¡å¼æŒ‰éˆ•ç‹€æ…‹
    btn('.font-mode-btn').forEach(b=>{
      b.classList.toggle('bg-indigo-600', b.dataset.mode===s.fontSizeMode);
      b.classList.toggle('bg-gray-700', b.dataset.mode!==s.fontSizeMode);
    });

    // æ›´æ–° Slider å€å¡Šï¼ˆé—œéµä¿®æ­£ï¼‰
    updateFontSizeUIByMode(s.fontSizeMode);

    // é è¦½å¥—ç”¨
    applySettings(getPreviewEls(), s);

    // ç¶å®šäº‹ä»¶
    bindControllerEvents(ref, s);
  }

  function currentMode(){
    const active = document.querySelector('.font-mode-btn.bg-indigo-600');
    return active ? active.dataset.mode : 'fitHeight';
  }

  function bindControllerEvents(ref, state){
    // æ–‡å­—è¼¸å…¥
    $('text-input').addEventListener('input', async (e)=>{
      state.text = e.target.value;
      await updateDoc(ref, { text: state.text, updatedAt: serverTimestamp() });
      applySettings(getPreviewEls(), state);
    });

    // é€Ÿåº¦
    $('speed-slider').addEventListener('input', async (e)=>{
      const v = Number(e.target.value)||10;
      $('speed-value').textContent = String(v);
      state.scrollSpeed = v;
      await updateDoc(ref, { scrollSpeed: v, updatedAt: serverTimestamp() });
      applySettings(getPreviewEls(), state);
    });

    // å­—é«”æ¨¡å¼åˆ‡æ›ï¼ˆé—œéµä¿®æ­£ï¼šåˆ‡æ›å³åŒæ­¥ Slider é¡¯ç¤ºèˆ‡å€¼ï¼‰
    btn('.font-mode-btn').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const mode = b.dataset.mode;
        btn('.font-mode-btn').forEach(x=>{
          x.classList.toggle('bg-indigo-600', x===b);
          x.classList.toggle('bg-gray-700', x!==b);
        });
        state.fontSizeMode = mode;

        // åˆ‡æ›æ™‚ç«‹å³åˆ·æ–° Slider/Label ç‹€æ…‹èˆ‡å€¼ï¼Œé¿å…ã€Œçœ‹ä¼¼å¤±æ•ˆã€
        updateFontSizeUIByMode(mode);

        // å¯«å›å°æ‡‰å€¼ï¼ˆfixed èˆ‡ fitHeight å„è‡ªæ›´æ–°å°æ‡‰æ¬„ä½ï¼‰
        if (mode==='fixed'){
          state.fixedFontSize = fixedFontSize;
        } else if (mode==='fitHeight'){
          state.fontSize = fillHeightPercentage;
        }

        await updateDoc(ref, { fontSizeMode: mode, fontSize: state.fontSize, fixedFontSize: state.fixedFontSize, updatedAt: serverTimestamp() });
        applySettings(getPreviewEls(), state);
      });
    });

    // å­—é«”å¤§å° Sliderï¼ˆæ ¹æ“šç›®å‰æ¨¡å¼å¯«ä¸åŒæ¬„ä½ï¼‰
    $('font-size-slider').addEventListener('input', async (e)=>{
      const mode = currentMode();
      const val = Number(e.target.value);
      if (mode==='fitHeight'){
        fillHeightPercentage = val;
        $('font-size-label').innerHTML = `é«˜åº¦ä½”æ¯”: <span id="font-size-value">${fillHeightPercentage}</span>%`;
        state.fontSize = fillHeightPercentage;
        await updateDoc(ref, { fontSize: state.fontSize, updatedAt: serverTimestamp() });
      } else if (mode==='fixed'){
        fixedFontSize = val;
        $('font-size-label').innerHTML = `å­—é«”å¤§å°: <span id="font-size-value">${fixedFontSize}</span>px`;
        state.fixedFontSize = fixedFontSize;
        await updateDoc(ref, { fixedFontSize: state.fixedFontSize, updatedAt: serverTimestamp() });
      } else {
        // fitWidth / multiline ä¸æ‡‰å‡ºç¾ï¼Œä½†è‹¥å¤–éƒ¨å‘¼å«ï¼Œå¿½ç•¥
        return;
      }
      applySettings(getPreviewEls(), state);
    });

    // æ»¾å‹•æ–¹å‘
    btn('.direction-btn').forEach(b=>{
      b.addEventListener('click', async ()=>{
        btn('.direction-btn').forEach(x=>{
          x.classList.toggle('bg-indigo-600', x===b);
          x.classList.toggle('bg-gray-700', x!==b);
        });
        state.scrollDirection = b.dataset.direction;
        await updateDoc(ref, { scrollDirection: state.scrollDirection, updatedAt: serverTimestamp() });
        applySettings(getPreviewEls(), state);
      });
    });

    // å…¶ä»–æŒ‰éˆ•/é¡è‰²/ç¶²æ ¼ç­‰ï¼ˆå¯ä¾åŸå°ˆæ¡ˆç¶å®šï¼Œèˆ‡æ­¤æ¬¡ä¿®æ­£ç„¡è¡çªï¼‰
  }
</script>
</body>
</html>
