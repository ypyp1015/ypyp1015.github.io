<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>遠端遙控 LED 跑馬燈 v22.1.41 (Fixed)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<!-- 引入所有需要的字體 -->
<link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Noto+Serif+TC:wght@400;700&family=ZCOOL+KuaiLe&family=Cutive+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
  html, body { height:100%; margin:0; padding:0; background:#0f172a; }
  body { font-family:'Inter','微軟正黑體',sans-serif; overscroll-behavior:none; }
  .led-font { font-family:'DotGothic16',sans-serif; }

  @keyframes marquee-left { from{ transform:translateX(100vw);} to{ transform:translateX(-100%);} }
  @keyframes marquee-right{ from{ transform:translateX(-100%);} to{ transform:translateX(100vw);} }
  @keyframes blink-effect { 50%{ opacity:0; } }
  @keyframes eye-blink-anim { 0%,40%,100%{ transform:scaleY(1);} 42%{ transform:scaleY(0.1);} }
  @keyframes eye-move-anim { 0%,20%{ transform:translateX(0);} 30%,50%{ transform:translateX(-10px);} 60%,80%{ transform:translateX(10px);} 90%,100%{ transform:translateX(0);} }
  @keyframes rainbow-border-anim { 0%{background-position:0% 50%;} 50%{background-position:100% 50%;} 100%{background-position:0% 50%;} }

  .marquee-text{
    font-size:var(--font-size,80px);
    color:var(--text-color,#FFFFFF);
    white-space:nowrap;
    display:inline-block;
    line-height:1.1;
    position:relative;
    z-index:1;
    transition: color .2s, background-color .2s, text-shadow .2s;
  }
  .gradient-text{
    background-clip:text; -webkit-background-clip:text;
    color:transparent !important; -webkit-text-fill-color:transparent;
  }
  .text-style-glow{ text-shadow:0 0 8px var(--text-color,#fff), 0 0 12px var(--text-color,#fff); }
  .text-style-outline{
    -webkit-text-stroke: 1.5px var(--outline-color);
    -webkit-text-fill-color: transparent;
    paint-order: stroke fill;
    text-shadow: none !important;
  }
  .text-style-dotted {
    background-clip: text; -webkit-background-clip: text;
    color: transparent !important; -webkit-text-fill-color: transparent;
    background-image: radial-gradient(var(--text-color) 35%, transparent 40%);
    background-size: 3px 3px;
    text-shadow: none !important;
    -webkit-text-stroke: 0;
  }

  .display-screen{
    width:100%; height:100%; position:relative;
    background:var(--bg-color,#000); box-sizing:border-box;
    isolation: isolate;
  }
  .marquee-container-wrapper{ position:absolute; top:50%; left:0; width:100%; transform:translateY(-50%); overflow:hidden; z-index:2; }

  .grid-bg{
    position:absolute; inset:0; z-index:1; pointer-events:none;
    background: var(--grid-color);
    mask-image: var(--grid-mask-image); -webkit-mask-image: var(--grid-mask-image);
    mask-size: var(--grid-size) var(--grid-size); -webkit-mask-size: var(--grid-size) var(--grid-size);
    mask-position: left top; -webkit-mask-position: left top;
    mask-repeat: repeat; -webkit-mask-repeat: repeat;
    border-radius: var(--inner-border-radius, 0px);
  }

  .gap-overlay{
    position:absolute; inset:0; z-index:3; pointer-events:none;
    background: var(--gap-color,#000); opacity: var(--gap-alpha,1);
    mask-image: var(--gap-mask-image); -webkit-mask-image: var(--gap-mask-image);
    mask-size: var(--grid-size) var(--grid-size); -webkit-mask-size: var(--grid-size) var(--grid-size);
    mask-position: left top; -webkit-mask-position: left top;
    mask-repeat: repeat; -webkit-mask-repeat: repeat;
    display:none;
    border-radius: var(--inner-border-radius, 0px);
  }

  .border-style-solid {
    border-style: solid;
    border-color: white;
    border-width: var(--border-width, 8px);
    border-radius: var(--border-radius, 16px);
  }
  .border-style-rainbow {
    position: relative;
    border-radius: var(--border-radius, 16px);
    animation: rainbow-border-anim 3s linear infinite;
    background-size: 200% 200%;
  }
  .border-style-rainbow::after {
    content: '';
    position: absolute;
    inset: var(--border-width, 8px);
    background: var(--bg-color);
    border-radius: var(--inner-border-radius, 8px);
    z-index: 0;
  }


  #background-effects-container{ position:absolute; inset:0; display:flex; justify-content:center; align-items:center; gap:20px; pointer-events:none; z-index:1; }
  .eye{ width:80px; height:80px; background:#fff; border-radius:50%; position:relative; animation:eye-blink-anim 5s infinite; overflow:hidden; }
  .pupil{ width:40px; height:40px; background:#222; border-radius:50%; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); animation: eye-move-anim 10s infinite; }

  .sticky-preview{ position:sticky; top:0; z-index:10; background:#1e293b; padding:1.5rem; margin-left:-1.5rem; margin-right:-1.5rem; }
  .controller-preview{ 
    height:120px; 
    position:relative; 
    background:var(--bg-color,#000); 
    outline:1px solid #374151; 
    box-sizing:border-box; 
    isolation: isolate;
  }
  .controller-preview .marquee-text{ font-size:var(--font-size,40px); }

  .no-scrollbar::-webkit-scrollbar{ display:none; }
  .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
  .control-btn-active{ box-shadow:0 0 0 3px #4f46e5; }
  .control-disabled{ opacity:.4; pointer-events:none; cursor:not-allowed; }
 
  /* 【新增】個別文字上色 UI 樣式 */
  .char-btn {
    transition: all 0.2s;
    border: 2px solid transparent;
  }
  .char-btn-active {
    border-color: #6366f1; /* Indigo */
    transform: scale(1.1);
    background-color: #4f46e5 !important;
    color: white !important;
  }
</style>
</head>
<body class="text-white">
<div id="app-container" class="h-full w-full">
  <!-- 首頁 -->
  <div id="home-view" class="flex flex-col items-center justify-center h-full p-8 text-center bg-gray-900">
    <h1 class="text-5xl font-bold mb-4 led-font">LED Scroller</h1>
    <p class="text-gray-400 mb-12">數位跑馬燈・遠端遙控</p>
    <div class="space-y-4 w-full max-w-xs">
      <button id="create-display-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">建立新的顯示面板</button>
      <p class="text-gray-500">或</p>
      <div class="relative">
        <input type="text" id="session-id-input" placeholder="輸入面板 ID 進入控制台" class="w-full bg-gray-800 border border-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <button id="open-controller-btn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-3 rounded-md">進入</button>
      </div>
    </div>
    <p class="text-gray-600 mt-12 text-sm">提示：在設備 A 建立顯示面板，<br>然後在設備 B 輸入面板 ID 進行遙控。</p>
  </div>

  <!-- 顯示面板 -->
  <div id="display-view" class="hidden h-full w-full">
    <div class="display-screen" id="display-screen">
      <div class="grid-bg"></div>
      <div id="background-effects-container"></div>
      <div class="marquee-container-wrapper" id="marquee-container-wrapper">
        <div class="marquee-text" id="marquee-text"><span>請稍候...</span></div>
      </div>
      <div class="gap-overlay" id="gap-overlay"></div>
    </div>
    <div id="info-overlay" class="absolute top-4 left-4 bg-black bg-opacity-70 p-4 rounded-lg text-white transition-opacity duration-500">
      <p class="text-sm">輕觸螢幕可隱藏/顯示此資訊</p>
      <p id="session-id-display" class="font-mono text-lg my-2 bg-gray-700 px-2 py-1 rounded"></p>
      <div id="qrcode-container" class="p-2 bg-white rounded-md mt-2"></div>
    </div>
    <button id="fullscreen-btn" class="absolute bottom-4 right-4 text-white bg-black bg-opacity-50 p-3 rounded-full hover:bg-opacity-75 transition" aria-label="fullscreen">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
    </button>
  </div>

  <!-- 控制台 -->
  <div id="controller-view" class="hidden h-full w-full bg-gray-800 overflow-y-auto no-scrollbar">
    <div class="p-6 max-w-md mx-auto">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold led-font">控制台</h2>
        <p class="text-sm text-gray-400 font-mono">ID: <span id="controller-session-id"></span></p>
      </div>

      <div class="sticky-preview">
        <label class="block mb-2 text-sm font-medium text-gray-300">效果預覽</label>
        <div class="controller-preview" id="controller-preview">
          <div class="grid-bg"></div>
          <div class="marquee-container-wrapper" id="preview-marquee-container-wrapper">
            <div class="marquee-text" id="preview-marquee-text"></div>
          </div>
          <div class="gap-overlay"></div>
        </div>
      </div>

      <div class="mb-6 mt-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">顯示文字</label>
        <textarea id="text-input" rows="3" class="w-full bg-gray-700 border border-gray-600 text-white text-lg p-2.5 rounded-lg" placeholder="在此輸入文字..."></textarea>
      </div>
      
      <!-- 【新增】個別文字上色功能 -->
      <div class="mb-6 p-4 bg-gray-900/50 rounded-lg">
        <div class="flex items-center justify-between mb-4">
            <label class="block text-sm font-medium text-gray-300">個性化文字顏色</label>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="char-color-toggle" class="sr
