<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>é ç«¯é™æ§ LED è·‘é¦¬ç‡ˆ v20.6.4ï¼ˆé¡¯ç¤ºé¢æ¿åˆå§‹åŒ–èˆ‡ç›£è½å›é€€ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    html, body { height:100%; margin:0; padding:0; background:#0f172a; }
    body { font-family:'Inter','å¾®è»Ÿæ­£é»‘é«”',sans-serif; overscroll-behavior:none; }
    .led-font { font-family:'DotGothic16',sans-serif; }

    @keyframes marquee-left { from{ transform:translateX(100vw);} to{ transform:translateX(-100%);} }
    @keyframes marquee-right{ from{ transform:translateX(-100%);} to{ transform:translateX(100vw);} }
    @keyframes blink-effect { 50%{ opacity:0; } }
    @keyframes rainbow-border-anim { 0%{background-position:0% 50%;} 50%{background-position:100% 50%;} 100%{background-position:0% 50%;} }

    .marquee-text{
      font-size:var(--font-size,80px);
      color:var(--text-color,#FFFFFF);
      white-space:nowrap;
      display:inline-block;
      line-height:1.1;
      position:relative;
      z-index:1;
      transition: color .2s, background-color .2s, text-shadow .2s;
    }
    .gradient-text{
      background-clip:text; -webkit-background-clip:text;
      color:transparent !important; -webkit-text-fill-color:transparent;
    }
    .text-style-glow{ text-shadow:0 0 8px var(--text-color,#fff), 0 0 12px var(--text-color,#fff); }
    .text-style-outline{
      text-shadow:
        -2px -2px 0 var(--outline-color),
         2px -2px 0 var(--outline-color),
        -2px  2px 0 var(--outline-color),
         2px  2px 0 var(--outline-color),
        -3px  0   0 var(--outline-color),
         3px  0   0 var(--outline-color),
         0   -3px 0 var(--outline-color),
         0    3px 0 var(--outline-color);
    }

    .display-screen{
      width:100%; height:100%; overflow:hidden; position:relative;
      background:var(--bg-color,#000);
      box-sizing:border-box;
      isolation:isolate;
    }
    .marquee-container-wrapper{ position:absolute; top:50%; left:0; width:100%; transform:translateY(-50%); overflow:hidden; z-index:1; }

    .grid-bg{
      position:absolute; inset:0; z-index:0; pointer-events:none;
      background: var(--grid-color) !important;
      mask-image: var(--grid-mask-image); -webkit-mask-image: var(--grid-mask-image);
      mask-size: var(--grid-size) var(--grid-size); -webkit-mask-size: var(--grid-size) var(--grid-size);
      mask-position: left top; -webkit-mask-position: left top;
      mask-repeat: repeat; -webkit-mask-repeat: repeat;
    }
    .grid-bg.gradient-grid{ background: var(--grid-gradient); }

    .gap-overlay{
      position:absolute; inset:0; z-index:2; pointer-events:none;
      background: var(--gap-color,#000); opacity: var(--gap-alpha,1);
      mask-image: var(--gap-mask-image); -webkit-mask-image: var(--gap-mask-image);
      mask-size: var(--grid-size) var(--grid-size); -webkit-mask-size: var(--grid-size) var(--grid-size);
      mask-position: left top; -webkit-mask-position: left top;
      mask-repeat: repeat; -webkit-mask-repeat: repeat;
      display:none;
    }

    .effect-rainbow-frame{ padding:8px; position:relative; box-shadow:0 0 25px rgba(255,100,255,.7); }
    .effect-rainbow-frame::before{
      content:''; position:absolute; inset:0; z-index:-1; margin:-8px;
      background:linear-gradient(45deg,red,orange,yellow,green,blue,indigo,violet,red);
      background-size:400% 400%; animation: rainbow-border-anim 2s linear infinite;
    }

    .sticky-preview{ position:sticky; top:0; z-index:10; background:#1e293b; padding:1.5rem; margin-left:-1.5rem; margin-right:-1.5rem; }
    .controller-preview{ height:120px; border-radius:.5rem; position:relative; overflow:hidden; background:var(--bg-color,#000); border:1px solid #374151; box-sizing:border-box; }
    .controller-preview .marquee-text{ font-size:var(--font-size,40px) !important; }

    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
    .control-btn-active{ box-shadow:0 0 0 3px #4f46e5; }
  </style>
</head>
<body class="text-white">
  <div id="app-container" class="h-full w-full">
    <!-- é¦–é  -->
    <div id="home-view" class="flex flex-col items-center justify-center h-full p-8 text-center bg-gray-900">
      <h1 class="text-5xl font-bold mb-4 led-font">LED Scroller</h1>
      <p class="text-gray-400 mb-12">æ•¸ä½è·‘é¦¬ç‡ˆãƒ»é ç«¯é™æ§</p>
      <div class="space-y-4 w-full max-w-xs">
        <button id="create-display-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">å»ºç«‹æ–°çš„é¡¯ç¤ºé¢æ¿</button>
        <p class="text-gray-500">æˆ–</p>
        <div class="relative">
          <input type="text" id="session-id-input" placeholder="è¼¸å…¥é¢æ¿ ID é€²å…¥æ§åˆ¶å°" class="w-full bg-gray-800 border border-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <button id="open-controller-btn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-3 rounded-md">é€²å…¥</button>
        </div>
      </div>
      <p class="text-gray-600 mt-12 text-sm">æç¤ºï¼šåœ¨è¨­å‚™ A å»ºç«‹é¡¯ç¤ºé¢æ¿ï¼Œ<br>ç„¶å¾Œåœ¨è¨­å‚™ B è¼¸å…¥é¢æ¿ ID é€²è¡Œé™æ§ã€‚</p>
    </div>

    <!-- é¡¯ç¤ºé¢æ¿ -->
    <div id="display-view" class="hidden h-full w-full">
      <div class="display-screen" id="display-screen">
        <div class="grid-bg"></div>
        <div id="background-effects-container"></div>
        <div class="marquee-container-wrapper" id="marquee-container-wrapper">
          <div class="marquee-text" id="marquee-text"><span>è«‹ç¨å€™...</span></div>
        </div>
        <div class="gap-overlay" id="gap-overlay"></div>
      </div>
      <div id="info-overlay" class="absolute top-4 left-4 bg-black bg-opacity-70 p-4 rounded-lg text-white transition-opacity duration-500">
        <p class="text-sm">è¼•è§¸è¢å¹•å¯éš±è—/é¡¯ç¤ºæ­¤è³‡è¨Š</p>
        <p id="session-id-display" class="font-mono text-lg my-2 bg-gray-700 px-2 py-1 rounded"></p>
        <div id="qrcode-container" class="p-2 bg-white rounded-md mt-2"></div>
      </div>
      <button id="fullscreen-btn" class="absolute bottom-4 right-4 text-white bg-black bg-opacity-50 p-3 rounded-full hover:bg-opacity-75 transition" aria-label="fullscreen">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
      </button>
    </div>

    <!-- æ§åˆ¶å°ï¼ˆæ­¤ç¯„ä¾‹ä¿ç•™æœ€å° UIï¼›è‹¥éœ€å®Œæ•´ v20.6.3 UI å¯æ²¿ç”¨å‰ç‰ˆ HTML å€å¡Šï¼‰ -->
    <div id="controller-view" class="hidden h-full w-full bg-gray-800 overflow-y-auto no-scrollbar">
      <div class="p-6 max-w-md mx-auto">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold led-font">æ§åˆ¶å°</h2>
          <p class="text-sm text-gray-400 font-mono">ID: <span id="controller-session-id"></span></p>
        </div>
        <div class="sticky-preview">
          <label class="block mb-2 text-sm font-medium text-gray-300">æ•ˆæœé è¦½</label>
          <div class="controller-preview" id="controller-preview">
            <div class="grid-bg"></div>
            <div class="marquee-container-wrapper" id="preview-marquee-container-wrapper">
              <div class="marquee-text" id="preview-marquee-text"></div>
            </div>
            <div class="gap-overlay"></div>
          </div>
        </div>

        <div class="mb-6 mt-6">
          <label for="text-input" class="block mb-2 text-sm font-medium text-gray-300">é¡¯ç¤ºæ–‡å­—</label>
          <textarea id="text-input" rows="3" class="w-full bg-gray-700 border border-gray-600 text-white text-lg p-2.5 rounded-lg" placeholder="åœ¨æ­¤è¼¸å…¥æ–‡å­—..."></textarea>
        </div>

        <div class="mb-6">
          <label for="font-size-slider" class="block mb-2 text-sm font-medium text-gray-300">å­—é«”å¤§å°: <span id="font-size-value">80</span>px</label>
          <input id="font-size-slider" type="range" min="10" max="300" value="80" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
        </div>
        <div class="mb-6">
          <label for="speed-slider" class="block mb-2 text-sm font-medium text-gray-300">æ»¾å‹•é€Ÿåº¦: <span id="speed-value">10</span>s</label>
          <input id="speed-slider" type="range" min="1" max="60" value="10" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
        </div>
        <div class="mb-6">
          <label class="block mb-2 text-sm font-medium text-gray-300">æ»¾å‹•æ–¹å‘</label>
          <div class="grid grid-cols-3 gap-3">
            <button data-direction="marquee-left" class="direction-btn p-3 bg-gray-700 rounded-lg">â† å‘å·¦</button>
            <button data-direction="none" class="direction-btn p-3 bg-indigo-600 rounded-lg">âšâš éœæ­¢</button>
            <button data-direction="marquee-right" class="direction-btn p-3 bg-gray-700 rounded-lg">å‘å³ â†’</button>
          </div>
        </div>

        <div class="mt-8 mb-4">
          <button id="back-home-btn" class="w-full text-center block bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg">è¿”å›é¦–é </button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDiXuuIQB9EJQZtW8zYuTByxr-Y5wMpRdc",
      authDomain: "led-run-c168b.firebaseapp.com",
      projectId: "led-run-c168b",
      storageBucket: "led-run-c168b.appspot.com",
      messagingSenderId: "555557259748",
      appId: "1:555557259748:web:7a79d35743bcbadbf11ff1",
      measurementId: "G-7JH5TLX99R"
    };

    let db;
    try { db = getFirestore(initializeApp(firebaseConfig)); } catch(e){ console.error("Firebase åˆå§‹åŒ–å¤±æ•—", e); alert("Firebase é€£ç·šå¤±æ•—ï¼"); }

    const homeView = document.getElementById('home-view'),
          displayView = document.getElementById('display-view'),
          controllerView = document.getElementById('controller-view');

    let currentSessionId = null, unsubscribe = null;

    // æ¥µç°¡é è¨­ï¼ˆèˆ‡ v20.6.3 ç›¸å®¹ï¼Œå¯è‡ªè¡Œæ“´å……ï¼‰
    const defaultSettings = {
      text: "Hello ğŸ‘‹",
      textColor: "#B96A00",
      backgroundColor: "#000000",
      fontSize: 80,
      scrollSpeed: 10,
      scrollDirection: "none",
      isBlinking: false,

      textColorMode: 'solid',
      bgColorMode: 'solid',
      gridColorMode: 'solid',

      gradientText: "linear-gradient(90deg, #e94057, #f27121)",
      gradientBg: "linear-gradient(90deg, #111827, #000000)",
      gradientGrid: "linear-gradient(90deg, #F8D24E, #FFD84A)",

      textBlendMode: 'normal',
      gapColor: "#000000",
      gapAlpha: 1.0,

      backgroundBorder: "none",
      backgroundEffect: "none",

      gridStyle: "none",
      gridSize: 20,
      gridColor: "#FFD84A",

      outlineColor: "#FF3B30",
      updatedAt: serverTimestamp()
    };

    window.addEventListener('load', ()=>{
      const params = new URLSearchParams(window.location.search);
      if (params.has('display')) startDisplayMode(params.get('display'));
      else if (params.has('controller')) startControllerMode(params.get('controller'));
      else showView('home');
    });

    function showView(name){
      [homeView, displayView, controllerView].forEach(v=>v.classList.add('hidden'));
      document.getElementById(`${name}-view`).classList.remove('hidden');
    }
    function generateId(){ return Math.random().toString(36).substring(2,8).toUpperCase(); }

    // æ›´ç·Šå¯†çš„é®ç½©åœ–ç£šï¼ˆå¯èˆ‡å‰ç‰ˆä¸€è‡´ï¼‰
    function gridMaskSVG(shape){
      if (shape==='square') return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='6' y='6' width='88' height='88' rx='12' ry='12' fill='black'/></svg>`;
      if (shape==='diamond') return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='16' y='16' width='68' height='68' transform='rotate(45 50 50)' fill='black'/></svg>`;
      return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='48' fill='black'/></svg>`;
    }
    function gapMaskSVG(shape){
      if (shape==='square') return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='white' fill-rule='evenodd' d='M0 0H100V100H0Z M6 6H94V94H6Z'/></svg>`;
      if (shape==='diamond') return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='white' fill-rule='evenodd' d='M0 0H100V100H0Z M50 7L93 50 50 93 7 50Z'/></svg>`;
      return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='white' fill-rule='evenodd' d='M0 0H100V100H0Z M50 50 m -48,0 a 48,48 0 1,0 96,0 a 48,48 0 1,0 -96,0 Z'/></svg>`;
    }

    function applySettings(els, settings, isPreview=false){
      const { textEl, containerEl, wrapperEl, bgEffectEl } = els;
      if (!textEl || !containerEl || !wrapperEl) return;

      const root = containerEl;
      root.style.setProperty('--text-color', settings.textColor);
      root.style.setProperty('--outline-color', settings.outlineColor || '#FF3B30');
      root.style.setProperty('--bg-color', settings.backgroundColor);
      root.style.setProperty('--grid-color', settings.gridColor);
      root.style.setProperty('--grid-gradient', settings.gradientGrid);
      root.style.setProperty('--gap-color', settings.gapColor || '#000000');
      root.style.setProperty('--gap-alpha', settings.gapAlpha != null ? settings.gapAlpha : 1);

      const isGridEnabled = settings.gridStyle && settings.gridStyle !== 'none';
      const perforateOn = (settings.textBlendMode==='multiply');

      // èƒŒæ™¯
      containerEl.classList.remove('effect-rainbow-frame');
      if (settings.backgroundEffect==='rainbow-frame') containerEl.classList.add('effect-rainbow-frame');
      containerEl.style.background = (settings.bgColorMode==='gradient') ? settings.gradientBg : settings.backgroundColor;

      // æ–‡å­—
      textEl.textContent = settings.text;
      const fontPx = isPreview ? Math.min(Number(settings.fontSize)||80, containerEl.clientHeight*0.8) : (Number(settings.fontSize)||80);
      textEl.style.fontSize = `${fontPx}px`;
      textEl.className = 'marquee-text';
      if (settings.textColorMode==='gradient'){
        textEl.classList.add('gradient-text');
        textEl.style.backgroundImage = settings.gradientText;
        textEl.style.color = '';
      } else {
        textEl.style.backgroundImage = '';
        textEl.style.color = settings.textColor;
      }
      if ((settings.textStyle||'normal')!=='normal') textEl.classList.add(`text-style-${settings.textStyle}`);

      // å‹•ç•«
      let anims = [];
      if (settings.scrollDirection!=='none') anims.push(`${settings.scrollDirection} ${Number(settings.scrollSpeed)||10}s linear infinite`);
      if (settings.isBlinking) anims.push('blink-effect 1s step-end infinite');
      textEl.style.animation = anims.join(', ');

      // ç½®ä¸­
      wrapperEl.style.display = settings.scrollDirection==='none' ? 'flex' : 'block';
      wrapperEl.style.justifyContent = settings.scrollDirection==='none' ? 'center' : '';

      // é®ç½©å°ºå¯¸ï¼ˆå…©å±¤ã€å« WebKitï¼‰
      const sizeNum = Number(settings.gridSize);
      const effSize = Number.isFinite(sizeNum) ? sizeNum : 20;
      const effPreview = isPreview ? Math.max(5, Math.min(100, Math.round(effSize/2))) : Math.max(5, Math.min(100, effSize));
      const gridSizePx = effPreview + 'px';
      const pair = gridSizePx + ' ' + gridSizePx;
      root.style.setProperty('--grid-size', gridSizePx);

      const gridBg = containerEl.querySelector('.grid-bg');
      const gap = containerEl.querySelector('.gap-overlay');

      if (gridBg) {
        if (isGridEnabled){
          gridBg.style.display = 'block';
          gridBg.style.maskSize = pair; gridBg.style.WebkitMaskSize = pair;
          gridBg.style.maskPosition = 'left top'; gridBg.style.WebkitMaskPosition = 'left top';
          root.style.setProperty('--grid-mask-image', `url("data:image/svg+xml;utf8,${encodeURIComponent(gridMaskSVG(settings.gridStyle))}")`);
          if (settings.gridColorMode==='gradient'){
            gridBg.classList.add('gradient-grid');
          } else {
            gridBg.classList.remove('gradient-grid');
            root.style.setProperty('--grid-color', settings.gridColor);
            gridBg.style.background = settings.gridColor;
          }
        } else {
          gridBg.style.display = 'none';
        }
      }

      if (gap) {
        if (isGridEnabled && perforateOn){
          gap.style.display = 'block';
          gap.style.maskSize = pair; gap.style.WebkitMaskSize = pair;
          gap.style.maskPosition = 'left top'; gap.style.WebkitMaskPosition = 'left top';
          root.style.setProperty('--gap-mask-image', `url("data:image/svg+xml;utf8,${encodeURIComponent(gapMaskSVG(settings.gridStyle))}")`);
        } else {
          gap.style.display = 'none';
        }
      }

      // é‚Šæ¡†
      containerEl.className = isPreview ? 'display-screen controller-preview' : 'display-screen';
      if (isGridEnabled) containerEl.classList.add('grid-enabled');
      if (settings.backgroundBorder && settings.backgroundBorder!=='none') containerEl.classList.add(`border-style-${settings.backgroundBorder}`);

      // èƒŒæ™¯ç‰¹æ•ˆ
      if (bgEffectEl){
        if ((settings.backgroundEffect||'none')==='eyes'){
          bgEffectEl.innerHTML = `<div class="eye"><div class="pupil"></div></div><div class="eye"><div class="pupil"></div></div>`;
        } else {
          bgEffectEl.innerHTML = '';
        }
      }
    }

    // é¡¯ç¤ºé¢æ¿ï¼šåˆå§‹åŒ–å³å…ˆç•«é è¨­ï¼ŒonSnapshot æœ‰è¶…æ™‚/éŒ¯èª¤å›é€€
    async function startDisplayMode(sessionId){
      currentSessionId = sessionId; showView('display');

      const displayEls = {
        textEl: document.getElementById('marquee-text'),
        containerEl: document.getElementById('display-screen'),
        wrapperEl: document.getElementById('marquee-container-wrapper'),
        bgEffectEl: document.getElementById('background-effects-container')
      };
      applySettings(displayEls, defaultSettings); // å…ˆè¡Œå‘ˆç¾ï¼Œé¿å…å¡åœ¨ã€Œè«‹ç¨å€™â€¦ã€

      document.getElementById('session-id-display').textContent = sessionId;
      const url = `${window.location.href.split('?')}?controller=${sessionId}`;
      document.getElementById('qrcode-container').innerHTML = '';
      new QRCode(document.getElementById("qrcode-container"), { text:url, width:128, height:128 });

      const ref = doc(db,"sessions",sessionId);
      try{
        const snap = await getDoc(ref);
        if (!snap.exists()) await setDoc(ref, defaultSettings);
        listenToChanges(sessionId, displayEls);
      }catch(e){
        console.error('Firestore è®€å¯«å¤±æ•—', e);
        // ç¶­æŒé è¨­ç•«é¢å³å¯
      }
      setupDisplayListeners();
    }

    function listenToChanges(sessionId, displayEls){
      if (unsubscribe) unsubscribe();
      const ref = doc(db,"sessions",sessionId);

      let gotFirstSnapshot = false;
      const timeoutId = setTimeout(()=>{
        if (!gotFirstSnapshot){
          console.warn('onSnapshot è¶…æ™‚ï¼Œç¶­æŒé è¨­é¡¯ç¤º');
          // ä¿æŒ defaultSettings ç•«é¢ï¼Œä¸åšä¸­æ–·
        }
      }, 3000);

      unsubscribe = onSnapshot(ref, (docSnap)=>{
        gotFirstSnapshot = true;
        clearTimeout(timeoutId);
        if (docSnap.exists()){
          const settings = { ...defaultSettings, ...docSnap.data() };
          applySettings(displayEls, settings);
        } else {
          applySettings(displayEls, defaultSettings);
        }
      }, (error)=>{
        clearTimeout(timeoutId);
        console.error('onSnapshot ç›£è½éŒ¯èª¤', error);
        applySettings(displayEls, defaultSettings);
      });
    }

    async function startControllerMode(sessionId){
      currentSessionId = sessionId; showView('controller');
      document.getElementById('controller-session-id').textContent = sessionId;

      const ref = doc(db,"sessions",sessionId);
      const snap = await getDoc(ref);
      let loaded;
      if (snap.exists()){
        const raw = snap.data();
        loaded = { ...defaultSettings, ...raw };
      } else {
        await setDoc(ref, defaultSettings);
        loaded = { ...defaultSettings };
      }
      updateControllerUI(loaded);
      setupControllerListeners();
    }

    function updateControllerUI(settings){
      document.getElementById('text-input').value = settings.text;
      document.getElementById('font-size-slider').value = settings.fontSize;
      document.getElementById('font-size-value').textContent = settings.fontSize;
      document.getElementById('speed-slider').value = settings.scrollSpeed;
      document.getElementById('speed-value').textContent = settings.scrollSpeed;

      // é è¦½
      updatePreview();
    }

    function setupControllerListeners(){
      document.getElementById('back-home-btn').addEventListener('click', ()=>showView('home'));

      ['text-input','font-size-slider','speed-slider'].forEach(id=>{
        const el = document.getElementById(id);
        el.addEventListener('input', updateSession);
      });

      document.querySelectorAll('.direction-btn').forEach(btn=>{
        btn.addEventListener('click',(e)=>{
          document.querySelectorAll('.direction-btn').forEach(b=>b.classList.replace('bg-indigo-600','bg-gray-700'));
          e.currentTarget.classList.replace('bg-gray-700','bg-indigo-600');
          updateSession();
        });
      });
    }

    function getSettings(){
      return {
        text: document.getElementById('text-input').value,
        fontSize: document.getElementById('font-size-slider').value,
        scrollSpeed: document.getElementById('speed-slider').value,
        scrollDirection: document.querySelector('.direction-btn.bg-indigo-600')?.dataset.direction || 'none',
        isBlinking: false,

        textColorMode: 'solid',
        bgColorMode: 'solid',
        gridColorMode: 'solid',

        textColor: defaultSettings.textColor,
        backgroundColor: defaultSettings.backgroundColor,
        gridColor: defaultSettings.gridColor,

        gradientText: defaultSettings.gradientText,
        gradientBg: defaultSettings.gradientBg,
        gradientGrid: defaultSettings.gradientGrid,

        textBlendMode: defaultSettings.textBlendMode,
        gapColor: defaultSettings.gapColor,
        gapAlpha: defaultSettings.gapAlpha,

        outlineColor: defaultSettings.outlineColor,
        textStyle: 'normal',
        backgroundBorder: 'none',
        backgroundEffect: 'none',

        gridStyle: 'none',
        gridSize: defaultSettings.gridSize
      };
    }

    let lastSettings = {};
    function updateSession(){
      if (!currentSessionId) { updatePreview(); return; }
      const settings = getSettings();
      const diff = {};
      for (const k in settings){ if (settings[k] !== lastSettings[k]) diff[k] = settings[k]; }
      if (Object.keys(diff).length){
        diff.updatedAt = serverTimestamp();
        setDoc(doc(db,"sessions",currentSessionId), diff, { merge:true });
      }
      lastSettings = settings;
      updateControllerUI(settings);
    }

    function updatePreview(){
      const settings = getSettings();
      applySettings({
        textEl: document.getElementById('preview-marquee-text'),
        containerEl: document.getElementById('controller-preview'),
        wrapperEl: document.getElementById('preview-marquee-container-wrapper')
      }, settings, true);
    }

    // å°è¦½
    document.getElementById('create-display-btn').addEventListener('click', ()=>{
      window.location.href = `${window.location.href.split('?')}?display=${generateId()}`;
    });
    document.getElementById('open-controller-btn').addEventListener('click', ()=>{
      const id = document.getElementById('session-id-input').value.trim().toUpperCase();
      if (id) window.location.href = `${window.location.href.split('?')}?controller=${id}`;
      else alert('è«‹è¼¸å…¥é¢æ¿ ID');
    });

    // é¡¯ç¤ºé äº’å‹•
    function setupDisplayListeners(){
      const info = document.getElementById('info-overlay');
      document.getElementById('display-view').addEventListener('click',(e)=>{
        if (!e.target.closest('#fullscreen-btn') && !e.target.closest('#info-overlay')) info.classList.toggle('opacity-0');
      });
      setTimeout(()=>info.classList.add('opacity-0'), 5000);
      document.getElementById('fullscreen-btn').addEventListener('click', ()=>{
        if (!document.fullscreenElement) document.documentElement.requestFullscreen();
        else document.exitFullscreen();
      });
    }
  </script>
</body>
</html>
