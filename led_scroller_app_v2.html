<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>遠端遙控 LED 跑馬燈 v22.1.42 (FontMode Refit)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Noto+Serif+TC:wght@400;700&family=ZCOOL+KuaiLe&family=Cutive+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
  html,body{height:100%;margin:0;padding:0;background:#0f172a}
  body{font-family:'Inter','微軟正黑體',sans-serif;overscroll-behavior:none}
  .led-font{font-family:'DotGothic16',sans-serif}
  @keyframes marquee-left{from{transform:translateX(100vw)}to{transform:translateX(-100%)}}
  @keyframes marquee-right{from{transform:translateX(-100%)}to{transform:translateX(100vw)}}
  .marquee-text{font-size:var(--font-size,80px);color:var(--text-color,#fff);white-space:nowrap;display:inline-block;line-height:1.1;position:relative;z-index:1}
  .display-screen{width:100%;height:100%;position:relative;background:var(--bg-color,#000);box-sizing:border-box;isolation:isolate}
  .marquee-container-wrapper{position:absolute;top:50%;left:0;width:100%;transform:translateY(-50%);overflow:hidden;z-index:2}
  .controller-preview{height:120px;position:relative;background:var(--bg-color,#000);outline:1px solid #374151;box-sizing:border-box;isolation:isolate}
  .controller-preview .marquee-text{font-size:var(--font-size,40px)}
  .no-scrollbar::-webkit-scrollbar{display:none}
  .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
</style>
</head>
<body class="text-white">
<div id="app-container" class="h-full w-full">
  <div id="home-view" class="flex flex-col items-center justify-center h-full p-8 text-center bg-gray-900">
    <h1 class="text-5xl font-bold mb-4 led-font">LED Scroller</h1>
    <p class="text-gray-400 mb-12">數位跑馬燈・遠端遙控</p>
    <div class="space-y-4 w-full max-w-xs">
      <button id="create-display-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">建立新的顯示面板</button>
      <p class="text-gray-500">或</p>
      <div class="relative">
        <input type="text" id="session-id-input" placeholder="輸入面板 ID 進入控制台" class="w-full bg-gray-800 border border-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <button id="open-controller-btn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-3 rounded-md">進入</button>
      </div>
    </div>
    <p class="text-gray-600 mt-12 text-sm">提示：在設備 A 建立顯示面板，然後在設備 B 輸入面板 ID 進行遙控。</p>
  </div>

  <div id="display-view" class="hidden h-full w-full">
    <div class="display-screen" id="display-screen">
      <div class="marquee-container-wrapper" id="marquee-container-wrapper">
        <div class="marquee-text" id="marquee-text"><span>請稍候...</span></div>
      </div>
    </div>
    <div id="info-overlay" class="absolute top-4 left-4 bg-black bg-opacity-70 p-4 rounded-lg text-white transition-opacity duration-500">
      <p class="text-sm">輕觸螢幕可隱藏/顯示此資訊</p>
      <p id="session-id-display" class="font-mono text-lg my-2 bg-gray-700 px-2 py-1 rounded"></p>
      <div id="qrcode-container" class="p-2 bg-white rounded-md mt-2"></div>
    </div>
    <button id="fullscreen-btn" class="absolute bottom-4 right-4 text-white bg-black bg-opacity-50 p-3 rounded-full hover:bg-opacity-75 transition" aria-label="fullscreen">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
    </button>
  </div>

  <div id="controller-view" class="hidden h-full w-full bg-gray-800 overflow-y-auto no-scrollbar">
    <div class="p-6 max-w-md mx-auto">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold led-font">控制台</h2>
        <p class="text-sm text-gray-400 font-mono">ID: <span id="controller-session-id"></span></p>
      </div>

      <div class="sticky-preview">
        <label class="block mb-2 text-sm font-medium text-gray-300">效果預覽</label>
        <div class="controller-preview" id="controller-preview">
          <div class="marquee-container-wrapper" id="preview-marquee-container-wrapper">
            <div class="marquee-text" id="preview-marquee-text"></div>
          </div>
        </div>
      </div>

      <div class="mb-6 mt-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">顯示文字</label>
        <textarea id="text-input" rows="3" class="w-full bg-gray-700 border border-gray-600 text-white text-lg p-2.5 rounded-lg" placeholder="在此輸入文字..."></textarea>
      </div>

      <div class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-300">字體模式</label>
        <div class="grid grid-cols-2 gap-3">
          <button data-mode="fixed" class="font-mode-btn p-3 bg-gray-700 rounded-lg text-sm">固定大小</button>
          <button data-mode="fitHeight" class="font-mode-btn p-3 bg-indigo-600 rounded-lg text-sm">填滿高度</button>
          <button data-mode="fitWidth" class="font-mode-btn p-3 bg-gray-700 rounded-lg text-sm">填滿寬度</button>
          <button data-mode="multiline" class="font-mode-btn p-3 bg-gray-700 rounded-lg text-sm">自動換行</button>
        </div>
      </div>

      <div id="font-size-controls" class="mb-6">
        <label id="font-size-label" for="font-size-slider" class="block mb-2 text-sm font-medium text-gray-300">高度佔比: <span id="font-size-value">95</span>%</label>
        <input id="font-size-slider" type="range" min="10" max="100" value="95" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
      </div>

      <div class="mb-6">
        <label for="speed-slider" class="block mb-2 text-sm font-medium text-gray-300">滾動速度: <span id="speed-value">10</span>s</label>
        <input id="speed-slider" type="range" min="1" max="60" value="10" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
      </div>

      <div class="mt-8 mb-4">
        <a href="#" onclick="window.location.search='';return false" class="w-full text-center block bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg">返回首頁</a>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = { apiKey:"AIzaSyDiXuuIQB9EJQZtW8zYuTByxr-Y5wMpRdc", authDomain:"led-run-c168b.firebaseapp.com", projectId:"led-run-c168b", storageBucket:"led-run-c168b.appspot.com", messagingSenderId:"555557259748", appId:"1:555557259748:web:7a79d35743bcbadbf11ff1", measurementId:"G-7JH5TLX99R" };
  let db; try { db = getFirestore(initializeApp(firebaseConfig)); } catch(e){ console.error("Firebase 初始化失敗", e); alert("Firebase 連線失敗！"); }

  const $ = id => document.getElementById(id);
  const btn = sel => Array.from(document.querySelectorAll(sel));

  let currentSessionId = null, unsubscribe = null;

  // 分離儲存
  let fillHeightPercentage = 95; // %
  let fixedFontSize = 100;       // px
  let lastMeasuredFontPx = 40;   // 提供切換時的初始值，降低跳動

  const defaultSettings = {
    text: "Hello 👋",
    backgroundColor: "#000000",
    textColor: "#FFFFFF",
    fontFamily: "'Inter','微軟正黑體',sans-serif",
    fontSizeMode: "fitHeight",
    fontSize: 95,
    fixedFontSize: 100,
    scrollSpeed: 10,
    scrollDirection: "none",
    updatedAt: serverTimestamp()
  };

  function showView(name){
    ['home','display','controller'].forEach(v=>$(v+'-view').classList.add('hidden'));
    $(name+'-view').classList.remove('hidden');
  }

  window.addEventListener('load', ()=>{
    const params = new URLSearchParams(location.search);
    if (params.has('display')) startDisplayMode(params.get('display'));
    else if (params.has('controller')) startControllerMode(params.get('controller'));
    else showView('home');
  });

  $('create-display-btn').addEventListener('click', ()=>{
    const id = Math.random().toString(36).slice(2,8).toUpperCase();
    location.search='?display='+id;
  });

  $('open-controller-btn').addEventListener('click', ()=>{
    const id = $('session-id-input').value.trim();
    if (!id) return;
    location.search='?controller='+id;
  });

  function measureTextHeight(textEl){
    const r = textEl.getBoundingClientRect();
    return r.height || parseFloat(getComputedStyle(textEl).fontSize)||40;
  }

  // 二分搜尋：使實際高度貼近 targetH
  function fitHeightByBinary(textEl, wrapperEl, targetH){
    let lo = 4, hi = 1600, best = lastMeasuredFontPx;
    for (let i=0;i<14;i++){
      const mid = Math.floor((lo+hi)/2);
      textEl.style.fontSize = mid+'px';
      const h = measureTextHeight(textEl);
      if (h <= targetH){ best = mid; lo = mid+1; } else { hi = mid-1; }
    }
    textEl.style.fontSize = best+'px';
    lastMeasuredFontPx = best;
    return best;
  }

  function fitWidthByBinary(textEl, wrapperEl, maxW){
    let lo = 4, hi = 1600, best = lastMeasuredFontPx;
    for (let i=0;i<14;i++){
      const mid = Math.floor((lo+hi)/2);
      textEl.style.fontSize = mid+'px';
      const w = textEl.getBoundingClientRect().width;
      if (w <= maxW){ best = mid; lo = mid+1; } else { hi = mid-1; }
    }
    textEl.style.fontSize = best+'px';
    lastMeasuredFontPx = best;
    return best;
  }

  function applySettings(els, s){
    const { textEl, wrapperEl, containerEl } = els;
    textEl.style.fontFamily = s.fontFamily;
    textEl.style.setProperty('--text-color', s.textColor);
    containerEl.style.setProperty('--bg-color', s.backgroundColor);
    textEl.textContent = s.text;

    // 方向
    textEl.style.animation = 'none';
    if (s.scrollDirection==='marquee-left'){
      const dur = Math.max(1, Number(s.scrollSpeed)||10);
      textEl.style.animation = `marquee-left ${dur}s linear infinite`;
    } else if (s.scrollDirection==='marquee-right'){
      const dur = Math.max(1, Number(s.scrollSpeed)||10);
      textEl.style.animation = `marquee-right ${dur}s linear infinite`;
    }

    // 模式
    textEl.style.whiteSpace = 'nowrap';
    const wr = wrapperEl.getBoundingClientRect();
    if (s.fontSizeMode==='fixed'){
      textEl.style.fontSize = (Number(s.fixedFontSize)||100)+'px';
      textEl.style.lineHeight = '1.1';
      lastMeasuredFontPx = Number(s.fixedFontSize)||100;
    } else if (s.fontSizeMode==='fitHeight'){
      const percent = Math.min(100, Math.max(10, Number(s.fontSize)||95));
      const targetH = Math.max(8, wr.height) * (percent/100);
      textEl.style.lineHeight = '1.05';
      fitHeightByBinary(textEl, wrapperEl, targetH);
    } else if (s.fontSizeMode==='fitWidth'){
      const maxW = Math.max(8, wr.width);
      textEl.style.lineHeight = '1.05';
      fitWidthByBinary(textEl, wrapperEl, maxW);
    } else if (s.fontSizeMode==='multiline'){
      textEl.style.whiteSpace = 'normal';
      textEl.style.lineHeight = '1.25';
      // 以容器高 40% 當基準
      const basis = Math.max(10, containerEl.getBoundingClientRect().height||200);
      const px = Math.floor(basis*0.4);
      textEl.style.fontSize = px+'px';
      lastMeasuredFontPx = px;
    }
  }

  function getPreviewEls(){
    return { textEl:$('preview-marquee-text'), wrapperEl:$('preview-marquee-container-wrapper'), containerEl:$('controller-preview') };
  }
  function getDisplayEls(){
    return { textEl:$('marquee-text'), wrapperEl:$('marquee-container-wrapper'), containerEl:$('display-screen') };
  }

  function updateFontSizeUIByMode(mode){
    const box = $('font-size-controls');
    const slider = $('font-size-slider');
    const label = $('font-size-label');
    if (mode==='fitHeight'){
      box.style.display = 'block';
      slider.min='10'; slider.max='100'; slider.value=String(fillHeightPercentage);
      label.innerHTML = `高度佔比: <span id="font-size-value">${fillHeightPercentage}</span>%`;
    }else if(mode==='fixed'){
      box.style.display = 'block';
      slider.min='10'; slider.max='500'; slider.value=String(fixedFontSize);
      label.innerHTML = `字體大小: <span id="font-size-value">${fixedFontSize}</span>px`;
    }else{
      box.style.display = 'none';
    }
  }

  async function startDisplayMode(sessionId){
    currentSessionId = sessionId; showView('display');
    $('session-id-display').textContent = sessionId;
    new QRCode($('qrcode-container'), { text: location.href.split('?')[0]+`?controller=${sessionId}`, width:128, height:128 });

    const ref = doc(db,'sessions',sessionId);
    const snap = await getDoc(ref);
    if (!snap.exists()) await setDoc(ref, defaultSettings);

    const els = getDisplayEls();
    applySettings(els, snap.exists()?{...defaultSettings,...snap.data()}:defaultSettings);

    if (unsubscribe) unsubscribe();
    unsubscribe = onSnapshot(ref, (ds)=>{
      if (!ds.exists()) return;
      const s = { ...defaultSettings, ...ds.data() };
      applySettings(els, s);
    });

    const info = $('info-overlay');
    setTimeout(()=>info.classList.add('opacity-0'), 4000);
    $('display-view').addEventListener('click',(e)=>{
      if (!e.target.closest('#fullscreen-btn') && !e.target.closest('#info-overlay')) info.classList.toggle('opacity-0');
    });
    $('fullscreen-btn').addEventListener('click', ()=>{
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else document.exitFullscreen();
    });
  }

  async function startControllerMode(sessionId){
    currentSessionId = sessionId; showView('controller');
    $('controller-session-id').textContent = sessionId;

    const ref = doc(db,'sessions',sessionId);
    const snap = await getDoc(ref);
    if (!snap.exists()) await setDoc(ref, defaultSettings);
    const state = snap.exists()?{...defaultSettings,...snap.data()}:defaultSettings;

    // 初始化本地值
    fillHeightPercentage = Number(state.fontSize)||95;
    fixedFontSize = Number(state.fixedFontSize)||100;

    // 初始 UI
    $('text-input').value = state.text;
    $('speed-slider').value = state.scrollSpeed;
    $('speed-value').textContent = String(state.scrollSpeed);
    btn('.font-mode-btn').forEach(b=>{
      b.classList.toggle('bg-indigo-600', b.dataset.mode===state.fontSizeMode);
      b.classList.toggle('bg-gray-700', b.dataset.mode!==state.fontSizeMode);
    });
    updateFontSizeUIByMode(state.fontSizeMode);
    applySettings(getPreviewEls(), state);

    // 文本
    $('text-input').addEventListener('input', async (e)=>{
      state.text = e.target.value;
      await updateDoc(ref, { text: state.text, updatedAt: serverTimestamp() });
      applySettings(getPreviewEls(), state);
    });

    // 速度
    $('speed-slider').addEventListener('input', async (e)=>{
      const v = Number(e.target.value)||10;
      $('speed-value').textContent = String(v);
      state.scrollSpeed = v;
      await updateDoc(ref, { scrollSpeed: v, updatedAt: serverTimestamp() });
      applySettings(getPreviewEls(), state);
    });

    // 模式切換（不依賴樣式作為狀態）
    btn('.font-mode-btn').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const mode = b.dataset.mode;
        state.fontSizeMode = mode;
        btn('.font-mode-btn').forEach(x=>{
          x.classList.toggle('bg-indigo-600', x===b);
          x.classList.toggle('bg-gray-700', x!==b);
        });
        if (mode==='fixed') state.fixedFontSize = fixedFontSize;
        if (mode==='fitHeight') state.fontSize = fillHeightPercentage;
        updateFontSizeUIByMode(mode);
        await updateDoc(ref, { fontSizeMode: mode, fontSize: state.fontSize, fixedFontSize: state.fixedFontSize, updatedAt: serverTimestamp() });
        applySettings(getPreviewEls(), state);
      });
    });

    // Slider：依目前模式寫入不同欄位，並立即重算
    $('font-size-slider').addEventListener('input', async (e)=>{
      const mode = (document.querySelector('.font-mode-btn.bg-indigo-600')?.dataset.mode) || state.fontSizeMode;
      const val = Number(e.target.value);
      if (mode==='fitHeight'){
        fillHeightPercentage = Math.min(100, Math.max(10, val));
        $('font-size-label').innerHTML = `高度佔比: <span id="font-size-value">${fillHeightPercentage}</span>%`;
        state.fontSize = fillHeightPercentage;
        await updateDoc(ref, { fontSize: state.fontSize, updatedAt: serverTimestamp() });
      } else if (mode==='fixed'){
        fixedFontSize = Math.min(500, Math.max(10, val));
        $('font-size-label').innerHTML = `字體大小: <span id="font-size-value">${fixedFontSize}</span>px`;
        state.fixedFontSize = fixedFontSize;
        await updateDoc(ref, { fixedFontSize: state.fixedFontSize, updatedAt: serverTimestamp() });
      } else {
        return;
      }
      applySettings(getPreviewEls(), state);
    });
  }
</script>
</body>
</html>
