<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>é ç«¯é™æ§ LED è·‘é¦¬ç‡ˆ v11.5ï¼ˆæŒ‰éˆ•å¯é»ï¼‹è‡ªæˆ‘æª¢æ¸¬ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    html, body { height:100%; margin:0; background:#0f172a; }
    body { font-family:'Inter','å¾®è»Ÿæ­£é»‘é«”',sans-serif; overscroll-behavior:none; }

    .led-font { font-family:'DotGothic16',sans-serif; }

    /* å‹•ç•« */
    @keyframes marquee-left { from { transform: translateX(100vw);} to { transform: translateX(-100%);} }
    @keyframes marquee-right{ from { transform: translateX(-100%);} to { transform: translateX(100vw);} }
    @keyframes blink-effect { 50% { opacity:0; } }
    @keyframes eye-blink-anim { 0%,40%,100%{ transform:scaleY(1);} 42%{ transform:scaleY(0.1);} }
    @keyframes eye-move-anim { 0%,20%{ transform:translateX(0);} 30%,50%{ transform:translateX(-10px);} 60%,80%{ transform:translateX(10px);} 90%,100%{ transform:translateX(0);} }

    /* è¦–åœ–éš”é›¢ï¼šéš±è—æ™‚ä¸å¯äº’å‹• */
    .view.hidden { display:none !important; pointer-events:none !important; } /* Tailwind hidden + äº‹ä»¶é˜»æ“‹åŠ å¼· */ [data-inert] * { pointer-events:none !important; } /* inert Polyfill æœ€å°åŒ– */ 

    .display-screen { width:100%; height:100%; overflow:hidden; position:relative; background:var(--bg-color,#000); box-sizing:border-box; }
    .marquee-container-wrapper { position:absolute; top:50%; left:0; width:100%; transform:translateY(-50%); overflow:hidden; z-index:1; } /* åƒ…åœ¨é¡¯ç¤ºç«¯ä½¿ç”¨ï¼Œæ§åˆ¶å°é è¦½ä¸è¦†è“‹å…¶ä»–å€å¡Š */ 
    #background-effects-container { position:absolute; inset:0; display:flex; justify-content:center; align-items:center; gap:20px; pointer-events:none; z-index:0; } /* éäº’å‹•å±¤ç¦ç”¨æŒ‡æ¨™ */ 

    .eye { width:80px; height:80px; background:#fff; border-radius:50%; position:relative; animation: eye-blink-anim 5s infinite; overflow:hidden; }
    .pupil { width:40px; height:40px; background:#222; border-radius:50%; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); animation: eye-move-anim 10s infinite; }

    .marquee-text { font-size:var(--font-size,80px); color:var(--text-color,#FFFFFF); white-space:nowrap; display:inline-block; text-shadow:none; transition:text-shadow .2s; line-height:1.1; }
    .gradient-text { background-clip:text; -webkit-background-clip:text; color:transparent; -webkit-text-fill-color:transparent; }

    .text-style-glow { text-shadow:0 0 8px var(--text-color,#FFFFFF), 0 0 12px var(--text-color,#FFFFFF); }
    .text-style-outline {
      text-shadow:
        -2px -2px 0 var(--outline-color),
         2px -2px 0 var(--outline-color),
        -2px  2px 0 var(--outline-color),
         2px  2px 0 var(--outline-color),
        -3px  0   0 var(--outline-color),
         3px  0   0 var(--outline-color),
         0   -3px 0 var(--outline-color),
         0    3px 0 var(--outline-color);
    }

    /* æ§åˆ¶å°é è¦½ï¼šæ°¸é ä¸æ””æˆªé»æ“Š */
    .controller-preview { height:120px; border-radius:.5rem; position:relative; overflow:hidden; background:var(--bg-color,#000); border:1px solid #374151; box-sizing:border-box; pointer-events:none; } /* ç¦ç”¨æŒ‡æ¨™ï¼Œé¿å…è¦†è“‹ä¸‹æ–¹æ§åˆ¶å…ƒä»¶ */ 
    .controller-preview .marquee-text { font-size: var(--font-size,40px) !important; }

    .no-scrollbar::-webkit-scrollbar { display:none; }
    .no-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }
    .control-btn-active { box-shadow:0 0 0 3px #4f46e5; }
    /* æ¸¬è©¦è¨Šæ¯ */
    #test-toast { position:fixed; bottom:12px; left:12px; background:rgba(0,0,0,.75); color:#fff; padding:8px 12px; border-radius:8px; font-size:12px; z-index:50; display:none; }
  </style>
</head>
<body class="text-white">
  <div id="app-container" class="h-full w-full">
    <!-- 1. é¦–é  -->
    <div id="home-view" class="view hidden flex flex-col items-center justify-center h-full p-8 text-center bg-gray-900">
      <h1 class="text-5xl font-bold mb-4 led-font">LED Scroller</h1>
      <p class="text-gray-400 mb-12">æ•¸ä½è·‘é¦¬ç‡ˆãƒ»é ç«¯é™æ§</p>
      <div class="space-y-4 w-full max-w-xs">
        <button id="create-display-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">å»ºç«‹æ–°çš„é¡¯ç¤ºé¢æ¿</button>
        <p class="text-gray-500">æˆ–</p>
        <div class="relative">
          <input id="session-id-input" type="text" placeholder="è¼¸å…¥é¢æ¿ ID é€²å…¥æ§åˆ¶å°" class="w-full bg-gray-800 border border-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <button id="open-controller-btn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-3 rounded-md">é€²å…¥</button>
        </div>
      </div>
      <p class="text-gray-600 mt-12 text-sm">æç¤ºï¼šåœ¨è¨­å‚™ A å»ºç«‹é¡¯ç¤ºé¢æ¿ï¼Œ<br>ç„¶å¾Œåœ¨è¨­å‚™ B è¼¸å…¥é¢æ¿ ID é€²è¡Œé™æ§ã€‚</p>
    </div>

    <!-- 2. é¡¯ç¤ºé¢æ¿ -->
    <div id="display-view" class="view hidden h-full w-full">
      <div id="display-screen" class="display-screen">
        <div id="background-effects-container"></div>
        <div id="marquee-container-wrapper" class="marquee-container-wrapper">
          <div id="marquee-text" class="marquee-text"><span>è«‹ç¨å€™...</span></div>
        </div>
      </div>
      <div id="info-overlay" class="absolute top-4 left-4 bg-black bg-opacity-70 p-4 rounded-lg text-white transition-opacity duration-500">
        <p class="text-sm">è¼•è§¸è¢å¹•å¯éš±è—/é¡¯ç¤ºæ­¤è³‡è¨Š</p>
        <p id="session-id-display" class="font-mono text-lg my-2 bg-gray-700 px-2 py-1 rounded"></p>
        <div id="qrcode-container" class="p-2 bg-white rounded-md mt-2"></div>
      </div>
      <button id="fullscreen-btn" aria-label="fullscreen" class="absolute bottom-4 right-4 text-white bg-black bg-opacity-50 p-3 rounded-full hover:bg-opacity-75 transition">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
      </button>
    </div>

    <!-- 3. æ§åˆ¶å° -->
    <div id="controller-view" class="view hidden h-full w-full bg-gray-800 overflow-y-auto no-scrollbar">
      <div class="p-6 max-w-md mx-auto">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold led-font">æ§åˆ¶å°</h2>
          <p class="text-sm text-gray-400 font-mono">ID: <span id="controller-session-id"></span></p>
        </div>

        <div class="mb-6">
          <label class="block mb-2 text-sm font-medium text-gray-300">æ•ˆæœé è¦½</label>
          <div class="controller-preview">
            <div id="preview-marquee-container-wrapper" class="marquee-container-wrapper">
              <div id="preview-marquee-text" class="marquee-text"></div>
            </div>
          </div>
        </div>

        <div class="mb-6">
          <label for="text-input" class="block mb-2 text-sm font-medium text-gray-300">é¡¯ç¤ºæ–‡å­—</label>
          <textarea id="text-input" rows="3" class="w-full bg-gray-700 border border-gray-600 text-white text-lg p-2.5 rounded-lg" placeholder="åœ¨æ­¤è¼¸å…¥æ–‡å­—..."></textarea>
        </div>

        <div class="mb-6 p-4 bg-gray-900 rounded-lg">
          <div class="flex border-b border-gray-700 mb-4">
            <div id="color-tab" class="flex -mb-px">
              <button data-tab="solid" class="tab-btn text-white py-2 px-4 border-b-2 border-indigo-500 font-medium">ç´”è‰²</button>
              <button data-tab="gradient" class="tab-btn text-gray-400 py-2 px-4 border-b-2 border-transparent">æ¼¸å±¤</button>
            </div>
          </div>
          <div id="solid-color-panel">
            <label class="block mb-2 text-sm font-medium text-gray-300">æ–‡å­—é¡è‰²</label>
            <div id="text-color-picker" class="flex flex-wrap gap-3 mb-4"></div>
            <label class="block mb-2 text-sm font-medium text-gray-300">èƒŒæ™¯é¡è‰²</label>
            <div id="bg-color-picker" class="flex flex-wrap gap-3"></div>
          </div>
          <div id="gradient-color-panel" class="hidden">
            <label class="block mb-2 text-sm font-medium text-gray-300">æ–‡å­—æ¼¸å±¤</label>
            <div id="text-gradient-picker" class="flex flex-wrap gap-2 mb-4"></div>
            <label class="block mb-2 text-sm font-medium text-gray-300">èƒŒæ™¯æ¼¸å±¤</label>
            <div id="bg-gradient-picker" class="flex flex-wrap gap-2"></div>
          </div>
        </div>

        <div class="mb-6">
          <label class="block mb-2 text-sm font-medium text-gray-300">æ–‡å­—é¢¨æ ¼</label>
          <div class="flex flex-wrap gap-3">
            <button data-style="normal" class="text-style-btn p-3 bg-indigo-600 rounded-lg text-sm">æ¨™æº–</button>
            <button data-style="glow" class="text-style-btn p-3 bg-gray-700 rounded-lg text-sm">âœ¨ ç™¼å…‰</button>
            <button data-style="outline" class="text-style-btn p-3 bg-gray-700 rounded-lg text-sm">âœï¸ é‚Šæ¡†</button>
          </div>
        </div>

        <div id="outline-color-section" class="mb-6 hidden">
          <label class="block mb-2 text-sm font-medium text-gray-300">é‚Šæ¡†é¡è‰²</label>
          <div id="outline-color-picker" class="flex flex-wrap gap-3"></div>
        </div>

        <div class="mb-6">
          <label for="font-size-slider" class="block mb-2 text-sm font-medium text-gray-300">å­—é«”å¤§å°: <span id="font-size-value">80</span>px</label>
          <input id="font-size-slider" type="range" min="10" max="300" value="80" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
        </div>
        <div class="mb-6">
          <label for="speed-slider" class="block mb-2 text-sm font-medium text-gray-300">æ»¾å‹•é€Ÿåº¦: <span id="speed-value">10</span>s</label>
          <input id="speed-slider" type="range" min="1" max="60" value="10" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
        </div>
        <div class="mb-6">
          <label class="block mb-2 text-sm font-medium text-gray-300">æ»¾å‹•æ–¹å‘</label>
          <div class="grid grid-cols-3 gap-3">
            <button data-direction="marquee-left" class="direction-btn p-3 bg-gray-700 rounded-lg">â† å‘å·¦</button>
            <button data-direction="none" class="direction-btn p-3 bg-indigo-600 rounded-lg">âšâš éœæ­¢</button>
            <button data-direction="marquee-right" class="direction-btn p-3 bg-gray-700 rounded-lg">å‘å³ â†’</button>
          </div>
        </div>

        <div class="mb-6">
          <label class="block mb-2 text-sm font-medium text-gray-300">æ–‡å­—ç‰¹æ•ˆ</label>
          <div class="flex flex-wrap gap-4">
            <label class="relative inline-flex items-center cursor-pointer">
              <input id="blink-toggle" type="checkbox" class="sr-only peer">
              <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
              <span class="ml-3 text-sm font-medium text-gray-300">æ–‡å­—é–ƒçˆ</span>
            </label>
          </div>
        </div>

        <div class="mb-6">
          <label class="block mb-2 text-sm font-medium text-gray-300">èƒŒæ™¯é‚Šæ¡†</label>
          <div class="flex flex-wrap gap-3">
            <button data-border="none" class="border-style-btn p-3 bg-indigo-600 rounded-lg text-sm">ç„¡</button>
            <button data-border="solid" class="border-style-btn p-3 bg-gray-700 rounded-lg text-sm">â¬œï¸ å¯¦ç·š</button>
            <button data-border="rainbow" class="border-style-btn p-3 bg-gray-700 rounded-lg text-sm">ğŸŒˆ æ¼¸è®Š</button>
          </div>
        </div>

        <div class="mt-8 mb-4">
          <a href="./led_scroller_app_v3.html" class="w-full text-center block bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg">è¿”å›é¦–é </a>
        </div>
      </div>
    </div>
  </div>

  <div id="test-toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDiXuuIQB9EJQZtW8zYuTByxr-Y5wMpRdc",
      authDomain: "led-run-c168b.firebaseapp.com",
      projectId: "led-run-c168b",
      storageBucket: "led-run-c168b.appspot.com",
      messagingSenderId: "555557259748",
      appId: "1:555557259748:web:7a79d35743bcbadbf11ff1",
      measurementId: "G-7JH5TLX99R"
    };

    let db;
    try { db = getFirestore(initializeApp(firebaseConfig)); } catch (e) { console.error("Firebase åˆå§‹åŒ–å¤±æ•—", e); }

    // è¦–åœ–é¡¯ç¤ºè¼”åŠ©ï¼šåŒæ™‚æ§åˆ¶ hidden / pointer-events / inert
    function showView(name){
      const views = ['home','display','controller'];
      views.forEach(v=>{
        const el = document.getElementById(`${v}-view`);
        if (!el) return;
        const active = (v===name);
        el.classList.toggle('hidden', !active);
        el.classList.toggle('view', true);
        if (active) { el.removeAttribute('data-inert'); el.style.pointerEvents='auto'; }
        else { el.setAttribute('data-inert',''); el.style.pointerEvents='none'; }
      });
    }

    const defaultSettings = {
      text: "Hello ğŸ‘‹",
      textColor: "#FFFFFF",
      backgroundColor: "#000000",
      fontSize: 80,
      scrollSpeed: 10,
      scrollDirection: "none",
      isBlinking: false,
      textColorMode: 'solid',
      bgColorMode: 'solid',
      colorMode: 'solid',
      gradientText: "linear-gradient(90deg, #e94057, #f27121)",
      gradientBg: "linear-gradient(90deg, #2193b0, #6dd5ed)",
      backgroundEffect: "none",
      textStyle: "normal",
      backgroundBorder: "none",
      outlineColor: "#FF3B30",
      updatedAt: serverTimestamp()
    };

    const homeView = document.getElementById('home-view'),
          displayView = document.getElementById('display-view'),
          controllerView = document.getElementById('controller-view');

    let currentSessionId = null, unsubscribe = null;
    const controllerState = { textColorMode:'solid', bgColorMode:'solid' };

    window.addEventListener('load', () => {
      const params = new URLSearchParams(window.location.search);
      if (params.has('display')) startDisplayMode(params.get('display'));
      else if (params.has('controller')) startControllerMode(params.get('controller'));
      else showView('home');

      // æ¸¬è©¦æ¨¡å¼ï¼š?test=1 æˆ– Alt+T
      if (params.get('test')==='1') setTimeout(runControlClickSmokeTest, 300);
      window.addEventListener('keydown', (e)=>{ if (e.altKey && e.key.toLowerCase()==='t') runControlClickSmokeTest(); });
    });

    function generateId(){ return Math.random().toString(36).substring(2,8).toUpperCase(); }

    async function startDisplayMode(sessionId){
      currentSessionId = sessionId; showView('display');
      document.getElementById('session-id-display').textContent = sessionId;
      const url = `${location.href.split('?')}?controller=${sessionId}`;
      document.getElementById('qrcode-container').innerHTML = '';
      new QRCode(document.getElementById("qrcode-container"), { text: url, width: 128, height: 128 });

      // å…ˆæœ¬åœ°æ¸²æŸ“ï¼Œé¿å…åœåœ¨ã€Œè«‹ç¨å€™â€¦ã€
      applySettings({
        textEl: document.getElementById('marquee-text'),
        containerEl: document.getElementById('display-screen'),
        wrapperEl: document.getElementById('marquee-container-wrapper'),
        bgEffectEl: document.getElementById('background-effects-container')
      }, defaultSettings);

      if (!db) return;
      const ref = doc(db, "sessions", sessionId);
      const snap = await getDoc(ref);
      if (!snap.exists()) await setDoc(ref, defaultSettings, { merge:true });

      listenToChanges(sessionId);
      setupDisplayListeners();
    }

    function listenToChanges(sessionId){
      if (unsubscribe) unsubscribe();
      const ref = doc(db, "sessions", sessionId);
      unsubscribe = onSnapshot(ref, (docSnap)=>{
        if (!docSnap.exists()){ document.getElementById('marquee-text').textContent="æ­¤é¢æ¿IDå·²å¤±æ•ˆ"; return; }
        const raw = docSnap.data();
        const settings = { ...defaultSettings, ...raw, textColorMode: raw.textColorMode || raw.colorMode || 'solid', bgColorMode: raw.bgColorMode || raw.colorMode || 'solid' };
        applySettings({
          textEl: document.getElementById('marquee-text'),
          containerEl: document.getElementById('display-screen'),
          wrapperEl: document.getElementById('marquee-container-wrapper'),
          bgEffectEl: document.getElementById('background-effects-container')
        }, settings);
      });
    }

    function applySettings(els, settings, isPreview=false){
      const { textEl, containerEl, wrapperEl, bgEffectEl } = els;
      if (!textEl || !containerEl || !wrapperEl) return;

      containerEl.style.setProperty('--text-color', settings.textColor);
      containerEl.style.setProperty('--outline-color', settings.outlineColor);

      // èƒŒæ™¯ï¼ˆä¾æ¨¡å¼ï¼‰
      const bgMode = settings.bgColorMode || settings.colorMode || 'solid';
      containerEl.style.background = (bgMode==='gradient') ? settings.gradientBg : settings.backgroundColor;

      // æ–‡å­—
      textEl.textContent = settings.text;
      const txtMode = settings.textColorMode || settings.colorMode || 'solid';
      textEl.className = 'marquee-text';
      if (txtMode==='gradient'){
        textEl.classList.add('gradient-text');
        textEl.style.backgroundImage = settings.gradientText;
        textEl.style.color = 'transparent';
      }else{
        textEl.classList.remove('gradient-text');
        textEl.style.backgroundImage = '';
        textEl.style.color = settings.textColor;
      }

      // å­—é«”å¤§å°
      const fontSize = isPreview ? Math.min(settings.fontSize, containerEl.clientHeight * 0.8) : settings.fontSize;
      textEl.style.fontSize = `${fontSize}px`;

      // å‹•ç•«
      let anims = [];
      if (settings.scrollDirection!=='none') anims.push(`${settings.scrollDirection} ${settings.scrollSpeed}s linear infinite`);
      if (settings.isBlinking) anims.push('blink-effect 1s step-end infinite');
      textEl.style.animation = anims.join(', ');

      // ç½®ä¸­ï¼ˆéœæ­¢ï¼‰
      wrapperEl.style.display = settings.scrollDirection==='none' ? 'flex' : 'block';
      wrapperEl.style.justifyContent = settings.scrollDirection==='none' ? 'center' : '';

      if (settings.textStyle!=='normal') textEl.classList.add(`text-style-${settings.textStyle}`);

      if (bgEffectEl){
        bgEffectEl.innerHTML = (settings.backgroundEffect==='none' || isPreview) ? '' : `<div class="eye"><div class="pupil"></div></div><div class="eye"><div class="pupil"></div></div>`;
      }
    }

    function setupDisplayListeners(){
      const info = document.getElementById('info-overlay');
      document.getElementById('display-view').addEventListener('click', (e)=>{ if(!e.target.closest('#fullscreen-btn') && !e.target.closest('#info-overlay')) info.classList.toggle('opacity-0'); });
      setTimeout(()=>info.classList.add('opacity-0'), 5000);
      document.getElementById('fullscreen-btn').addEventListener('click', ()=>{ if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); });
    }

    async function startControllerMode(sessionId){
      currentSessionId = sessionId; showView('controller');
      document.getElementById('controller-session-id').textContent = sessionId;

      const ref = doc(db, "sessions", sessionId);
      const snap = await getDoc(ref);
      let settings = defaultSettings;
      if (snap.exists()){
        const raw = snap.data();
        settings = { ...defaultSettings, ...raw, textColorMode: raw.textColorMode || raw.colorMode || 'solid', bgColorMode: raw.bgColorMode || raw.colorMode || 'solid' };
      } else {
        await setDoc(ref, defaultSettings, { merge:true });
      }
      controllerState.textColorMode = settings.textColorMode;
      controllerState.bgColorMode = settings.bgColorMode;

      updateControllerUI(settings);
      setupControllerListeners();
    }

    function updateControllerUI(settings){
      document.getElementById('text-input').value = settings.text;
      document.getElementById('font-size-slider').value = settings.fontSize; document.getElementById('font-size-value').textContent = settings.fontSize;
      document.getElementById('speed-slider').value = settings.scrollSpeed; document.getElementById('speed-value').textContent = settings.scrollSpeed;
      document.getElementById('blink-toggle').checked = settings.isBlinking;

      const tabToShow = (settings.textColorMode==='gradient'||settings.bgColorMode==='gradient') ? 'gradient' : 'solid';
      updateColorTab(tabToShow);

      // åˆå§‹åŒ–é¸è‰²å™¨ active æ¨£å¼
      markFirstIfEmpty('text-color-picker');
      markFirstIfEmpty('bg-color-picker');

      updateButtonGroupState('.direction-btn','direction', settings.scrollDirection);
      updateButtonGroupState('.bg-effect-btn','effect', settings.backgroundEffect);
      updateButtonGroupState('.text-style-btn','style', settings.textStyle);
      updateButtonGroupState('.border-style-btn','border', settings.backgroundBorder);

      document.getElementById('outline-color-section').classList.toggle('hidden', settings.textStyle!=='outline');

      updatePreview();
    }

    function markFirstIfEmpty(id){
      const has = document.querySelector(`#${id} .control-btn-active`);
      if (!has){ const first = document.querySelector(`#${id} > div`); if (first) first.classList.add('control-btn-active'); }
    }

    function setupControllerListeners(){
      const addInput = (id)=>{ const el=document.getElementById(id); el.addEventListener(el.type==='checkbox'?'change':'input', updateSession); };
      ['text-input','font-size-slider','speed-slider','blink-toggle'].forEach(addInput);

      // äº‹ä»¶å§”æ´¾ï¼šç¢ºä¿å³ä½¿ç¯€é»è¢«é‡å»ºä¹Ÿèƒ½æ¥åˆ°äº‹ä»¶
      delegate(document, '.direction-btn', 'click', toggleActiveAndUpdate);
      delegate(document, '.bg-effect-btn', 'click', toggleActiveAndUpdate);
      delegate(document, '.text-style-btn', 'click', (e)=>{ toggleActiveAndUpdate(e); document.getElementById('outline-color-section').classList.toggle('hidden', e.currentTarget.dataset.style!=='outline'); });
      delegate(document, '.border-style-btn', 'click', toggleActiveAndUpdate);

      // ç´”è‰²èˆ‡æ¼¸å±¤çš„æ¨¡å¼åˆ‡æ›ï¼ˆé—œéµï¼‰
      delegate(document, '#text-color-picker > div', 'click', (e)=>{ controllerState.textColorMode='solid'; pickOne('text-color-picker', e.currentTarget); updateSession(); });
      delegate(document, '#bg-color-picker > div', 'click', (e)=>{ controllerState.bgColorMode='solid'; pickOne('bg-color-picker', e.currentTarget); updateSession(); });
      delegate(document, '#text-gradient-picker > div', 'click', (e)=>{ controllerState.textColorMode='gradient'; pickOne('text-gradient-picker', e.currentTarget); updateSession(); });
      delegate(document, '#bg-gradient-picker > div', 'click', (e)=>{ controllerState.bgColorMode='gradient'; pickOne('bg-gradient-picker', e.currentTarget); updateSession(); });

      // Tab åƒ…åˆ‡æ›é¢æ¿é¡¯ç¤º
      delegate(document, '.tab-btn', 'click', (e)=>{ updateColorTab(e.currentTarget.dataset.tab); });
    }

    function delegate(root, selector, type, handler){
      root.addEventListener(type, (e)=>{
        const node = e.target.closest(selector);
        if (node) { handler({...e, currentTarget:node}); e.preventDefault(); }
      });
    }

    function toggleActiveAndUpdate(e){
      const selector = '.' + [...e.currentTarget.classList].filter(c=>c.endsWith('-btn')); // åŒç¾¤çµ„
      document.querySelectorAll(selector).forEach(b=>b.classList.replace('bg-indigo-600','bg-gray-700'));
      e.currentTarget.classList.replace('bg-gray-700','bg-indigo-600');
      updateSession();
    }

    function pickOne(id, el){
      document.querySelectorAll(`#${id} > div`).forEach(d=>d.classList.remove('control-btn-active'));
      el.classList.add('control-btn-active');
    }

    function getSettings(){
      const textStyle = document.querySelector('.text-style-btn.bg-indigo-600')?.dataset.style || 'normal';
      document.getElementById('outline-color-section').classList.toggle('hidden', textStyle!=='outline');

      return {
        text: document.getElementById('text-input').value,
        fontSize: document.getElementById('font-size-slider').value,
        scrollSpeed: document.getElementById('speed-slider').value,
        isBlinking: document.getElementById('blink-toggle').checked,

        textColorMode: controllerState.textColorMode,
        bgColorMode: controllerState.bgColorMode,
        colorMode: controllerState.textColorMode,

        textColor: document.querySelector('#text-color-picker .control-btn-active')?.dataset.color || '#FFFFFF',
        backgroundColor: document.querySelector('#bg-color-picker .control-btn-active')?.dataset.color || '#000000',
        gradientText: document.querySelector('#text-gradient-picker .control-btn-active')?.dataset.gradient || 'linear-gradient(90deg,#e94057,#f27121)',
        gradientBg: document.querySelector('#bg-gradient-picker .control-btn-active')?.dataset.gradient || 'linear-gradient(90deg,#2193b0,#6dd5ed)',

        outlineColor: document.querySelector('#outline-color-picker .control-btn-active')?.dataset.color || '#FF3B30',
        scrollDirection: document.querySelector('.direction-btn.bg-indigo-600')?.dataset.direction || 'none',
        backgroundEffect: document.querySelector('.bg-effect-btn.bg-indigo-600')?.dataset.effect || 'none',
        textStyle,
        backgroundBorder: document.querySelector('.border-style-btn.bg-indigo-600')?.dataset.border || 'none',
      };
    }

    function updateSession(){
      if (!currentSessionId || !db){ updatePreview(); return; }
      const settings = getSettings();
      document.getElementById('font-size-value').textContent = settings.fontSize;
      document.getElementById('speed-value').textContent = settings.scrollSpeed;
      setDoc(doc(db,"sessions",currentSessionId), { ...settings, updatedAt: serverTimestamp() }, { merge:true });
      updatePreview();
    }

    function updatePreview(){
      const settings = getSettings();
      applySettings({
        textEl: document.getElementById('preview-marquee-text'),
        containerEl: document.querySelector('.controller-preview'),
        wrapperEl: document.getElementById('preview-marquee-container-wrapper')
      }, settings, true);
    }

    function createPickers(){
      const colorPalette = ['#FFFFFF','#000000','#FF3B30','#FF9500','#FFCC00','#4CD964','#007AFF','#5856D6','#FF2D55'];
      const gradientPalette = [
        { value:'linear-gradient(90deg,#F37335,#FDC830)'},
        { value:'linear-gradient(90deg,#2193b0,#6dd5ed)'},
        { value:'linear-gradient(90deg,#56ab2f,#a8e063)'},
        { value:'linear-gradient(90deg,#e94057,#f27121)'},
        { value:'linear-gradient(90deg,#4776E6,#8E54E9)'},
        { value:'linear-gradient(90deg,red,orange,yellow,green,blue,indigo,violet)'}
      ];

      const make = (id, arr, prop)=>{
        const el = document.getElementById(id); if (!el) return; el.innerHTML='';
        arr.forEach((item, i)=>{
          const v = item.value || item;
          const d = document.createElement('div');
          d.className='w-8 h-8 rounded-md cursor-pointer border-2 border-gray-600';
          d.style.background = v;
          d.dataset[prop==='value'?'gradient':'color'] = v;
          if ((id==='text-color-picker'||id==='bg-color-picker'||id==='outline-color-picker') && i===0) d.classList.add('control-btn-active');
          el.appendChild(d);
        });
      };
      make('text-color-picker', colorPalette);
      make('bg-color-picker', colorPalette);
      make('outline-color-picker', colorPalette);
      make('text-gradient-picker', gradientPalette, 'value');
      make('bg-gradient-picker', gradientPalette, 'value');
    }

    // æ§åˆ¶å°é»æ“Šè‡ªæˆ‘æª¢æ¸¬ï¼ˆå¯è¦–åŒ–èˆ‡ consoleï¼‰
    function runControlClickSmokeTest(){
      const toast = (msg)=>{ const t=document.getElementById('test-toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 3000); };
      const targets = [
        '.text-style-btn', '.direction-btn', '.bg-effect-btn', '.border-style-btn',
        '#text-color-picker > div', '#bg-color-picker > div',
        '#text-gradient-picker > div', '#bg-gradient-picker > div'
      ];
      let ok=0, fail=0, blocked=[];
      targets.forEach(sel=>{
        const node = document.querySelector(sel);
        if (!node) { fail++; blocked.push(sel+'(missing)'); return; }
        const rect = node.getBoundingClientRect();
        const elAt = document.elementFromPoint(rect.left+2, rect.top+2);
        const blockedBy = elAt && !elAt.closest(sel) ? elAt : null;
        try {
          node.dispatchEvent(new MouseEvent('click', {bubbles:true, cancelable:true}));
          ok++;
        } catch(e){
          fail++; blocked.push(sel + (blockedBy? ' blocked by '+blockedBy.tagName+'#'+(blockedBy.id||'') : ''));
        }
      });
      console.log('[SmokeTest] ok=%d fail=%d blocked=%o', ok, fail, blocked);
      toast(`æ§åˆ¶å°æŒ‰éˆ•è‡ªæª¢ï¼šæˆåŠŸ ${ok}ï¼Œå¤±æ•— ${fail}`); /* é©—è­‰é»æ“Šè·¯å¾‘æ˜¯å¦æš¢é€š */
    }

    document.getElementById('create-display-btn').addEventListener('click', ()=>{ location.href = `${location.href.split('?')}?display=${generateId()}`; });
    document.getElementById('open-controller-btn').addEventListener('click', ()=>{
      const id = document.getElementById('session-id-input').value.trim().toUpperCase();
      if (id) location.href = `${location.href.split('?')}?controller=${id}`; else alert('è«‹è¼¸å…¥é¢æ¿ ID');
    });

    createPickers();
  </script>
</body>
</html>
