<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>é ç«¯é™æ§ LED è·‘é¦¬ç‡ˆ v12ï¼ˆä¿®å¾©ç‰ˆï¼‰</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet" />
  <!-- QRCode -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --font-size: 80px;
      --text-color: #FFFFFF;
      --bg-color: #000000;
      --outline-color: #FF3B30;
      --scroll-duration: 10s;
    }

    body { background:#0b0b0b; color:#e5e7eb; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "DotGothic16", "Apple Color Emoji", "Segoe UI Emoji"; }

    .hidden{ display:none; }

    /* é¡¯ç¤ºç•«é¢ */
    #display-screen{
      position: relative;
      width: 100%;
      height: 100svh;
      overflow: hidden;
      background: var(--bg-color, #000000);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* èƒŒæ™¯æ¼¸å±¤æ™‚å¥—ç”¨ */
    .bg-gradient-active{
      background: none !important; /* ç”± inline style è¨­å®š gradient */
    }

    .marquee-wrapper{
      width: 100%;
      overflow: hidden;
      padding: 8px;
    }

    .marquee-text{
      font-size: var(--font-size, 80px);
      color: var(--text-color, #FFFFFF);
      white-space: nowrap;
      display: inline-block;
      text-shadow: none;
      transition: text-shadow 0.2s ease;
      will-change: transform;
    }

    /* æ¼¸å±¤æ–‡å­—ï¼šå¿…é ˆ color/å¡«è‰²é€æ˜ + èƒŒæ™¯è£åˆ‡åˆ°æ–‡å­— */
    .gradient-text{
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent !important;
      -webkit-text-fill-color: transparent !important;
    }

    /* æ–‡å­—é¢¨æ ¼ */
    .text-style-glow{
      text-shadow: 0 0 8px var(--text-color, #FFFFFF), 0 0 12px var(--text-color, #FFFFFF);
    }
    .text-style-outline{
      /* ç”¨ text-shadow æ¨¡æ“¬å¤–æ¡†ï¼Œä¸è¦†è“‹æ–‡å­—æœ¬é«”çš„å¡«è‰²æ¨¡å¼ */
      text-shadow:
        -2px -2px 0 var(--outline-color),
         2px -2px 0 var(--outline-color),
        -2px  2px 0 var(--outline-color),
         2px  2px 0 var(--outline-color),
        -3px  0   0 var(--outline-color),
         3px  0   0 var(--outline-color),
         0   -3px 0 var(--outline-color),
         0    3px 0 var(--outline-color);
    }

    /* è·‘é¦¬å‹•ç•« */
    @keyframes marquee-left { 0%{ transform: translateX(100%);} 100%{ transform: translateX(-100%);} }
    @keyframes marquee-right{ 0%{ transform: translateX(-100%);} 100%{ transform: translateX(100%);} }
    .scroll-left { animation: marquee-left var(--scroll-duration, 10s) linear infinite; }
    .scroll-right{ animation: marquee-right var(--scroll-duration, 10s) linear infinite; }
    .no-scroll { animation: none !important; }

    /* é–ƒçˆ */
    @keyframes blink-kf { 0%,49%{ opacity:1;} 50%,100%{ opacity:0;} }
    .blink { animation: blink-kf 1s step-start infinite; }

    /* èƒŒæ™¯é‚Šæ¡†æ¨£å¼ï¼ˆå®¹å™¨å¤–æ¡†ï¼‰ */
    .border-style-solid { border: 8px solid #ffffff; }
    .border-style-rainbow{
      padding: 8px;
      border: none;
      position: relative;
      box-shadow: 0 0 20px rgba(255,100,255,0.7);
    }
    .border-style-rainbow::before{
      content:'';
      position:absolute;
      inset: 0;
      z-index:-1;
      margin:-8px;
      background: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet, red);
      background-size: 400% 400%;
      animation: rainbow-border-anim 2.5s linear infinite;
    }
    @keyframes rainbow-border-anim{
      0%{ background-position:0% 50%;}
      50%{ background-position:100% 50%;}
      100%{ background-position:0% 50%;}
    }

    /* æ§åˆ¶å°å°æ–¹å¡Š */
    .swatch{
      width: 28px; height: 28px; border-radius: 9999px; border: 2px solid #4b5563; cursor: pointer;
    }
    .swatch.active{ outline: 3px solid #6366f1; outline-offset: 2px; }

    /* é é¢çµæ§‹ */
    .section{
      background: #0f0f13; border: 1px solid #27272a; border-radius: 12px; padding: 12px;
    }
    .section h3{ font-weight: 600; margin-bottom: 10px; }

    .tab-btn{ border:1px solid transparent; padding: 6px 10px; border-radius: 9999px; cursor:pointer;}
    .tab-btn.active{ border-color:#6366f1; color:#fff; }
    .tab-btn.inactive{ color:#9ca3af; }

    input[type="range"]{ width: 100%; }
    .kbd{ background:#111827; border:1px solid #374151; border-bottom-width:3px; padding:4px 8px; border-radius:6px; }

    /* èƒŒæ™¯ç‰¹æ•ˆï¼šçœ¼ç›ï¼ˆç¤ºç¯„ç”¨ï¼‰ */
    .eyes-layer{
      position:absolute; inset:0; pointer-events:none; display:flex; align-items:center; justify-content:center;
    }
    .eye{ width: 24px; height: 24px; background:#fff; border-radius:9999px; margin: 0 6px; animation: eye-blink 2.8s infinite; }
    @keyframes eye-blink{ 0%,92%{ transform: scaleY(1);} 96%{ transform: scaleY(0.1);} 100%{ transform: scaleY(1);} }
  </style>
</head>
<body>

  <!-- é¦–é  -->
  <div id="home-view" class="p-4">
    <div class="max-w-xl mx-auto space-y-4">
      <h1 class="text-2xl font-bold">LED Scrollerï½œæ•¸ä½è·‘é¦¬ç‡ˆãƒ»é ç«¯é™æ§ï¼ˆv12 ä¿®å¾©ç‰ˆï¼‰</h1>
      <p class="text-gray-400">æç¤ºï¼šåœ¨è£ç½® A å»ºç«‹é¡¯ç¤ºé¢æ¿ï¼Œç„¶å¾Œåœ¨è£ç½® B è¼¸å…¥é¢æ¿ ID é€²è¡Œé™æ§ [ä¿®å¾©ã€ç©©å®šåˆ‡æ›é¡è‰²/æ¼¸å±¤/é‚Šæ¡†].</p>

      <div class="section space-y-3">
        <button id="create-session-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-2 rounded-lg">å»ºç«‹æ–°çš„é¡¯ç¤ºé¢æ¿</button>
        <div class="flex items-center gap-2">
          <input id="join-id-input" class="flex-1 bg-zinc-900 border border-zinc-700 rounded px-3 py-2" placeholder="è¼¸å…¥é¢æ¿ ID" />
          <button id="join-display-btn" class="bg-zinc-700 hover:bg-zinc-600 text-white px-3 py-2 rounded">é€²å…¥</button>
        </div>
      </div>
    </div>
  </div>

  <!-- é¡¯ç¤ºç•«é¢ -->
  <div id="display-view" class="hidden">
    <div id="display-screen" class="w-full h-svh">
      <div id="background-effects-container" class="eyes-layer hidden">
        <div class="eye"></div><div class="eye"></div><div class="eye"></div>
      </div>
      <div id="marquee-container-wrapper" class="marquee-wrapper">
        <div id="marquee-text" class="marquee-text">Hello ğŸ‘‹</div>
      </div>
    </div>

    <div class="absolute top-3 left-3 bg-black/50 text-sm p-2 rounded">
      <div>IDï¼š<span id="session-id-display" class="font-mono"></span></div>
      <div id="qrcode-container" class="mt-2"></div>
      <div class="mt-2 text-gray-400">ç”¨æ§åˆ¶å™¨è£ç½®æƒæ QR å³å¯é™æ§</div>
    </div>
  </div>

  <!-- æ§åˆ¶å™¨ -->
  <div id="controller-view" class="hidden p-4">
    <div class="max-w-4xl mx-auto space-y-4">
      <div class="flex items-center justify-between">
        <div>æ§åˆ¶å°ï¼ˆIDï¼š<span id="controller-session-id" class="font-mono"></span>ï¼‰</div>
        <button id="back-home-btn" class="text-indigo-400">è¿”å›é¦–é </button>
      </div>

      <div class="grid md:grid-cols-3 gap-4">
        <!-- å·¦ï¼šé è¦½ -->
        <div class="section md:col-span-2">
          <h3>æ•ˆæœé è¦½</h3>
          <div class="border border-zinc-700 rounded-lg overflow-hidden">
            <div id="preview-screen" class="p-3 bg-black">
              <div id="preview-wrapper" class="marquee-wrapper">
                <div id="preview-text" class="marquee-text">Hello ğŸ‘‹</div>
              </div>
            </div>
          </div>
        </div>

        <!-- å³ï¼šè¨­å®š -->
        <div class="space-y-4">
          <div class="section">
            <h3>é¡¯ç¤ºæ–‡å­—</h3>
            <textarea id="text-input" rows="2" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2"></textarea>
          </div>

          <div class="section">
            <h3>æ–‡å­—å¡«è‰²</h3>
            <div class="flex gap-2 mb-2">
              <button class="tab-btn active" data-textmode="solid" id="tab-text-solid">ç´”è‰²</button>
              <button class="tab-btn inactive" data-textmode="gradient" id="tab-text-gradient">æ¼¸å±¤</button>
            </div>
            <div id="text-solid-panel" class="space-y-2">
              <div class="flex gap-2 flex-wrap" id="text-color-picker"></div>
            </div>
            <div id="text-gradient-panel" class="space-y-2 hidden">
              <div class="grid grid-cols-3 gap-2" id="text-gradient-picker"></div>
            </div>
          </div>

          <div class="section">
            <h3>èƒŒæ™¯</h3>
            <div class="flex gap-2 mb-2">
              <button class="tab-btn active" data-bgmode="solid" id="tab-bg-solid">ç´”è‰²</button>
              <button class="tab-btn inactive" data-bgmode="gradient" id="tab-bg-gradient">æ¼¸å±¤</button>
            </div>
            <div id="bg-solid-panel" class="space-y-2">
              <div class="flex gap-2 flex-wrap" id="bg-color-picker"></div>
            </div>
            <div id="bg-gradient-panel" class="space-y-2 hidden">
              <div class="grid grid-cols-3 gap-2" id="bg-gradient-picker"></div>
            </div>
          </div>

          <div class="section">
            <h3>æ–‡å­—é¢¨æ ¼</h3>
            <div class="flex gap-2">
              <button class="tab-btn active" data-textstyle="normal">æ¨™æº–</button>
              <button class="tab-btn inactive" data-textstyle="glow">ç™¼å…‰</button>
              <button class="tab-btn inactive" data-textstyle="outline">é‚Šæ¡†</button>
            </div>
            <div id="outline-color-section" class="mt-2 hidden">
              <div class="text-xs text-gray-400 mb-1">é‚Šæ¡†é¡è‰²</div>
              <div class="flex gap-2 flex-wrap" id="outline-color-picker"></div>
            </div>
          </div>

          <div class="section">
            <h3>èƒŒæ™¯é‚Šæ¡†</h3>
            <div class="flex gap-2">
              <button class="tab-btn active" data-border="none">ç„¡</button>
              <button class="tab-btn inactive" data-border="solid">å¯¦ç·š</button>
              <button class="tab-btn inactive" data-border="rainbow">æ¼¸è®Š</button>
            </div>
          </div>

          <div class="section">
            <h3>å°ºå¯¸/é€Ÿåº¦/æ–¹å‘</h3>
            <div class="space-y-2">
              <label class="text-sm">å­—é«”å¤§å°ï¼š<span id="font-size-label" class="kbd">80</span> px</label>
              <input id="font-size-range" type="range" min="20" max="240" step="1" value="80" />
              <label class="text-sm">æ»¾å‹•é€Ÿåº¦ï¼ˆç§’/è¼ªï¼‰ï¼š<span id="speed-label" class="kbd">10</span> s</label>
              <input id="speed-range" type="range" min="2" max="60" step="1" value="10" />
              <label class="text-sm">æ–¹å‘</label>
              <select id="direction-select" class="w-full bg-zinc-900 border border-zinc-700 rounded px-2 py-1">
                <option value="none">âšâš éœæ­¢</option>
                <option value="left">â† å‘å·¦</option>
                <option value="right">å‘å³ â†’</option>
              </select>
              <label class="inline-flex items-center gap-2 mt-2">
                <input id="blink-checkbox" type="checkbox" />
                <span>æ–‡å­—é–ƒçˆ</span>
              </label>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebaseï¼ˆæ²¿ç”¨åŸæª”è¨­å®šï¼‰
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDiXuuIQB9EJQZtW8zYuTByxr-Y5wMpRdc",
      authDomain: "led-run-c168b.firebaseapp.com",
      projectId: "led-run-c168b",
      storageBucket: "led-run-c168b.appspot.com",
      messagingSenderId: "5.55557259748e+11",
      appId: "1:5.55557259748e+11:web:7a79d35743bcbadbf11ff1",
      measurementId: "G-7JH5TLX99R"
    };
    let db; try { db = getFirestore(initializeApp(firebaseConfig)); } catch (e) { console.error("Firebase åˆå§‹åŒ–å¤±æ•—", e); alert("Firebase é€£ç·šå¤±æ•—ï¼"); }

    // è¦–åœ–
    const homeView = document.getElementById('home-view');
    const displayView = document.getElementById('display-view');
    const controllerView = document.getElementById('controller-view');

    // æ§åˆ¶é¢æ¿å…ƒç´ 
    const elsCtl = {
      textInput: document.getElementById('text-input'),
      fontSizeRange: document.getElementById('font-size-range'),
      fontSizeLabel: document.getElementById('font-size-label'),
      speedRange: document.getElementById('speed-range'),
      speedLabel: document.getElementById('speed-label'),
      directionSelect: document.getElementById('direction-select'),
      blinkCheckbox: document.getElementById('blink-checkbox'),
      outlineColorSection: document.getElementById('outline-color-section'),

      textColorPicker: document.getElementById('text-color-picker'),
      textGradientPicker: document.getElementById('text-gradient-picker'),
      bgColorPicker: document.getElementById('bg-color-picker'),
      bgGradientPicker: document.getElementById('bg-gradient-picker'),

      tabTextSolid: document.getElementById('tab-text-solid'),
      tabTextGradient: document.getElementById('tab-text-gradient'),
      tabBgSolid: document.getElementById('tab-bg-solid'),
      tabBgGradient: document.getElementById('tab-bg-gradient'),

      textSolidPanel: document.getElementById('text-solid-panel'),
      textGradientPanel: document.getElementById('text-gradient-panel'),
      bgSolidPanel: document.getElementById('bg-solid-panel'),
      bgGradientPanel: document.getElementById('bg-gradient-panel'),

      controllerSessionId: document.getElementById('controller-session-id'),
      backHomeBtn: document.getElementById('back-home-btn'),
    };

    // é è¦½å…ƒç´ 
    const elsPrev = {
      textEl: document.getElementById('preview-text'),
      wrapperEl: document.getElementById('preview-wrapper'),
      screenEl: document.getElementById('preview-screen'),
    };

    // é¡¯ç¤ºå…ƒç´ 
    const elsDisp = {
      textEl: document.getElementById('marquee-text'),
      wrapperEl: document.getElementById('marquee-container-wrapper'),
      screenEl: document.getElementById('display-screen'),
      bgEffectEl: document.getElementById('background-effects-container'),
      qrcodeEl: document.getElementById('qrcode-container'),
      sessionIdLabel: document.getElementById('session-id-display'),
    };

    // èª¿è‰²ç›¤
    const colorPalette = ['#FFFFFF','#000000','#FF3B30','#FF9500','#FFCC00','#4CD964','#007AFF','#5856D6','#FF2D55'];
    const gradientPalette = [
      'linear-gradient(90deg,#F37335,#FDC830)',
      'linear-gradient(90deg,#2193b0,#6dd5ed)',
      'linear-gradient(90deg,#56ab2f,#a8e063)',
      'linear-gradient(90deg,#e94057,#f27121)',
      'linear-gradient(90deg,#4776E6,#8E54E9)',
      'linear-gradient(90deg,red,orange,yellow,green,blue,indigo,violet)'
    ];

    // è¨­å®šï¼ˆæ–°å¢ bgModeï¼Œæ²¿ç”¨ colorModeï¼‰
    const defaultSettings = {
      text: "Hello ğŸ‘‹",
      textColor: "#FFFFFF",
      backgroundColor: "#000000",
      fontSize: 80,
      scrollSpeed: 10,
      scrollDirection: "none",
      isBlinking: false,

      colorMode: "solid",        // text: solid | gradient
      gradientText: "linear-gradient(90deg, #e94057, #f27121)",

      bgMode: "solid",           // background: solid | gradient
      gradientBg: "linear-gradient(90deg, #2193b0, #6dd5ed)",

      backgroundEffect: "none",  // none | eyes
      textStyle: "normal",       // normal | glow | outline
      outlineColor: "#FF3B30",

      backgroundBorder: "none",  // none | solid | rainbow

      updatedAt: serverTimestamp()
    };

    let currentSessionId = null;
    let unsubscribe = null;

    // è·¯ç”±
    window.addEventListener('load', () => {
      const params = new URLSearchParams(window.location.search);
      if (params.has('display')) startDisplayMode(params.get('display'));
      else if (params.has('controller')) startControllerMode(params.get('controller'));
      else showView('home');
    });

    function showView(name){
      [homeView, displayView, controllerView].forEach(v => v.classList.add('hidden'));
      document.getElementById(name+'-view').classList.remove('hidden');
    }

    function generateId(){ return Math.random().toString(36).substring(2,8).toUpperCase(); }

    // é¦–é 
    document.getElementById('create-session-btn').addEventListener('click', async () => {
      const id = generateId();
      const ref = doc(db, "sessions", id);
      await setDoc(ref, defaultSettings, { merge: true });
      window.location.href = `${window.location.href.split('?')}?display=${id}`;
    });
    document.getElementById('join-display-btn').addEventListener('click', () => {
      const id = (document.getElementById('join-id-input').value||'').trim().toUpperCase();
      if(!id) return alert('è«‹è¼¸å…¥é¢æ¿ ID');
      window.location.href = `${window.location.href.split('?')}?display=${id}`;
    });

    // é¡¯ç¤ºæ¨¡å¼
    async function startDisplayMode(sessionId){
      currentSessionId = sessionId;
      showView('display');
      elsDisp.sessionIdLabel.textContent = sessionId;

      // QR æ§åˆ¶é€£çµ
      const url = `${window.location.href.split('?')}?controller=${sessionId}`;
      elsDisp.qrcodeEl.innerHTML = '';
      new QRCode(elsDisp.qrcodeEl, { text: url, width: 128, height: 128 });

      const ref = doc(db, "sessions", sessionId);
      if(!(await getDoc(ref)).exists()) await setDoc(ref, defaultSettings);

      if (unsubscribe) unsubscribe();
      unsubscribe = onSnapshot(ref, (docSnap) => {
        if(!docSnap.exists()) return;
        const settings = { ...defaultSettings, ...docSnap.data() };
        applySettingsToDisplay(settings);
      });
    }

    // å¥—ç”¨åˆ°é¡¯ç¤ºç•«é¢ï¼ˆFIXï¼šæ¨¡å¼åˆ‡æ›æ™‚æ¸…é™¤è¡çªæ¨£å¼ï¼‰
    function applySettingsToDisplay(settings){
      // èƒŒæ™¯
      const scr = elsDisp.screenEl;
      scr.classList.toggle('bg-gradient-active', settings.bgMode === 'gradient');
      // å…ˆæ¸…ç©º inline èƒŒæ™¯ï¼ˆé¿å…æ®˜ç•™ï¼‰
      scr.style.background = '';
      scr.style.backgroundImage = '';
      scr.style.backgroundColor = '';

      if(settings.bgMode === 'gradient'){
        scr.style.backgroundImage = settings.gradientBg;
      }else{
        scr.style.backgroundColor = settings.backgroundColor;
      }

      // èƒŒæ™¯ç‰¹æ•ˆ
      elsDisp.bgEffectEl.classList.toggle('hidden', settings.backgroundEffect !== 'eyes');

      // èƒŒæ™¯é‚Šæ¡†ï¼ˆå®¹å™¨å¤–æ¡†ï¼‰â€” å…ˆç§»é™¤æ‰€æœ‰ border-style-*ï¼ˆé˜²æ­¢æ®˜ç•™ï¼‰
      ['none','solid','rainbow'].forEach(k=>{
        if(k==='none'){
          scr.classList.remove('border-style-solid','border-style-rainbow');
        }else{
          scr.classList.remove('border-style-'+k);
        }
      });
      if(settings.backgroundBorder === 'solid') scr.classList.add('border-style-solid');
      if(settings.backgroundBorder === 'rainbow') scr.classList.add('border-style-rainbow');

      // æ–‡å­—
      const t = elsDisp.textEl;
      t.textContent = settings.text || '';
      t.style.setProperty('--text-color', settings.textColor);
      t.style.setProperty('--outline-color', settings.outlineColor);
      t.style.fontSize = (settings.fontSize||80) + 'px';
      t.classList.remove('text-style-glow','text-style-outline','gradient-text');

      // FIX: å¼·åˆ¶æ¸…é™¤äº’æ–¥å±¬æ€§ï¼Œé¿å…å›ä¸å»æ¼¸å±¤
      t.style.backgroundImage = '';
      t.style.backgroundClip = '';
      t.style.webkitBackgroundClip = '';
      t.style.color = '';
      t.style.webkitTextFillColor = '';

      if(settings.colorMode === 'gradient'){
        t.classList.add('gradient-text');
        t.style.backgroundImage = settings.gradientText;
        t.style.backgroundClip = 'text';
        t.style.webkitBackgroundClip = 'text';
        t.style.color = 'transparent';
        t.style.webkitTextFillColor = 'transparent';
      }else{
        // ç´”è‰²æ¨¡å¼
        t.classList.remove('gradient-text');
        t.style.backgroundImage = '';
        t.style.backgroundClip = '';
        t.style.webkitBackgroundClip = '';
        t.style.color = settings.textColor;
        t.style.webkitTextFillColor = settings.textColor;
      }

      // æ–‡å­—é¢¨æ ¼
      if(settings.textStyle === 'glow') t.classList.add('text-style-glow');
      if(settings.textStyle === 'outline') t.classList.add('text-style-outline');

      // é–ƒçˆ
      t.classList.toggle('blink', !!settings.isBlinking);

      // æ»¾å‹•
      const w = elsDisp.wrapperEl;
      t.classList.remove('scroll-left','scroll-right','no-scroll');
      w.style.setProperty('--scroll-duration', (settings.scrollSpeed||10)+'s');
      if(settings.scrollDirection === 'left') t.classList.add('scroll-left');
      else if(settings.scrollDirection === 'right') t.classList.add('scroll-right');
      else t.classList.add('no-scroll');
    }

    // æ§åˆ¶å™¨æ¨¡å¼
    async function startControllerMode(sessionId){
      currentSessionId = sessionId;
      showView('controller');
      elsCtl.controllerSessionId.textContent = sessionId;

      const ref = doc(db, "sessions", sessionId);
      if(!(await getDoc(ref)).exists()) await setDoc(ref, defaultSettings);

      // è¨»å†Šç›£è½ï¼Œè®“å³å´é è¦½å³æ™‚åæ˜ ï¼ˆä¸å½±éŸ¿é¡¯ç¤ºé ï¼‰
      if (unsubscribe) unsubscribe();
      unsubscribe = onSnapshot(ref, (docSnap) => {
        if(!docSnap.exists()) return;
        const settings = { ...defaultSettings, ...docSnap.data() };
        renderControllerFromSettings(settings);
        applySettingsToPreview(settings);
      });

      // è¿”å›
      elsCtl.backHomeBtn.addEventListener('click', () => window.location.href = window.location.href.split('?'));

      // å»ºç«‹èª¿è‰²ç›¤èˆ‡ç¶å®š
      buildColorSwatches(elsCtl.textColorPicker, colorPalette, (val)=> save({ colorMode:'solid', textColor: val }));
      buildGradientSwatches(elsCtl.textGradientPicker, gradientPalette, (val)=> save({ colorMode:'gradient', gradientText: val }));

      buildColorSwatches(elsCtl.bgColorPicker, colorPalette, (val)=> save({ bgMode:'solid', backgroundColor: val }));
      buildGradientSwatches(elsCtl.bgGradientPicker, gradientPalette, (val)=> save({ bgMode:'gradient', gradientBg: val }));

      buildColorSwatches(elsCtl.outlineColorPicker, colorPalette, (val)=> save({ outlineColor: val }));

      // æ–‡å­—
      elsCtl.textInput.addEventListener('input', e => save({ text: e.target.value }));

      // å°ºå¯¸/é€Ÿåº¦/æ–¹å‘/é–ƒçˆ
      elsCtl.fontSizeRange.addEventListener('input', e => {
        elsCtl.fontSizeLabel.textContent = e.target.value;
        save({ fontSize: Number(e.target.value) });
      });
      elsCtl.speedRange.addEventListener('input', e => {
        elsCtl.speedLabel.textContent = e.target.value;
        save({ scrollSpeed: Number(e.target.value) });
      });
      elsCtl.directionSelect.addEventListener('change', e => save({ scrollDirection: e.target.value }));
      elsCtl.blinkCheckbox.addEventListener('change', e => save({ isBlinking: e.target.checked }));

      // Tab åˆ‡æ›ï¼ˆæ–‡å­—ï¼‰
      elsCtl.tabTextSolid.addEventListener('click', () => toggleTextMode('solid'));
      elsCtl.tabTextGradient.addEventListener('click', () => toggleTextMode('gradient'));

      // Tab åˆ‡æ›ï¼ˆèƒŒæ™¯ï¼‰
      elsCtl.tabBgSolid.addEventListener('click', () => toggleBgMode('solid'));
      elsCtl.tabBgGradient.addEventListener('click', () => toggleBgMode('gradient'));

      // æ–‡å­—é¢¨æ ¼
      document.querySelectorAll('[data-textstyle]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          document.querySelectorAll('[data-textstyle]').forEach(b=>b.classList.toggle('active', false));
          btn.classList.add('active');
          const v = btn.dataset.textstyle;
          elsCtl.outlineColorSection.classList.toggle('hidden', v!=='outline');
          save({ textStyle: v });
        });
      });

      // èƒŒæ™¯é‚Šæ¡†
      document.querySelectorAll('[data-border]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          document.querySelectorAll('[data-border]').forEach(b=>{
            b.classList.remove('active'); b.classList.add('inactive');
          });
          btn.classList.remove('inactive'); btn.classList.add('active');
          save({ backgroundBorder: btn.dataset.border });
        });
      });
    }

    function toggleTextMode(mode){
      // åˆ‡æ› UI æ¨™ç±¤èˆ‡é¢æ¿
      if(mode==='solid'){
        elsCtl.tabTextSolid.classList.add('active'); elsCtl.tabTextSolid.classList.remove('inactive');
        elsCtl.tabTextGradient.classList.remove('active'); elsCtl.tabTextGradient.classList.add('inactive');
        elsCtl.textSolidPanel.classList.remove('hidden');
        elsCtl.textGradientPanel.classList.add('hidden');
      }else{
        elsCtl.tabTextGradient.classList.add('active'); elsCtl.tabTextGradient.classList.remove('inactive');
        elsCtl.tabTextSolid.classList.remove('active'); elsCtl.tabTextSolid.classList.add('inactive');
        elsCtl.textGradientPanel.classList.remove('hidden');
        elsCtl.textSolidPanel.classList.add('hidden');
      }
      // å¯«å…¥æ¨¡å¼ï¼ˆä¸æ”¹é¡è‰²å€¼ï¼Œé¿å…è¦†è“‹ä½¿ç”¨è€…å·²é¸ï¼‰
      save({ colorMode: mode });
    }

    function toggleBgMode(mode){
      if(mode==='solid'){
        elsCtl.tabBgSolid.classList.add('active'); elsCtl.tabBgSolid.classList.remove('inactive');
        elsCtl.tabBgGradient.classList.remove('active'); elsCtl.tabBgGradient.classList.add('inactive');
        elsCtl.bgSolidPanel.classList.remove('hidden');
        elsCtl.bgGradientPanel.classList.add('hidden');
      }else{
        elsCtl.tabBgGradient.classList.add('active'); elsCtl.tabBgGradient.classList.remove('inactive');
        elsCtl.tabBgSolid.classList.remove('active'); elsCtl.tabBgSolid.classList.add('inactive');
        elsCtl.bgGradientPanel.classList.remove('hidden');
        elsCtl.bgSolidPanel.classList.add('hidden');
      }
      save({ bgMode: mode });
    }

    function buildColorSwatches(container, list, onPick){
      container.innerHTML = '';
      list.forEach(c=>{
        const el = document.createElement('div');
        el.className = 'swatch';
        el.style.background = c;
        el.title = c;
        el.addEventListener('click', ()=> onPick(c));
        container.appendChild(el);
      });
    }
    function buildGradientSwatches(container, list, onPick){
      container.innerHTML = '';
      list.forEach(g=>{
        const el = document.createElement('div');
        el.className = 'swatch';
        el.style.backgroundImage = g;
        el.title = g;
        el.addEventListener('click', ()=> onPick(g));
        container.appendChild(el);
      });
    }

    // å¥—ç”¨åˆ°å³å´é è¦½ï¼ˆèˆ‡é¡¯ç¤ºç›¸åŒé‚è¼¯ï¼‰
    function applySettingsToPreview(settings){
      const scr = elsPrev.screenEl;
      scr.classList.toggle('bg-gradient-active', settings.bgMode === 'gradient');
      scr.style.background = '';
      scr.style.backgroundImage = '';
      scr.style.backgroundColor = '';
      if(settings.bgMode === 'gradient'){
        scr.style.backgroundImage = settings.gradientBg;
      }else{
        scr.style.backgroundColor = settings.backgroundColor;
      }

      const t = elsPrev.textEl;
      t.textContent = settings.text || '';
      t.style.setProperty('--text-color', settings.textColor);
      t.style.setProperty('--outline-color', settings.outlineColor);
      t.style.fontSize = (settings.fontSize||80) + 'px';
      t.classList.remove('text-style-glow','text-style-outline','gradient-text');

      // FIXï¼šæ¸…é™¤äº’æ–¥å±¬æ€§
      t.style.backgroundImage = '';
      t.style.backgroundClip = '';
      t.style.webkitBackgroundClip = '';
      t.style.color = '';
      t.style.webkitTextFillColor = '';

      if(settings.colorMode === 'gradient'){
        t.classList.add('gradient-text');
        t.style.backgroundImage = settings.gradientText;
        t.style.backgroundClip = 'text';
        t.style.webkitBackgroundClip = 'text';
        t.style.color = 'transparent';
        t.style.webkitTextFillColor = 'transparent';
      }else{
        t.classList.remove('gradient-text');
        t.style.backgroundImage = '';
        t.style.backgroundClip = '';
        t.style.webkitBackgroundClip = '';
        t.style.color = settings.textColor;
        t.style.webkitTextFillColor = settings.textColor;
      }

      if(settings.textStyle === 'glow') t.classList.add('text-style-glow');
      if(settings.textStyle === 'outline') t.classList.add('text-style-outline');

      t.classList.toggle('blink', !!settings.isBlinking);

      t.classList.remove('scroll-left','scroll-right','no-scroll');
      elsPrev.wrapperEl.style.setProperty('--scroll-duration', (settings.scrollSpeed||10)+'s');
      if(settings.scrollDirection === 'left') t.classList.add('scroll-left');
      else if(settings.scrollDirection === 'right') t.classList.add('scroll-right');
      else t.classList.add('no-scroll');
    }

    function renderControllerFromSettings(s){
      // æ–‡æœ¬/åŸºæœ¬
      elsCtl.textInput.value = s.text || '';
      elsCtl.fontSizeRange.value = s.fontSize||80; elsCtl.fontSizeLabel.textContent = s.fontSize||80;
      elsCtl.speedRange.value = s.scrollSpeed||10; elsCtl.speedLabel.textContent = s.scrollSpeed||10;
      elsCtl.directionSelect.value = s.scrollDirection||'none';
      elsCtl.blinkCheckbox.checked = !!s.isBlinking;

      // æ–‡å­—æ¨¡å¼ Tab
      toggleTextMode(s.colorMode||'solid');
      // èƒŒæ™¯æ¨¡å¼ Tab
      toggleBgMode(s.bgMode||'solid');

      // æ–‡å­—é¢¨æ ¼
      document.querySelectorAll('[data-textstyle]').forEach(b=>{
        b.classList.toggle('active', b.dataset.textstyle === (s.textStyle||'normal'));
        b.classList.toggle('inactive', b.dataset.textstyle !== (s.textStyle||'normal'));
      });
      elsCtl.outlineColorSection.classList.toggle('hidden', (s.textStyle||'normal')!=='outline');

      // èƒŒæ™¯é‚Šæ¡†
      document.querySelectorAll('[data-border]').forEach(b=>{
        b.classList.toggle('active', b.dataset.border === (s.backgroundBorder||'none'));
        b.classList.toggle('inactive', b.dataset.border !== (s.backgroundBorder||'none'));
      });

      // é«˜äº®ç›®å‰é¸è‰²ï¼ˆç°¡åŒ–ï¼šä¸è¿½è¹¤ active æ¨£å¼ï¼Œé¿å…å†—é•· DOM æ¯”å°ï¼‰
    }

    // å¯«å…¥ï¼ˆå«ç¯€æµï¼‰
    let saveTimer = null;
    function save(patch){
      const ref = doc(db, "sessions", currentSessionId);
      const data = { ...patch, updatedAt: serverTimestamp() };
      // ç¯€æµ 80ms
      clearTimeout(saveTimer);
      saveTimer = setTimeout(()=> setDoc(ref, data, { merge: true }), 80);
    }

    // Controller å…¥å£
    window.startControllerMode = startControllerMode;
  </script>

  <script>
    // URL å…¥å£ï¼šdisplay / controller / home
    window.addEventListener('load', () => {
      const params = new URLSearchParams(window.location.search);
      if (params.has('controller')) return; // å·²ç”± module è…³æœ¬è™•ç†
      if (params.has('display')) return;    // å·²ç”± module è…³æœ¬è™•ç†
      // ä¿æŒé¦–é 
    });
  </script>
</body>
</html>
